<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.cake &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    

  </head>
  <body role="document">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &#187;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyrocko.cake</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;Classical seismic ray theory for layered earth models (*layer cake* models).</span>

<span class="sd">This module can be used to e.g. calculate arrival times, ray paths, reflection</span>
<span class="sd">and transmission coefficients, take-off and incidence angles and geometrical</span>
<span class="sd">spreading factors for arbitrary seismic phases. Computations are done for a</span>
<span class="sd">spherical earth, even though the module name may suggests something flat.</span>

<span class="sd">The main classes defined in this module are:</span>

<span class="sd">* :py:class:`Material` - Defines an isotropic elastic material.</span>
<span class="sd">* :py:class:`PhaseDef` - Defines a seismic phase arrival / wave propagation</span>
<span class="sd">    history.</span>
<span class="sd">* :py:class:`Leg` - Continuous propagation in a :py:class:`PhaseDef`.</span>
<span class="sd">* :py:class:`Knee` - Conversion/reflection in a :py:class:`PhaseDef`.</span>
<span class="sd">* :py:class:`LayeredModel` - Representation of a layer cake model.</span>
<span class="sd">* :py:class:`Layer` - A layer in a :py:class:`LayeredModel`.</span>

<span class="sd">   * :py:class:`HomogeneousLayer` - A homogeneous :py:class:`Layer`.</span>
<span class="sd">   * :py:class:`GradientLayer` - A gradient :py:class:`Layer`.</span>

<span class="sd">* :py:class:`Discontinuity` - A discontinuity in a :py:class:`LayeredModel`.</span>

<span class="sd">   * :py:class:`Interface` - A :py:class:`Discontinuity` between two</span>
<span class="sd">     :py:class:`Layer` instances.</span>
<span class="sd">   * :py:class:`Surface` - The surface :py:class:`Discontinuity` on top of</span>
<span class="sd">     a :py:class:`LayeredModel`.</span>

<span class="sd">* :py:class:`RayPath` - A fan of rays running through a common sequence of</span>
<span class="sd">  layers / interfaces.</span>
<span class="sd">* :py:class:`Ray` - A specific ray with a specific (ray parameter, distance,</span>
<span class="sd">  arrival time) choice.</span>
<span class="sd">* :py:class:`RayElement` - An element of a :py:class:`RayPath`.</span>

<span class="sd">   * :py:class:`Straight` - A ray segment representing propagation through</span>
<span class="sd">     one :py:class:`Layer`.</span>
<span class="sd">   * :py:class:`Kink` - An interaction of a ray with a</span>
<span class="sd">     :py:class:`Discontinuity`.</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">cmath</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">bisect</span><span class="p">,</span> <span class="n">brentq</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="n">ZEPS</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">P</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">S</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">DOWN</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">UP</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>

<span class="n">earthradius</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">()</span><span class="o">.</span><span class="n">earthradius</span>

<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">r2d</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">d2m</span> <span class="o">=</span> <span class="n">d2r</span><span class="o">*</span><span class="n">earthradius</span>
<span class="n">m2d</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">d2m</span>
<span class="n">sprad2spm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">r2d</span><span class="o">*</span><span class="n">d2m</span><span class="p">)</span>
<span class="n">sprad2spkm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">r2d</span><span class="o">*</span><span class="n">d2m</span><span class="o">/</span><span class="n">km</span><span class="p">)</span>
<span class="n">spm2sprad</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sprad2spm</span>
<span class="n">spkm2sprad</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">sprad2spkm</span>


<span class="k">class</span> <span class="nc">InvalidArguments</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Material"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material">[docs]</a><span class="k">class</span> <span class="nc">Material</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Isotropic elastic material.</span>

<span class="sd">    :param vp: P-wave velocity [m/s]</span>
<span class="sd">    :param vs: S-wave velocity [m/s]</span>
<span class="sd">    :param rho: density [kg/m^3]</span>
<span class="sd">    :param qp: P-wave attenuation Qp</span>
<span class="sd">    :param qs: S-wave attenuation Qs</span>
<span class="sd">    :param poisson: Poisson ratio</span>
<span class="sd">    :param lame: tuple with Lame parameter `lambda` and `shear modulus` [Pa]</span>
<span class="sd">    :param qk: bulk attenuation Qk</span>
<span class="sd">    :param qmu: shear attenuation Qmu</span>

<span class="sd">    If no velocities and no lame parameters are given, standard crustal values</span>
<span class="sd">    of vp = 5800 m/s and vs = 3200 m/s are used.  If no Q values are given,</span>
<span class="sd">    standard crustal values of qp = 1456 and qs = 600 are used.</span>

<span class="sd">    Everything is in SI units (m/s, Pa, kg/m^3) unless explicitly stated.</span>

<span class="sd">    The main material properties are considered independant and are accessible</span>
<span class="sd">    as attributes (it is allowed to assign to these):</span>

<span class="sd">        .. py:attribute:: vp, vs, rho, qp, qs</span>

<span class="sd">    Other material properties are considered dependant and can be queried by</span>
<span class="sd">    instance methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">vs</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">2600.</span><span class="p">,</span> <span class="n">qp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">poisson</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">lame</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">qk</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">qmu</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="n">parstore_float</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;vp&#39;</span><span class="p">,</span> <span class="s">&#39;vs&#39;</span><span class="p">,</span> <span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;qp&#39;</span><span class="p">,</span> <span class="s">&#39;qs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                    <span class="s">&#39;If vp and vs are given, poisson ratio and lame paramters &#39;</span>
                    <span class="s">&#39;should not be given.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">lame</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="mf">5800.</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                    <span class="s">&#39;Poisson ratio should not be given, when lame parameters &#39;</span>
                    <span class="s">&#39;are given.&#39;</span><span class="p">)</span>

            <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span><span class="o">/</span><span class="n">rho</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>

            <span class="k">if</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                    <span class="s">&#39;If vp is given, Lame parameters should not be given.&#39;</span><span class="p">)</span>

            <span class="n">poisson</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">poisson</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">vp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">vp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">poisson</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">lame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                    <span class="s">&#39;If vs is given, Lame parameters should not be given.&#39;</span><span class="p">)</span>

            <span class="n">poisson</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">poisson</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span> <span class="o">=</span> <span class="n">vs</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">poisson</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">poisson</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                <span class="s">&#39;Invalid combination of input parameters in material &#39;</span>
                <span class="s">&#39;definition.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">qs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">qk</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                    <span class="s">&#39;if qp or qs are given, qk and qmu should not be given.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">qp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">/</span> <span class="n">l</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mf">1456.</span>

            <span class="k">if</span> <span class="n">qs</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">*</span> <span class="n">l</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="mf">600.</span>

        <span class="k">elif</span> <span class="n">qp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qs</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qk</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mi">5782</span><span class="n">e4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="mf">600.</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="o">/</span><span class="n">l</span>

        <span class="k">elif</span> <span class="n">qp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qs</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">qmu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">qmu</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qk</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">qk</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="n">qmu</span><span class="o">/</span><span class="n">l</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">l</span><span class="o">/</span><span class="n">qmu</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">qk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="n">qmu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidArguments</span><span class="p">(</span>
                <span class="s">&#39;Invalid combination of input parameters in material &#39;</span>
                <span class="s">&#39;definition.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Material.astuple"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.astuple">[docs]</a>    <span class="k">def</span> <span class="nf">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get independant material properties as a tuple.</span>

<span class="sd">        Returns a tuple with ``(vp, vs, rho, qp, qs)``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>

<div class="viewcode-block" id="Material.lame"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.lame">[docs]</a>    <span class="k">def</span> <span class="nf">lame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Lame&#39;s parameter lambda and shear modulus.&#39;&#39;&#39;</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span>
        <span class="k">return</span> <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span></div>

<div class="viewcode-block" id="Material.lame_lambda"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.lame_lambda">[docs]</a>    <span class="k">def</span> <span class="nf">lame_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Lame&#39;s parameter lambda.</span>

<span class="sd">        Returned units are [Pa].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span></div>

<div class="viewcode-block" id="Material.shear_modulus"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.shear_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">shear_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get shear modulus.</span>

<span class="sd">        Returned units are [Pa].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span></div>

<div class="viewcode-block" id="Material.poisson"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.poisson">[docs]</a>    <span class="k">def</span> <span class="nf">poisson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Poisson&#39;s ratio.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">mu</span><span class="p">))</span></div>

<div class="viewcode-block" id="Material.bulk"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.bulk">[docs]</a>    <span class="k">def</span> <span class="nf">bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get bulk modulus.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="o">/</span><span class="mf">3.0</span></div>

<div class="viewcode-block" id="Material.youngs"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.youngs">[docs]</a>    <span class="k">def</span> <span class="nf">youngs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get Young&#39;s modulus.&#39;&#39;&#39;</span>
        <span class="n">lam</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">lam</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lam</span><span class="o">+</span><span class="n">mu</span><span class="p">)</span></div>

<div class="viewcode-block" id="Material.vp_vs_ratio"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.vp_vs_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">vp_vs_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get vp/vs ratio.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span></div>

<div class="viewcode-block" id="Material.qmu"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.qmu">[docs]</a>    <span class="k">def</span> <span class="nf">qmu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get shear attenuation coefficient Qmu.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span></div>

<div class="viewcode-block" id="Material.qk"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.qk">[docs]</a>    <span class="k">def</span> <span class="nf">qk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get bulk attenuation coefficient Qk.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">-</span> <span class="n">l</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">denom</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qp</span> <span class="o">-</span> <span class="n">l</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_rayleigh_equation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">cr_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">cr_a</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">cr_b</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">-</span><span class="n">cr_b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cr_a</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cr_b</span><span class="p">)</span>

<div class="viewcode-block" id="Material.rayleigh"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.rayleigh">[docs]</a>    <span class="k">def</span> <span class="nf">rayleigh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get rayleigh velocity assuming a homogenous halfspace.</span>

<span class="sd">        Returned units are [m/s].&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">bisect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rayleigh_equation</span><span class="p">,</span> <span class="mf">0.001</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Material.describe"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Material.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a readable listing of the material properties.&#39;&#39;&#39;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">P wave velocity     [km/s]    : %12g</span>
<span class="s">S wave velocity     [km/s]    : %12g</span>
<span class="s">P/S wave vel. ratio           : %12g</span>
<span class="s">Lame lambda         [GPa]     : %12g</span>
<span class="s">Lame shear modulus  [GPa]     : %12g</span>
<span class="s">Poisson ratio                 : %12g</span>
<span class="s">Bulk modulus        [GPa]     : %12g</span>
<span class="s">Young&#39;s modulus     [GPa]     : %12g</span>
<span class="s">Rayleigh wave vel.  [km/s]    : %12g</span>
<span class="s">Density             [g/cm**3] : %12g</span>
<span class="s">Qp                            : %12g</span>
<span class="s">Qs = Qmu                      : %12g</span>
<span class="s">Qk                            : %12g</span>
<span class="s">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lame_lambda</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shear_modulus</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poisson</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">youngs</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rayleigh</span><span class="p">()</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qk</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;%10g km/s  %10g km/s %10g g/cm^3 %10g %10g&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">vp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">rho</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Material(vp=%s, vs=%s, rho=%s, qp=%s, qs=%s)&#39;</span> <span class="o">%</span> \
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">))</span></div>


<div class="viewcode-block" id="Leg"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Leg">[docs]</a><span class="k">class</span> <span class="nc">Leg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Represents a continuous piece of wave propagation in a :py:class:`PhaseDef`.</span>

<span class="sd">     **Attributes:**</span>

<span class="sd">     To be considered as read-only.</span>

<span class="sd">        .. py:attribute:: departure</span>

<span class="sd">           One of the constants :py:const:`UP` or :py:const:`DOWN` indicating</span>
<span class="sd">           upward or downward departure.</span>

<span class="sd">        .. py:attribute:: mode</span>

<span class="sd">           One of the constants :py:const:`P` or :py:const:`S`, indicating the</span>
<span class="sd">           propagation mode.</span>

<span class="sd">        .. py:attribute:: depthmin</span>

<span class="sd">           ``None``, a number (a depth in [m]) or a string (an interface name),</span>
<span class="sd">           minimum depth.</span>

<span class="sd">        .. py:attribute:: depthmax</span>

<span class="sd">           ``None``, a number (a depth in [m]) or a string (an interface name),</span>
<span class="sd">           maximum depth.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">departure</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">departure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="k">None</span>

    <span class="k">def</span> <span class="nf">set_depthmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depthmin</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthmin</span>

    <span class="k">def</span> <span class="nf">set_depthmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depthmax</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthmax</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">sd</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&#39;%g km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">km</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;interface %s&#39;</span> <span class="o">%</span> <span class="n">d</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;%s mode propagation, departing %s&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{</span>
                <span class="n">UP</span><span class="p">:</span> <span class="s">&#39;upward&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;downward&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">departure</span><span class="p">])</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;deeper than %s&#39;</span> <span class="o">%</span> <span class="n">sd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depthmax</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;shallower than %s&#39;</span> <span class="o">%</span> <span class="n">sd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depthmin</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sc</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39; (may not propagate %s)&#39;</span> <span class="o">%</span> <span class="s">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span></div>


<span class="k">class</span> <span class="nc">InvalidKneeDef</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Knee"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Knee">[docs]</a><span class="k">class</span> <span class="nc">Knee</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Represents a change in wave propagation within a :py:class:`PhaseDef`.</span>

<span class="sd">    **Attributes:**</span>

<span class="sd">    To be considered as read-only.</span>

<span class="sd">        .. py:attribute:: depth</span>

<span class="sd">           Depth at which the conversion/reflection should happen. this can be</span>
<span class="sd">           a string or a number.</span>

<span class="sd">        .. py:attribute:: direction</span>

<span class="sd">           One of the constants :py:const:`UP` or :py:const:`DOWN` to indicate</span>
<span class="sd">           the incoming direction.</span>

<span class="sd">        .. py:attribute:: in_mode</span>

<span class="sd">           One of the constants :py:const:`P` or :py:const:`S` to indicate the</span>
<span class="sd">           type of mode of the incoming wave.</span>

<span class="sd">        .. py:attribute:: out_mode</span>

<span class="sd">           One of the constants :py:const:`P` or :py:const:`S` to indicate the</span>
<span class="sd">           type of mode of the outgoing wave.</span>

<span class="sd">        .. py:attribute:: conversion</span>

<span class="sd">           Boolean, whether there is a mode conversion involved.</span>

<span class="sd">        .. py:attribute:: reflection</span>

<span class="sd">           Boolean, whether there is a reflection involved.</span>

<span class="sd">        .. py:attribute:: headwave</span>

<span class="sd">           Boolean, whether there is headwave propagation involved.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">depth</span><span class="o">=</span><span class="s">&#39;surface&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="n">UP</span><span class="p">,</span>
        <span class="n">conversion</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
        <span class="n">reflection</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
        <span class="n">headwave</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
        <span class="n">in_setup_state</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="n">defaults_surface</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">depth</span><span class="o">=</span><span class="s">&#39;surface&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="n">UP</span><span class="p">,</span>
        <span class="n">conversion</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
        <span class="n">reflection</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
        <span class="n">headwave</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
        <span class="n">in_setup_state</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="o">=</span> <span class="k">False</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;depth&#39;</span><span class="p">,</span> <span class="s">&#39;surface&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="s">&#39;surface&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Knee</span><span class="o">.</span><span class="n">defaults_surface</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Knee</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span><span class="s">&#39;%s has already been set&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_leg</span><span class="p">,</span> <span class="n">out_leg</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">UP</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">):</span>

            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span>
                <span class="s">&#39;cannot enter %s from %s and emit ray upwards&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">[</span><span class="s">&#39;conversion&#39;</span><span class="p">,</span> <span class="s">&#39;reflection&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">],</span>
                    <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">DOWN</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">):</span>

            <span class="k">raise</span> <span class="n">InvalidKneeDef</span><span class="p">(</span>
                <span class="s">&#39;cannot enter %s from %s and emit ray downwards&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="p">[</span><span class="s">&#39;conversion&#39;</span><span class="p">,</span> <span class="s">&#39;reflection&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">],</span>
                    <span class="p">{</span><span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">=</span> <span class="n">in_leg</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span> <span class="o">=</span> <span class="n">out_leg</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">def</span> <span class="nf">at_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">==</span> <span class="s">&#39;surface&#39;</span>

<div class="viewcode-block" id="Knee.matches"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Knee.matches">[docs]</a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discontinuity</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check whether it is relevant to a given combination of interface,</span>
<span class="sd">        propagation mode, and direction.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="n">discontinuity</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZEPS</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">discontinuity</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">direction</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">==</span> <span class="n">mode</span></div>

<div class="viewcode-block" id="Knee.out_direction"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Knee.out_direction">[docs]</a>    <span class="k">def</span> <span class="nf">out_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get outgoing direction.</span>

<span class="sd">        Returns one of the constants :py:const:`UP` or :py:const:`DOWN`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;surface&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">headwave</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;underside&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;upperside&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headwave</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;headwave propagation along&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;reflection with conversion from %s to %s&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;reflection&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;conversion from %s to %s at&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">smode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;passing through&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;interface in %g km depth&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;%s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;on upgoing path&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;on downgoing path&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">Head</span><span class="p">(</span><span class="n">Knee</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">Knee</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="k">True</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Knee</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;propagation as headwave&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at interface in %g km depth&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;at %s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UnknownClassicPhase</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phasename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phasename</span> <span class="o">=</span> <span class="n">phasename</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Unknown classic phase name: %s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasename</span>


<div class="viewcode-block" id="PhaseDefParseError"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDefParseError">[docs]</a><span class="k">class</span> <span class="nc">PhaseDefParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised when an error occures during parsing of a phase</span>
<span class="sd">    definition string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Invalid phase definition: &quot;%s&quot; (at character %i: %s)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span></div>


<div class="viewcode-block" id="PhaseDef"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef">[docs]</a><span class="k">class</span> <span class="nc">PhaseDef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Definition of a seismic phase arrival, based on ray propagation path.</span>

<span class="sd">    :param definition: string representation of the phase in Cake&#39;s phase</span>
<span class="sd">        syntax</span>

<span class="sd">    Seismic phases are conventionally named e.g. P, Pn, PP, PcP, etc. In Cake,</span>
<span class="sd">    a slightly different terminology is adapted, which allows to specify</span>
<span class="sd">    arbitrary conversion/reflection histories for seismic ray paths. The</span>
<span class="sd">    conventions used here are inspired by those used in the TauP toolkit, but</span>
<span class="sd">    are not completely compatible with those.</span>

<span class="sd">    The definition of a seismic ray propagation path in Cake&#39;s phase syntax is</span>
<span class="sd">    a string consisting of an alternating sequence of *legs* and *knees*.</span>

<span class="sd">    A *leg* represents seismic wave propagation without any conversions,</span>
<span class="sd">    encountering only super-critical reflections. Legs are denoted by ``P``,</span>
<span class="sd">    ``p``,  ``S``, or ``s``. The capital letters are used when the take-off of</span>
<span class="sd">    the *leg* is in downward direction, while the lower case letters indicate a</span>
<span class="sd">    take-off in upward direction.</span>

<span class="sd">    A *knee* is an interaction with an interface. It can be a mode conversion,</span>
<span class="sd">    a reflection, or propagation as a headwave or diffracted wave.</span>

<span class="sd">       * conversion is simply denoted as: ``(INTERFACE)`` or ``DEPTH``</span>
<span class="sd">       * upperside reflection: ``v(INTERFACE)`` or ``vDEPTH``</span>
<span class="sd">       * underside reflection: ``^(INTERFACE)`` or ``^DEPTH``</span>
<span class="sd">       * normal kind headwave or diffracted wave: ``v_(INTERFACE)`` or</span>
<span class="sd">         ``v_DEPTH``</span>

<span class="sd">    The interface may be given by name or by depth: INTERFACE is the name of an</span>
<span class="sd">    interface defined in the model, DEPTH is the depth of an interface in</span>
<span class="sd">    [km] (the interface closest to that depth is chosen).  If two legs appear</span>
<span class="sd">    consecutively without an explicit *knee*, surface interaction is assumed.</span>

<span class="sd">    The phase definition may end with a backslash ``\\``, to indicate that the</span>
<span class="sd">    ray should arrive at the receiver from above instead of from below. It is</span>
<span class="sd">    possible to restrict the maximum and minimum depth of a *leg* by appending</span>
<span class="sd">    ``&lt;(INTERFACE)`` or ``&lt;DEPTH`` or ``&gt;(INTERFACE)`` or ``&gt;DEPTH`` after the</span>
<span class="sd">    leg character, respectively.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">        * ``P`` - like the classical P, but includes PKP, PKIKP, Pg</span>
<span class="sd">        * ``P&lt;(moho)`` - like classical Pg, but must leave source downwards</span>
<span class="sd">        * ``pP`` - leaves source upward, reflects at surface, then travels as P</span>
<span class="sd">        * ``P(moho)s`` - conversion from P to S at the Moho on upgoing path</span>
<span class="sd">        * ``P(moho)S`` - conversion from P to S at the Moho on downgoing path</span>
<span class="sd">        * ``Pv12p`` - P with reflection at 12 km deep interface (or the</span>
<span class="sd">          interface closest to that)</span>
<span class="sd">        * ``Pv_(moho)p`` - classical Pn</span>
<span class="sd">        * ``Pv_(cmb)p`` - classical Pdiff</span>
<span class="sd">        * ``P^(conrad)P`` - underside reflection of P at the Conrad</span>
<span class="sd">          discontinuity</span>

<span class="sd">    **Usage:**</span>

<span class="sd">        &gt;&gt;&gt; from pyrocko.cake import PhaseDef</span>
<span class="sd">        # must escape the backslash</span>
<span class="sd">        &gt;&gt;&gt; my_crazy_phase = PhaseDef(&#39;pPv(moho)sP\\\\&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print my_crazy_phase</span>
<span class="sd">        Phase definition &quot;pPv(moho)sP\&quot;:</span>
<span class="sd">         - P mode propagation, departing upward</span>
<span class="sd">         - surface reflection</span>
<span class="sd">         - P mode propagation, departing downward</span>
<span class="sd">         - upperside reflection with conversion from P to S at moho</span>
<span class="sd">         - S mode propagation, departing upward</span>
<span class="sd">         - surface reflection with conversion from S to P</span>
<span class="sd">         - P mode propagation, departing downward</span>
<span class="sd">         - arriving at target from above</span>

<span class="sd">    .. note::</span>

<span class="sd">        (1) These conventions might be extended in a way to allow to fix wave</span>
<span class="sd">            propagation to SH mode, possibly by specifying SH, or a single</span>
<span class="sd">            character (e.g. H) instead of S. This would be benificial for the</span>
<span class="sd">            selection of conversion and reflection coefficients, which</span>
<span class="sd">            currently only deal with the P-SV case.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">allowed_characters_pattern</span> <span class="o">=</span> <span class="s">r&#39;[0-9a-zA-Z_()&lt;&gt;^v</span><span class="se">\\</span><span class="s">.]+&#39;</span>
    <span class="n">allowed_characters_pattern_classic</span> <span class="o">=</span> <span class="s">r&#39;[a-zA-Z0-9]+&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">classic_definitions</span><span class="p">():</span>
        <span class="n">defs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># PmP, PmS, PcP, PcS, SmP, ...</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="s">&#39;mc&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="s">&#39;PP PS SS SP&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s">&#39;%sv(%s)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="s">&#39;cmb&#39;</span><span class="p">}[</span><span class="n">r</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>

        <span class="c"># Pg, P, S, Sg</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s&lt;(moho)&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s&lt;(cmb)(moho)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>

            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="s">&#39;PP PS SS SP&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;K&#39;</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s(cmb)P&lt;(icb)(cmb)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;KIK&#39;</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s(cmb)P(icb)P(icb)p(cmb)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;KJK&#39;</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s(cmb)P(icb)S(icb)p(cmb)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s">&#39;KiK&#39;</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;%s(cmb)Pv(icb)p(cmb)%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>

        <span class="c"># PP, SS, PS, SP, PPP, ...</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
                    <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="p">)]</span>

                <span class="n">defs</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)]</span>

        <span class="c"># Pc, Pdiff, Sc, ...</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;PS&#39;</span><span class="p">:</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;v_(cmb)&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;v_(moho)&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="c"># depth phases</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                    <span class="n">defs</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">defs</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PhaseDef.classic"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.classic">[docs]</a>    <span class="k">def</span> <span class="nf">classic</span><span class="p">(</span><span class="n">phasename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get phase definitions based on classic phase name.</span>

<span class="sd">        :param phasename: classic name of a phase</span>
<span class="sd">        :returns: list of PhaseDef objects</span>

<span class="sd">        This returns a list of PhaseDef objects, because some classic phases</span>
<span class="sd">        (like e.g. Pg) can only be represented by two Cake style PhaseDef</span>
<span class="sd">        objects (one with downgoing and one with upgoing first leg).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">defs</span> <span class="o">=</span> <span class="n">PhaseDef</span><span class="o">.</span><span class="n">classic_definitions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">phasename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownClassicPhase</span><span class="p">(</span><span class="n">phasename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">PhaseDef</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">classicname</span><span class="o">=</span><span class="n">phasename</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">defs</span><span class="p">[</span><span class="n">phasename</span><span class="p">]]</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">classicname</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sdepth</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">sinterface</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthmin</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">depthlim</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">depthlimtype</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">sdepthlim</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">UP</span>
        <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">knee</span> <span class="o">=</span> <span class="n">Knee</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;0123456789.&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">sdepth</span> <span class="o">+=</span> <span class="n">c</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepth</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">sinterface</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sinterface</span> <span class="o">+=</span> <span class="n">c</span>

                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;0123456789.&#39;</span><span class="p">:</span>
                                <span class="n">sdepthlim</span> <span class="o">+=</span> <span class="n">c</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">4</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">depthlim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepthlim</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                                <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                                <span class="n">depthlim</span> <span class="o">=</span> <span class="n">sdepthlim</span>
                                <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sdepthlim</span> <span class="o">+=</span> <span class="n">c</span>
                                <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;&lt;&gt;&#39;</span><span class="p">:</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="n">depthlim</span> <span class="o">=</span> <span class="k">None</span>
                            <span class="n">sdepthlim</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                            <span class="n">depthlimtype</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;psPS&#39;</span><span class="p">:</span>
                            <span class="n">leg</span> <span class="o">=</span> <span class="n">Leg</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                                <span class="n">leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">UP</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">leg</span><span class="o">.</span><span class="n">departure</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="n">leg</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">imode</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
                                <span class="n">in_leg</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                                    <span class="n">in_leg</span><span class="o">.</span><span class="n">set_depthmin</span><span class="p">(</span><span class="n">depthmin</span><span class="p">)</span>
                                    <span class="n">depthmin</span> <span class="o">=</span> <span class="k">None</span>
                                <span class="k">if</span> <span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                                    <span class="n">in_leg</span><span class="o">.</span><span class="n">set_depthmax</span><span class="p">(</span><span class="n">depthmax</span><span class="p">)</span>
                                    <span class="n">depthmax</span> <span class="o">=</span> <span class="k">None</span>

                                <span class="k">if</span> <span class="n">in_leg</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">leg</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                                    <span class="n">knee</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="k">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">knee</span><span class="o">.</span><span class="n">conversion</span> <span class="o">=</span> <span class="k">False</span>

                                <span class="k">if</span> <span class="ow">not</span> <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s">&#39;ps&#39;</span><span class="p">:</span>
                                        <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">UP</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DOWN</span>

                                <span class="n">knee</span><span class="o">.</span><span class="n">set_modes</span><span class="p">(</span><span class="n">in_leg</span><span class="p">,</span> <span class="n">leg</span><span class="p">)</span>
                                <span class="n">knee</span><span class="o">.</span><span class="n">in_setup_state</span> <span class="o">=</span> <span class="k">False</span>
                                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">knee</span><span class="p">)</span>
                                <span class="n">knee</span> <span class="o">=</span> <span class="n">Knee</span><span class="p">()</span>
                                <span class="n">sdepth</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                                <span class="n">sinterface</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

                            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">False</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;^&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">UP</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">reflection</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
                            <span class="n">need_leg</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="n">knee</span><span class="o">.</span><span class="n">headwave</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="k">continue</span>

                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                            <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">DOWN</span>
                            <span class="k">continue</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span>
                                <span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="s">&#39;invalid character: &quot;%s&quot;&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">depthlim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sdepthlim</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.</span>
                    <span class="k">if</span> <span class="n">depthlimtype</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
                        <span class="n">depthmax</span> <span class="o">=</span> <span class="n">depthlim</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">depthmin</span> <span class="o">=</span> <span class="n">depthlim</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">InvalidKneeDef</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">need_leg</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span>
                    <span class="n">definition</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="s">&#39;unfinished expression&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">events</span> <span class="ow">and</span> <span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_depthmin</span><span class="p">(</span><span class="n">depthmin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">events</span> <span class="ow">and</span> <span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_depthmax</span><span class="p">(</span><span class="n">depthmax</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classicname</span> <span class="o">=</span> <span class="n">classicname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_stop</span> <span class="o">=</span> <span class="n">direction_stop</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ev</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

<div class="viewcode-block" id="PhaseDef.first_leg"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.first_leg">[docs]</a>    <span class="k">def</span> <span class="nf">first_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the first leg in phase definition.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="PhaseDef.last_leg"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.last_leg">[docs]</a>    <span class="k">def</span> <span class="nf">last_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the last leg in phase definition.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="PhaseDef.legs"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.legs">[docs]</a>    <span class="k">def</span> <span class="nf">legs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterate over the continuous pieces of wave propagation (legs) defined</span>
<span class="sd">        within this phase definition.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">leg</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">leg</span><span class="p">,</span> <span class="n">Leg</span><span class="p">))</span></div>

<div class="viewcode-block" id="PhaseDef.knees"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.knees">[docs]</a>    <span class="k">def</span> <span class="nf">knees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterate over conversions and reflections (knees) defined within this</span>
<span class="sd">        phase definition.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">knee</span> <span class="k">for</span> <span class="n">knee</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">knee</span><span class="p">,</span> <span class="n">Knee</span><span class="p">))</span></div>

<div class="viewcode-block" id="PhaseDef.definition"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.definition">[docs]</a>    <span class="k">def</span> <span class="nf">definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get original definition of the phase.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span></div>

<div class="viewcode-block" id="PhaseDef.given_name"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.given_name">[docs]</a>    <span class="k">def</span> <span class="nf">given_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get entered classic name if any, or original definition of the phase.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classicname</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classicname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span></div>

    <span class="k">def</span> <span class="nf">direction_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_leg</span><span class="p">()</span><span class="o">.</span><span class="n">departure</span>

    <span class="k">def</span> <span class="nf">direction_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_stop</span>

    <span class="k">def</span> <span class="nf">headwave_knee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">Knee</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">headwave</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">el</span>
        <span class="k">return</span> <span class="k">None</span>

<div class="viewcode-block" id="PhaseDef.used_repr"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.used_repr">[docs]</a>    <span class="k">def</span> <span class="nf">used_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Translate into textual representation (cake phase syntax).&#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">strdepth</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&#39;%g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;(%s)&#39;</span> <span class="o">%</span> <span class="n">x</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">Leg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">departure</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smode</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="o">+</span><span class="n">strdepth</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depthmax</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">depthmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="o">+</span><span class="n">strdepth</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depthmin</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">Knee</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">reflection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">headwave</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">at_surface</span><span class="p">():</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strdepth</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">Head</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strdepth</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_stop</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;PhaseDef(&#39;%s&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;PhaseDef(&#39;%s&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_repr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_repr</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span> <span class="o">!=</span> <span class="n">used</span><span class="p">:</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="s">&#39; (entered as &quot;%s&quot;)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_definition</span>

        <span class="n">sarrive</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"> - arriving at target from %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;below&#39;</span><span class="p">,</span> <span class="s">&#39;above&#39;</span><span class="p">)[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_stop</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">]</span>

        <span class="k">return</span> <span class="s">&#39;Phase definition &quot;%s&quot;%s:</span><span class="se">\n</span><span class="s"> - &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">used</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s">&#39;</span><span class="se">\n</span><span class="s"> - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">sarrive</span>

<div class="viewcode-block" id="PhaseDef.copy"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.PhaseDef.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a deep copy of it.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">to_phase_defs</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">PhaseDef</span><span class="p">)):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">phases</span><span class="p">]</span>

    <span class="n">phases_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">phases_out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">PhaseDef</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">PhaseDef</span><span class="p">):</span>
            <span class="n">phases_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PhaseDefParseError</span><span class="p">(</span><span class="s">&#39;invalid phase definition&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">phases_out</span>


<span class="k">def</span> <span class="nf">csswap</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cmath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


<div class="viewcode-block" id="psv_surface_ind"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.psv_surface_ind">[docs]</a><span class="k">def</span> <span class="nf">psv_surface_ind</span><span class="p">(</span><span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get indices to select the appropriate element from scatter matrix for free</span>
<span class="sd">    surface.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">in_mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">out_mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">))</span></div>


<div class="viewcode-block" id="psv_surface"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.psv_surface">[docs]</a><span class="k">def</span> <span class="nf">psv_surface</span><span class="p">(</span><span class="n">material</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Scatter matrix for free surface reflection/conversions.</span>

<span class="sd">    :param material: material, object of type :py:class:`Material`</span>
<span class="sd">    :param p: flat ray parameter [s/m]</span>
<span class="sd">    :param energy: bool, when ``True`` energy normalized coefficients are</span>
<span class="sd">        returned</span>
<span class="sd">    :returns: Scatter matrix</span>

<span class="sd">    The scatter matrix is ordered as follows::</span>

<span class="sd">        [[PP, PS],</span>
<span class="sd">         [SP, SS]]</span>

<span class="sd">    The formulas given in Aki &amp; Richards are used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material</span><span class="o">.</span><span class="n">rho</span>
    <span class="n">sinphi</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp</span>
    <span class="n">sinlam</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs</span>
    <span class="n">cosphi</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinphi</span><span class="p">)</span>
    <span class="n">coslam</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinlam</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vs</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">vsp_term</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">vs</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pcc_term</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cosphi</span><span class="o">/</span><span class="n">vp</span> <span class="o">*</span> <span class="n">coslam</span><span class="o">/</span><span class="n">vs</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pcc_term</span>

        <span class="n">scatter</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="o">-</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pcc_term</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam</span><span class="o">/</span><span class="n">vp</span><span class="o">*</span><span class="n">vsp_term</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">4.0</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi</span><span class="o">/</span><span class="n">vs</span><span class="o">*</span><span class="n">vsp_term</span><span class="p">,</span> <span class="n">vsp_term</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pcc_term</span><span class="p">]],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">energy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scatter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
        <span class="n">normvec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vp</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">cosphi</span><span class="o">+</span><span class="n">eps</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">coslam</span><span class="o">+</span><span class="n">eps</span><span class="p">])</span>
        <span class="n">escatter</span> <span class="o">=</span> <span class="n">scatter</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="p">(</span><span class="n">normvec</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">normvec</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">escatter</span><span class="p">)</span></div>


<div class="viewcode-block" id="psv_solid_ind"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.psv_solid_ind">[docs]</a><span class="k">def</span> <span class="nf">psv_solid_ind</span><span class="p">(</span><span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get indices to select the appropriate element from scatter matrix for</span>
<span class="sd">    solid-solid interface.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">out_direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">out_mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">),</span>
        <span class="p">(</span><span class="n">in_direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">in_mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">))</span></div>


<div class="viewcode-block" id="psv_solid"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.psv_solid">[docs]</a><span class="k">def</span> <span class="nf">psv_solid</span><span class="p">(</span><span class="n">material1</span><span class="p">,</span> <span class="n">material2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Scatter matrix for solid-solid interface.</span>

<span class="sd">    :param material1: material above, object of type :py:class:`Material`</span>
<span class="sd">    :param material2: material below, object of type :py:class:`Material`</span>
<span class="sd">    :param p: flat ray parameter [s/m]</span>
<span class="sd">    :param energy: bool, when ``True`` energy normalized coefficients are</span>
<span class="sd">        returned</span>
<span class="sd">    :returns: Scatter matrix</span>

<span class="sd">    The scatter matrix is ordered as follows::</span>

<span class="sd">       [[P1P1, S1P1, P2P1, S2P1],</span>
<span class="sd">        [P1S1, S1S1, P2S1, S2S1],</span>
<span class="sd">        [P1P2, S1P2, P2P2, S2P2],</span>
<span class="sd">        [P1S2, S1S2, P2S2, S2S2]]</span>

<span class="sd">    The formulas given in Aki &amp; Richards are used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">vp1</span><span class="p">,</span> <span class="n">vs1</span><span class="p">,</span> <span class="n">rho1</span> <span class="o">=</span> <span class="n">material1</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material1</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material1</span><span class="o">.</span><span class="n">rho</span>
    <span class="n">vp2</span><span class="p">,</span> <span class="n">vs2</span><span class="p">,</span> <span class="n">rho2</span> <span class="o">=</span> <span class="n">material2</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">material2</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">material2</span><span class="o">.</span><span class="n">rho</span>

    <span class="n">sinphi1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp1</span>
    <span class="n">cosphi1</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinphi1</span><span class="p">)</span>
    <span class="n">sinlam1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs1</span>
    <span class="n">coslam1</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinlam1</span><span class="p">)</span>
    <span class="n">sinphi2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vp2</span>
    <span class="n">cosphi2</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinphi2</span><span class="p">)</span>
    <span class="n">sinlam2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">vs2</span>
    <span class="n">coslam2</span> <span class="o">=</span> <span class="n">csswap</span><span class="p">(</span><span class="n">sinlam2</span><span class="p">)</span>

    <span class="c"># from aki and richards</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="o">-</span><span class="n">vp1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">-</span><span class="n">coslam1</span><span class="p">,</span> <span class="n">vp2</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">coslam2</span><span class="p">],</span>
        <span class="p">[</span><span class="n">cosphi1</span><span class="p">,</span> <span class="o">-</span><span class="n">vs1</span><span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">cosphi2</span><span class="p">,</span> <span class="o">-</span><span class="n">vs2</span><span class="o">*</span><span class="n">p</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">2.0</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi1</span><span class="p">,</span> <span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
         <span class="mf">2.0</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">cosphi2</span><span class="p">,</span> <span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)],</span>
        <span class="p">[</span><span class="o">-</span><span class="n">rho1</span><span class="o">*</span><span class="n">vp1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="n">vs1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam1</span><span class="p">,</span>
         <span class="n">rho2</span><span class="o">*</span><span class="n">vp2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="n">vs2</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">coslam2</span><span class="p">]],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">scatter</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">energy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scatter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
        <span class="k">if</span> <span class="n">vs1</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">vs1</span> <span class="o">=</span> <span class="n">vp1</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
        <span class="k">if</span> <span class="n">vs2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">vs2</span> <span class="o">=</span> <span class="n">vp2</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
        <span class="n">normvec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">vp1</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="p">(</span><span class="n">cosphi1</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span> <span class="n">vs1</span><span class="o">*</span><span class="n">rho1</span><span class="o">*</span><span class="p">(</span><span class="n">coslam1</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span>
            <span class="n">vp2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="p">(</span><span class="n">cosphi2</span><span class="o">+</span><span class="n">eps</span><span class="p">),</span> <span class="n">vs2</span><span class="o">*</span><span class="n">rho2</span><span class="o">*</span><span class="p">(</span><span class="n">coslam2</span><span class="o">+</span><span class="n">eps</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">escatter</span> <span class="o">=</span> <span class="n">scatter</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="n">normvec</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="n">normvec</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">escatter</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">BadPotIntCoefs</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">potint_coefs</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">):</span>  <span class="c"># r2 &gt; r1</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">9</span>
    <span class="k">if</span> <span class="n">c1</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c2</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">c1c2</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c1c2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="n">c2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">c1c2</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">/</span><span class="n">r2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadPotIntCoefs</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="p">(</span><span class="n">r1</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span><span class="o">**</span><span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">imode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">P</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">S</span>


<span class="k">def</span> <span class="nf">smode</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;p&#39;</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;s&#39;</span>


<span class="k">class</span> <span class="nc">PathFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SurfaceReached</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">BottomReached</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MaxDepthReached</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MinDepthReached</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Trapped</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">NotPhaseConform</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CannotPropagate</span><span class="p">(</span><span class="n">PathFailed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">ilayer</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ilayer</span> <span class="o">=</span> <span class="n">ilayer</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Cannot enter layer %i from %s&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ilayer</span><span class="p">,</span> <span class="p">{</span>
                <span class="n">UP</span><span class="p">:</span> <span class="s">&#39;below&#39;</span><span class="p">,</span>
                <span class="n">DOWN</span><span class="p">:</span> <span class="s">&#39;above&#39;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">])</span>


<div class="viewcode-block" id="Layer"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer">[docs]</a><span class="k">class</span> <span class="nc">Layer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of a layer in a layered earth model.</span>

<span class="sd">    :param ztop: depth of top of layer</span>
<span class="sd">    :param zbot: depth of bottom of layer</span>
<span class="sd">    :param name: name of layer (optional)</span>

<span class="sd">    Subclasses are: :py:class:`HomogeneousLayer` and :py:class:`GradientLayer`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">ztop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">zbot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="k">None</span>

    <span class="k">def</span> <span class="nf">_update_potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">potint_p</span> <span class="o">=</span> <span class="n">potint_s</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ppic</span> <span class="o">=</span> <span class="n">potint_coefs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span>
                <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">),</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">))</span>
            <span class="n">potint_p</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">except</span> <span class="n">BadPotIntCoefs</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">potint_s</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spic</span> <span class="o">=</span> <span class="n">potint_coefs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span>
                <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">),</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">))</span>
            <span class="n">potint_s</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">except</span> <span class="n">BadPotIntCoefs</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">assert</span> <span class="n">P</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">S</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span> <span class="o">=</span> <span class="p">(</span><span class="k">None</span><span class="p">,</span> <span class="n">potint_p</span><span class="p">,</span> <span class="n">potint_s</span><span class="p">)</span>

<div class="viewcode-block" id="Layer.potint_coefs"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.potint_coefs">[docs]</a>    <span class="k">def</span> <span class="nf">potint_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get coefficients for potential interpolation.</span>

<span class="sd">        :param mode: mode of wave propagation, :py:const:`P` or :py:const:`S`</span>
<span class="sd">        :returns: coefficients ``(a, b)``</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spic</span></div>

<div class="viewcode-block" id="Layer.contains"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.contains">[docs]</a>    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tolerantly check if a given depth is within the layer</span>
<span class="sd">        (including boundaries).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">or</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">at_bottom</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_top</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layer.inner"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.inner">[docs]</a>    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tolerantly check if a given depth is within the layer</span>
<span class="sd">        (not including boundaries).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">and</span> <span class="ow">not</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">at_bottom</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">at_top</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layer.at_bottom"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.at_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">at_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Tolerantly check if given depth is at the bottom of the layer.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span></div>

<div class="viewcode-block" id="Layer.at_top"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.at_top">[docs]</a>    <span class="k">def</span> <span class="nf">at_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Tolerantly check if given depth is at the top of the layer.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span></div>

<div class="viewcode-block" id="Layer.pflat_top"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.pflat_top">[docs]</a>    <span class="k">def</span> <span class="nf">pflat_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert spherical ray parameter to local flat ray parameter for top of</span>
<span class="sd">        layer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layer.pflat_bottom"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.pflat_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">pflat_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert spherical ray parameter to local flat ray parameter for bottom</span>
<span class="sd">        of layer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Layer.pflat"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.pflat">[docs]</a>    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert spherical ray parameter to local flat ray parameter for</span>
<span class="sd">        given depth.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">z</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">v_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="n">b</span>

    <span class="k">def</span> <span class="nf">u_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>

<div class="viewcode-block" id="Layer.xt_potint"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.xt_potint">[docs]</a>    <span class="k">def</span> <span class="nf">xt_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get travel time and distance for for traversal with given mode and ray</span>
<span class="sd">        parameter.</span>

<span class="sd">        :param p: ray parameter (spherical)</span>
<span class="sd">        :param mode: mode of propagation (:py:const:`P` or :py:const:`S`)</span>
<span class="sd">        :param zpart: if given, tuple with two depths to restrict computation</span>
<span class="sd">            to a part of the layer</span>

<span class="sd">        This implementation uses analytic formulas valid for a spherical earth</span>
<span class="sd">        in the case where the velocity c within the layer is given by potential</span>
<span class="sd">        interpolation of the form</span>

<span class="sd">            c(z) = a*z^b</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">utop</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ztop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>
        <span class="n">zbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span> <span class="o">=</span> <span class="n">zpart</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">ztop</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">zbot</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">)</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">zbot</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">eta1</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">ubot</span>
        <span class="n">eta2</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">*</span> <span class="n">utop</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">cpe</span><span class="p">(</span><span class="n">eta</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">p</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">sep</span><span class="p">(</span><span class="n">eta</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpe</span><span class="p">(</span><span class="n">eta2</span><span class="p">)</span><span class="o">-</span><span class="n">cpe</span><span class="p">(</span><span class="n">eta1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">sep</span><span class="p">(</span><span class="n">eta2</span><span class="p">)</span><span class="o">-</span><span class="n">sep</span><span class="p">(</span><span class="n">eta1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r2</span><span class="o">/</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">sap</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">p</span><span class="o">/</span><span class="n">sap</span> <span class="o">*</span> <span class="n">lr</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sap</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">*=</span> <span class="n">r2d</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span></div>

<div class="viewcode-block" id="Layer.test"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if wave mode can exist for given ray parameter at given depth</span>
<span class="sd">        within the layer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span></div>

    <span class="k">def</span> <span class="nf">tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">utop</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">utop</span> <span class="o">*</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span>
            <span class="p">(</span><span class="n">ubot</span> <span class="o">*</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>

<div class="viewcode-block" id="Layer.zturn_potint"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.zturn_potint">[docs]</a>    <span class="k">def</span> <span class="nf">zturn_potint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get turning depth for given ray parameter and propagation mode.&#39;&#39;&#39;</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">potint_coefs</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">earthradius</span><span class="o">-</span><span class="n">r</span></div>

<div class="viewcode-block" id="Layer.propagate"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.propagate">[docs]</a>    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Propagate ray through layer.</span>

<span class="sd">        :param p: ray parameter</span>
<span class="sd">        :param mode: propagation mode</span>
<span class="sd">        :param direction: in direction (:py:const:`UP` or :py:const:`DOWN`&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zin</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zin</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CannotPropagate</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zout</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">direction</span></div>

<div class="viewcode-block" id="Layer.resize"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Layer.resize">[docs]</a>    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth_min</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">depth_max</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Change layer thinkness and interpolate :py:class:`Material` if</span>
<span class="sd">        required.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">depth_min</span><span class="p">:</span>
            <span class="n">mtop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">depth_min</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">depth_max</span><span class="p">:</span>
            <span class="n">mbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">depth_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span> <span class="o">=</span> <span class="n">mtop</span> <span class="k">if</span> <span class="n">depth_min</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span> <span class="o">=</span> <span class="n">mbot</span> <span class="k">if</span> <span class="n">depth_max</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">depth_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">depth_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmid</span> <span class="o">=</span> <span class="n">depth_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">depth_max</span> <span class="o">-</span> <span class="n">depth_min</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span></div></div>


<span class="k">class</span> <span class="nc">DoesNotTurn</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="n">z</span>


<div class="viewcode-block" id="HomogeneousLayer"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.HomogeneousLayer">[docs]</a><span class="k">class</span> <span class="nc">HomogeneousLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of a homogeneous layer in a layered earth model.</span>

<span class="sd">    Base class: :py:class:`Layer`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">Layer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_potint_coefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">zbot</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ztop</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ztop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

        <span class="k">if</span> <span class="n">zbot</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">zbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>

        <span class="k">return</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_potint</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">u_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">u</span>

    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_potint</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">vs</span>

        <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filled</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">v_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="mf">0.001</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pflat</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">r2d</span><span class="o">*</span><span class="n">pflat</span><span class="o">/</span><span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zturn_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DoesNotTurn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">upper</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;HP&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]]</span>
                           <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;  (%i) homogeneous layer %s(%g km - %g km) [%s]</span><span class="se">\n</span><span class="s">    %s&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">/</span><span class="n">km</span><span class="p">,</span> <span class="n">calcmode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span></div>


<div class="viewcode-block" id="GradientLayer"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.GradientLayer">[docs]</a><span class="k">class</span> <span class="nc">GradientLayer</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of a gradient layer in a layered earth model.</span>

<span class="sd">    Base class: :py:class:`Layer`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">mtop</span><span class="p">,</span> <span class="n">mbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">Layer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span> <span class="o">=</span> <span class="n">mtop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span> <span class="o">=</span> <span class="n">mbot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_potint_coefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ztop</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">zbot</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ztop</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">ztop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

        <span class="k">if</span> <span class="n">zbot</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">zbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span>

        <span class="k">return</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ptop</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">pbot</span> <span class="o">-</span> <span class="n">ptop</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">dtop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="n">dbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">astuple</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ptop</span><span class="p">,</span> <span class="n">pbot</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dtop</span><span class="p">,</span> <span class="n">dbot</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">Material</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">u_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_potint</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">v_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span>

    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_potint</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">)</span>

        <span class="n">utop</span><span class="p">,</span> <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">ubot</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">/</span><span class="n">utop</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>

        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">utop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ubot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">peps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
        <span class="n">pdp</span> <span class="o">=</span> <span class="n">pflat</span> <span class="o">+</span> <span class="n">peps</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pflat</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">eta</span><span class="o">/</span><span class="n">u</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pflat</span> <span class="o">&lt;=</span> <span class="n">u</span><span class="p">,</span>
                <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pdp</span><span class="p">)</span> <span class="o">-</span> <span class="n">eta</span><span class="o">/</span><span class="n">u</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">tt</span>

        <span class="n">xxtop</span><span class="p">,</span> <span class="n">tttop</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">utop</span><span class="p">)</span>
        <span class="n">xxbot</span><span class="p">,</span> <span class="n">ttbot</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">ubot</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">xxtop</span> <span class="o">-</span> <span class="n">xxbot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">pdp</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">tttop</span> <span class="o">-</span> <span class="n">ttbot</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span> <span class="o">+</span> <span class="n">pflat</span><span class="o">*</span><span class="n">x</span>

        <span class="n">x</span> <span class="o">*=</span> <span class="n">r2d</span><span class="o">/</span><span class="p">(</span><span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zturn_potint</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">pflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat_bottom</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">vtop</span><span class="p">,</span> <span class="n">vbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">pflat</span> <span class="o">-</span> <span class="n">vtop</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span> <span class="o">/</span> \
            <span class="p">(</span><span class="n">vbot</span><span class="o">-</span><span class="n">vtop</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">mmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">mmid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">upper</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">calcmode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;HP&#39;</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_potential_interpolation</span><span class="p">[</span><span class="n">mode</span><span class="p">]]</span>
                           <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;&#39;&#39;  (%i) gradient layer %s(%g km - %g km) [%s]</span>
<span class="s">    %s</span>
<span class="s">    %s&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ilayer</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span><span class="o">/</span><span class="n">km</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span><span class="o">/</span><span class="n">km</span><span class="p">,</span>
            <span class="n">calcmode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mtop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mbot</span><span class="p">)</span></div>


<div class="viewcode-block" id="Discontinuity"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Discontinuity">[docs]</a><span class="k">class</span> <span class="nc">Discontinuity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Base class for discontinuities in layered earth model.</span>

<span class="sd">    Subclasses are: :py:class:`Interface` and :py:class:`Surface`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Interface"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Interface">[docs]</a><span class="k">class</span> <span class="nc">Interface</span><span class="p">(</span><span class="n">Discontinuity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of an interface in a layered earth model.</span>

<span class="sd">    Base class: :py:class:`Discontinuity`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mabove</span><span class="p">,</span> <span class="n">mbelow</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">Discontinuity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mabove</span> <span class="o">=</span> <span class="n">mabove</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span> <span class="o">=</span> <span class="n">mbelow</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;interface&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;interface &quot;%s&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">u_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="o">.</span><span class="n">vp</span><span class="p">),</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="o">.</span><span class="n">vs</span><span class="p">),</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">critical_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">uabove</span><span class="p">,</span> <span class="n">ubelow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">mult_or_none</span><span class="p">(</span><span class="n">uabove</span><span class="p">,</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span>
            <span class="n">mult_or_none</span><span class="p">(</span><span class="n">ubelow</span><span class="p">,</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">uabove</span><span class="p">,</span> <span class="n">ubelow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ubelow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">ubelow</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">direction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uabove</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">uabove</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">direction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">direction</span>

    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">psv_solid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mabove</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">energy</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scatter</span><span class="p">[</span>
            <span class="n">psv_solid_ind</span><span class="p">(</span><span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">)]</span></div>


<div class="viewcode-block" id="Surface"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Surface">[docs]</a><span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="n">Discontinuity</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of the surface discontinuity in a layered earth model.</span>

<span class="sd">    Base class: :py:class:`Discontinuity`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mbelow</span><span class="p">):</span>
        <span class="n">Discontinuity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="s">&#39;surface&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span> <span class="o">=</span> <span class="n">mbelow</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">direction</span>  <span class="c"># no implicit reflection at surface</span>

    <span class="k">def</span> <span class="nf">u_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">None</span><span class="p">,</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">None</span><span class="p">,</span> <span class="n">reci_or_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">critical_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ubelow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">None</span><span class="p">,</span> <span class="n">mult_or_none</span><span class="p">(</span><span class="n">ubelow</span><span class="p">,</span> <span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">in_direction</span> <span class="o">==</span> <span class="n">DOWN</span> <span class="ow">or</span> <span class="n">out_direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">psv_surface</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mbelow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">energy</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span>
                    <span class="n">psv_surface_ind</span><span class="p">(</span><span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;surface&#39;</span></div>


<span class="k">class</span> <span class="nc">Walker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BottomReached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SurfaceReached</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">goto_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>


<div class="viewcode-block" id="RayElement"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayElement">[docs]</a><span class="k">class</span> <span class="nc">RayElement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An element of a :py:class:`RayPath`.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="k">def</span> <span class="nf">is_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Straight</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_kink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Kink</span><span class="p">)</span></div>


<div class="viewcode-block" id="Straight"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Straight">[docs]</a><span class="k">class</span> <span class="nc">Straight</span><span class="p">(</span><span class="n">RayElement</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A ray segment representing wave propagation through one :py:class:`Layer`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">,</span> <span class="n">direction_out</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span> <span class="o">=</span> <span class="n">direction_in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span> <span class="o">=</span> <span class="n">direction_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>

    <span class="k">def</span> <span class="nf">angle_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eff_direction_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">pf</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">180.</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">pf</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>

    <span class="k">def</span> <span class="nf">angle_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eff_direction_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">pflat</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">90.</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">pf</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">pf</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>

    <span class="k">def</span> <span class="nf">pflat_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pflat_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">z_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endgaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">endgaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">zbot</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span> <span class="o">==</span> <span class="n">UP</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">z_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endgaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">endgaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">zbot</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">turns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span>

    <span class="k">def</span> <span class="nf">eff_direction_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endgaps</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">endgaps</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">eff_direction_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endgaps</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">endgaps</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">u_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">u_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">critical_p_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">critical_p_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="n">zpart</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span> <span class="ow">and</span> <span class="n">zpart</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">*=</span> <span class="mf">2.</span>
            <span class="n">t</span> <span class="o">*=</span> <span class="mf">2.</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">xt_gap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">,</span> <span class="n">samedir</span><span class="p">):</span>
        <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span>
        <span class="k">if</span> <span class="n">z1</span> <span class="o">&gt;</span> <span class="n">z2</span><span class="p">:</span>
            <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z1</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">samedir</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xfull</span><span class="p">,</span> <span class="n">tfull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xfull</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">tfull</span><span class="o">-</span><span class="n">t</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_in</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_out</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">)))</span></div>


<span class="k">class</span> <span class="nc">HeadwaveStraight</span><span class="p">(</span><span class="n">Straight</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">,</span> <span class="n">direction_out</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="n">Straight</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">,</span> <span class="n">direction_out</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>

    <span class="k">def</span> <span class="nf">z_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">z</span>

    <span class="k">def</span> <span class="nf">z_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">z</span>

    <span class="k">def</span> <span class="nf">zturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>

    <span class="k">def</span> <span class="nf">x2t_headwave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xstretch</span><span class="p">):</span>
        <span class="n">xstretch_m</span> <span class="o">=</span> <span class="n">xstretch</span><span class="o">*</span><span class="n">d2r</span><span class="o">*</span><span class="n">radius</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">min_not_none</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">u_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span><span class="o">*</span><span class="n">xstretch_m</span>


<div class="viewcode-block" id="Kink"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Kink">[docs]</a><span class="k">class</span> <span class="nc">Kink</span><span class="p">(</span><span class="n">RayElement</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;An interaction of a ray with a :py:class:`Discontinuity`.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">in_direction</span><span class="p">,</span>
            <span class="n">out_direction</span><span class="p">,</span>
            <span class="n">in_mode</span><span class="p">,</span>
            <span class="n">out_mode</span><span class="p">,</span>
            <span class="n">discontinuity</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span> <span class="o">=</span> <span class="n">in_direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span> <span class="o">=</span> <span class="n">out_direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">=</span> <span class="n">in_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span> <span class="o">=</span> <span class="n">out_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span> <span class="o">=</span> <span class="n">discontinuity</span>

    <span class="k">def</span> <span class="nf">reflection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span>

    <span class="k">def</span> <span class="nf">conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span>

    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">out_direction</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">out_mode</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">out_direction</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">out_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span>

        <span class="k">if</span> <span class="n">out_mode</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">out_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span> <span class="n">out_direction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span> <span class="n">out_mode</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflection</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;|~&#39;</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;|&#39;</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;~&#39;</span>
        <span class="k">return</span> <span class="s">&#39;_&#39;</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_mode</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">)))</span></div>


<span class="k">class</span> <span class="nc">PRangeNotSet</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="RayPath"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath">[docs]</a><span class="k">class</span> <span class="nc">RayPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Representation of a fan of rays running through a common sequence of</span>
<span class="sd">    layers / interfaces.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span> <span class="o">=</span> <span class="k">False</span>

    <span class="k">def</span> <span class="nf">set_is_headwave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_headwave</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span> <span class="o">=</span> <span class="n">is_headwave</span>

<div class="viewcode-block" id="RayPath.copy"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a copy of it.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="RayPath.endgaps"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.endgaps">[docs]</a>    <span class="k">def</span> <span class="nf">endgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get information needed for end point adjustments.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">zstart</span><span class="p">,</span>
            <span class="n">zstop</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">direction_start</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">direction_stop</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_have_prange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PRangeNotSet</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_prange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">dp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">=</span> <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span> <span class="o">=</span> <span class="n">dp</span>

<div class="viewcode-block" id="RayPath.used_phase"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.used_phase">[docs]</a>    <span class="k">def</span> <span class="nf">used_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate phase definition from ray path.&#39;&#39;&#39;</span>

        <span class="n">used</span> <span class="o">=</span> <span class="n">PhaseDef</span><span class="p">()</span>
        <span class="n">fleg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">first_leg</span><span class="p">()</span>
        <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="n">fleg</span><span class="o">.</span><span class="n">departure</span><span class="p">,</span> <span class="n">fleg</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
        <span class="n">n_elements_n</span> <span class="o">=</span> <span class="p">[</span><span class="k">None</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">+</span> <span class="p">[</span><span class="k">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">before</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">after</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">n_elements_n</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">n_elements_n</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">n_elements_n</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">is_kink</span><span class="p">()</span> <span class="ow">and</span> <span class="n">HeadwaveStraight</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">before</span><span class="p">),</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">after</span><span class="p">)):</span>

                <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">reflection</span><span class="p">()</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">conversion</span><span class="p">():</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">discontinuity</span><span class="o">.</span><span class="n">z</span>
                    <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Knee</span><span class="p">(</span>
                        <span class="n">z</span><span class="p">,</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">out_direction</span> <span class="o">!=</span> <span class="n">element</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">out_mode</span><span class="p">))</span>

                    <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">out_mode</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="ow">is</span> <span class="n">HeadwaveStraight</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">z</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">Knee</span><span class="p">(</span>
                    <span class="n">z</span><span class="p">,</span>
                    <span class="n">before</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span>
                    <span class="n">after</span><span class="o">.</span><span class="n">out_direction</span> <span class="o">!=</span> <span class="n">before</span><span class="o">.</span><span class="n">in_direction</span><span class="p">,</span>
                    <span class="n">before</span><span class="o">.</span><span class="n">in_mode</span><span class="p">,</span>
                    <span class="n">after</span><span class="o">.</span><span class="n">out_mode</span><span class="p">)</span>

                <span class="n">k</span><span class="o">.</span><span class="n">headwave</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">out_mode</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">before</span> <span class="ow">and</span> <span class="n">after</span>
                    <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">is_straight</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">before</span><span class="o">.</span><span class="n">is_kink</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">after</span><span class="o">.</span><span class="n">is_kink</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">turns</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">before</span><span class="o">.</span><span class="n">reflection</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">before</span><span class="o">.</span><span class="n">conversion</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">after</span><span class="o">.</span><span class="n">reflection</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">after</span><span class="o">.</span><span class="n">conversion</span><span class="p">()):</span>

                <span class="n">ai</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">angle_in</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="mf">90.0</span><span class="o">-</span><span class="n">eps</span> <span class="o">&lt;</span> <span class="n">ai</span> <span class="ow">and</span> <span class="n">ai</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="o">+</span><span class="n">eps</span><span class="p">:</span>
                    <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Head</span><span class="p">(</span>
                            <span class="n">before</span><span class="o">.</span><span class="n">discontinuity</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                            <span class="n">before</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
                    <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Leg</span><span class="p">(</span><span class="o">-</span><span class="n">before</span><span class="o">.</span><span class="n">out_direction</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>

        <span class="n">used</span><span class="o">.</span><span class="n">_direction_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">direction_stop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">used</span></div>

<div class="viewcode-block" id="RayPath.pmax"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.pmax">[docs]</a>    <span class="k">def</span> <span class="nf">pmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get maximum valid ray parameter.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span></div>

<div class="viewcode-block" id="RayPath.pmin"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.pmin">[docs]</a>    <span class="k">def</span> <span class="nf">pmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get minimum valid ray parameter.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span></div>

<div class="viewcode-block" id="RayPath.xmin"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xmin">[docs]</a>    <span class="k">def</span> <span class="nf">xmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get minimal distance.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span></div>

<div class="viewcode-block" id="RayPath.xmax"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xmax">[docs]</a>    <span class="k">def</span> <span class="nf">xmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get maximal distance.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span></div>

<div class="viewcode-block" id="RayPath.kinks"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.kinks">[docs]</a>    <span class="k">def</span> <span class="nf">kinks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterate over propagation mode changes (reflections/transmissions).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Kink</span><span class="p">))</span></div>

<div class="viewcode-block" id="RayPath.straights"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.straights">[docs]</a>    <span class="k">def</span> <span class="nf">straights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Iterate over ray segments.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">headwave_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">HeadwaveStraight</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="RayPath.first_straight"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.first_straight">[docs]</a>    <span class="k">def</span> <span class="nf">first_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get first ray segment.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="RayPath.last_straight"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.last_straight">[docs]</a>    <span class="k">def</span> <span class="nf">last_straight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get last ray segment.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Straight</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="RayPath.efficiency"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get product of all conversion/reflection coefficients encountered on</span>
<span class="sd">        path.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinks</span><span class="p">()),</span> <span class="mf">1.</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayPath.spreading"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.spreading">[docs]</a>    <span class="k">def</span> <span class="nf">spreading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get geometrical spreading factor.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_have_prange</span><span class="p">()</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span> <span class="o">&gt;</span> <span class="n">dp</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">+</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">dp</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">dp</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">*=</span> <span class="n">d2r</span>
        <span class="n">x1</span> <span class="o">*=</span> <span class="n">d2r</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="n">x0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">dp_dx</span> <span class="o">=</span> <span class="n">dp</span><span class="o">/</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">dp</span>

        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dp_dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">first</span><span class="o">.</span><span class="n">pflat_in</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mf">4.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span>
            <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">first</span><span class="o">.</span><span class="n">z_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span> <span class="o">*</span>
            <span class="p">(</span><span class="n">earthradius</span><span class="o">-</span><span class="n">last</span><span class="o">.</span><span class="n">z_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
            <span class="n">first</span><span class="o">.</span><span class="n">u_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
            <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">angle_in</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span><span class="p">))</span> <span class="o">*</span>
            <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">angle_out</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">make_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dp</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">is</span> <span class="k">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dp</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prange_dp</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">)</span><span class="o">/</span><span class="n">dp</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nmin</span><span class="p">)</span>

        <span class="n">ppp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ppp</span>

<div class="viewcode-block" id="RayPath.xt_endgaps"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xt_endgaps">[docs]</a>    <span class="k">def</span> <span class="nf">xt_endgaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get amount of distance/traveltime to be subtracted at the generic ray</span>
<span class="sd">        path&#39;s ends.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">,</span> <span class="n">dirstart</span><span class="p">,</span> <span class="n">dirstop</span> <span class="o">=</span> <span class="n">endgaps</span>
        <span class="n">firsts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span>
        <span class="n">lasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">firsts</span><span class="o">.</span><span class="n">xt_gap</span><span class="p">(</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">firsts</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">dirstart</span> <span class="o">==</span> <span class="n">firsts</span><span class="o">.</span><span class="n">_direction_in</span><span class="p">)</span>
        <span class="n">xe</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">lasts</span><span class="o">.</span><span class="n">xt_gap</span><span class="p">(</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">zstop</span><span class="p">,</span> <span class="n">lasts</span><span class="o">.</span><span class="n">z_out</span><span class="p">(),</span> <span class="n">dirstop</span> <span class="o">==</span> <span class="n">lasts</span><span class="o">.</span><span class="n">_direction_out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">xe</span><span class="p">,</span> <span class="n">ts</span> <span class="o">+</span> <span class="n">te</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;left&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ts</span>
        <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s">&#39;right&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xe</span><span class="p">,</span> <span class="n">te</span></div>

<div class="viewcode-block" id="RayPath.xt_endgaps_ptest"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xt_endgaps_ptest">[docs]</a>    <span class="k">def</span> <span class="nf">xt_endgaps_ptest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if ray parameter is valid at source and receiver.&#39;&#39;&#39;</span>

        <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">,</span> <span class="n">dirstart</span><span class="p">,</span> <span class="n">dirstop</span> <span class="o">=</span> <span class="n">endgaps</span>
        <span class="n">firsts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span>
        <span class="n">lasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">firsts</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zstart</span><span class="p">),</span> <span class="n">lasts</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zstop</span><span class="p">))</span></div>

<div class="viewcode-block" id="RayPath.xt"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xt">[docs]</a>    <span class="k">def</span> <span class="nf">xt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate distance and traveltime for given ray parameter.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">st</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="k">if</span> <span class="n">endgaps</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">-=</span> <span class="n">dx</span>
            <span class="n">st</span> <span class="o">-=</span> <span class="n">dt</span>

        <span class="k">return</span> <span class="n">sx</span><span class="p">,</span> <span class="n">st</span></div>

<div class="viewcode-block" id="RayPath.xt_limits"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.xt_limits">[docs]</a>    <span class="k">def</span> <span class="nf">xt_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate limits of distance and traveltime for given ray parameter.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">sxe</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">ste</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">st</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sxe</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ste</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">sfirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span>
        <span class="n">slast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sfirst</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">slast</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
                <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="n">sends</span> <span class="o">=</span> <span class="p">[</span><span class="n">sfirst</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sfirst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">slast</span><span class="p">:</span>
            <span class="n">sends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slast</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sends</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sxe</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">ste</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="k">return</span> <span class="n">sx</span><span class="p">,</span> <span class="p">(</span><span class="n">sx</span> <span class="o">+</span> <span class="n">sxe</span><span class="p">),</span> <span class="n">st</span><span class="p">,</span> <span class="p">(</span><span class="n">st</span> <span class="o">+</span> <span class="n">ste</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayPath.iter_zxt"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.iter_zxt">[docs]</a>    <span class="k">def</span> <span class="nf">iter_zxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterate over (depth, distance, traveltime) at each layer interface on</span>
<span class="sd">        ray path.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">s</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="k">True</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">s</span><span class="o">.</span><span class="n">z_out</span><span class="p">(),</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="RayPath.zxt_path_subdivided"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.zxt_path_subdivided">[docs]</a>    <span class="k">def</span> <span class="nf">zxt_path_subdivided</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span>
            <span class="n">points_per_straight</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">x_for_headwave</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get geometrical representation of ray path.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
            <span class="n">xstretch</span> <span class="o">=</span> <span class="n">x_for_headwave</span><span class="o">-</span><span class="n">x</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">xstretch</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span>

        <span class="n">dxl</span><span class="p">,</span> <span class="n">dtl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">dxr</span><span class="p">,</span> <span class="n">dtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;right&#39;</span><span class="p">)</span>

        <span class="c"># first create full path including the endgaps</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nout</span><span class="p">)</span> <span class="o">-</span> <span class="n">dxl</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nout</span><span class="p">)</span> <span class="o">-</span> <span class="n">dtl</span>
        <span class="n">zxt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">straights</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">points_per_straight</span>

            <span class="n">back</span> <span class="o">=</span> <span class="k">None</span>
            <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">z_in</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">z_out</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">HeadwaveStraight</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">zin</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">xs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">xstretch</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x2t_headwave</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
                    <span class="n">zxt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filled</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">xstretch</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">sx</span><span class="o">+</span><span class="n">xs</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">ts</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zin</span> <span class="o">!=</span> <span class="n">zout</span><span class="p">:</span>  <span class="c"># normal traversal</span>
                    <span class="n">zs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zin</span><span class="p">,</span> <span class="n">zout</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span><span class="p">:</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="nb">sorted</span><span class="p">([</span><span class="n">zin</span><span class="p">,</span> <span class="n">z</span><span class="p">]))</span>
                        <span class="n">zxt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filled</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">nout</span><span class="p">),</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">+</span> <span class="n">t</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c"># ray turns in layer</span>
                    <span class="n">zturn</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">back</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">zin</span> <span class="o">+</span> <span class="p">(</span><span class="n">zturn</span> <span class="o">-</span> <span class="n">zin</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
                            <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.999</span>

                        <span class="k">if</span> <span class="n">zturn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">zin</span><span class="p">:</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="p">[</span><span class="n">zin</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">zpart</span><span class="o">=</span><span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">zin</span><span class="p">])</span>
                        <span class="n">zxt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">+</span> <span class="n">t</span><span class="p">))</span>
                        <span class="n">back</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">HeadwaveStraight</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xstretch</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x2t_headwave</span><span class="p">(</span><span class="n">xstretch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">sx</span> <span class="o">+=</span> <span class="n">x</span>
            <span class="n">st</span> <span class="o">+=</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">back</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">back</span><span class="p">):</span>
                    <span class="n">zxt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">st</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>

        <span class="c"># gather results as arrays with such that x[ip, ipoint]</span>
        <span class="n">fanz</span><span class="p">,</span> <span class="n">fanx</span><span class="p">,</span> <span class="n">fant</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">zxt</span><span class="p">:</span>
            <span class="n">fanz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">fanx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">fant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fanz</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fanx</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fant</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c"># cut off the endgaps, add exact endpoints</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dxr</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dtr</span>
        <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span> <span class="o">=</span> <span class="n">endgaps</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">zs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">nout</span><span class="p">):</span>
            <span class="n">t_</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mf">0.</span> <span class="o">&lt;=</span> <span class="n">t_</span><span class="p">,</span> <span class="n">t_</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">zs_</span><span class="p">,</span> <span class="n">xs_</span><span class="p">,</span> <span class="n">ts_</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="n">zs_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">xs_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">ts_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">zs_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zs_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span>
            <span class="n">xs_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">xmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zs_</span><span class="p">)</span>
            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xs_</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">zs</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ts</span></div>

    <span class="k">def</span> <span class="nf">_analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_p</span><span class="p">(</span><span class="n">nmin</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_limits</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">=</span> <span class="n">xmin</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xmax</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span> <span class="o">=</span> <span class="n">tmin</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">tmax</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">draft_pxt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
            <span class="n">cp</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span>
            <span class="n">pcrit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">critical_pstart</span><span class="p">(</span><span class="n">endgaps</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">critical_pstop</span><span class="p">(</span><span class="n">endgaps</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">pcrit</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="p">:</span>
                <span class="n">empty</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">empty</span><span class="p">,</span> <span class="n">empty</span><span class="p">,</span> <span class="n">empty</span>

            <span class="k">elif</span> <span class="n">pcrit</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="p">:</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cp</span><span class="p">,</span> <span class="n">cx</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="n">ct</span><span class="o">-</span><span class="n">dt</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">pcrit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">rp</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="n">rp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="p">[:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcrit</span>
                <span class="n">rx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">pcrit</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
                <span class="n">rx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rt</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">-</span> <span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">-</span> <span class="n">dt</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xh</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="mi">10</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headwave_straight</span><span class="p">()</span><span class="o">.</span><span class="n">x2t_headwave</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filled</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">xh</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">x</span><span class="o">+</span><span class="n">xh</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="n">th</span>

<div class="viewcode-block" id="RayPath.interpolate_x2pt_linear"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.interpolate_x2pt_linear">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_x2pt_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get approximate ray parameter and traveltime for distance.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xt_endgaps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">)</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headwave_straight</span><span class="p">()</span>
            <span class="n">xok</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">]</span>
            <span class="n">th</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">x2t_headwave</span><span class="p">(</span><span class="n">xstretch</span><span class="o">=</span><span class="p">(</span><span class="n">xok</span><span class="o">-</span><span class="n">xmin</span><span class="p">))</span> <span class="o">+</span> <span class="n">tmin</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="k">None</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xok</span><span class="p">,</span> <span class="n">th</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="p">)</span> <span class="ow">or</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">rp</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draft_pxt</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>

            <span class="n">xp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">xp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span>
                    <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>

                <span class="n">xp</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">xt</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

            <span class="k">return</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rt</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">x_</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">xt</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">False</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">definition</span><span class="p">(),</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_i</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">end_i</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">turn_i</span> <span class="o">=</span> <span class="k">None</span>

        <span class="k">def</span> <span class="nf">append_layers</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">ti</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">si</span> <span class="o">==</span> <span class="n">ei</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ti</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">ti</span> <span class="o">==</span> <span class="n">si</span><span class="p">):</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;%i&#39;</span> <span class="o">%</span> <span class="n">si</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ti</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;(%i-%i-%i)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">ei</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;(%i-%i)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ei</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Straight</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">start_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">_direction_in</span> <span class="o">!=</span> <span class="n">el</span><span class="o">.</span><span class="n">_direction_out</span><span class="p">:</span>
                    <span class="n">turn_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>
                <span class="n">end_i</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">ilayer</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Kink</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">append_layers</span><span class="p">(</span><span class="n">start_i</span><span class="p">,</span> <span class="n">end_i</span><span class="p">,</span> <span class="n">turn_i</span><span class="p">)</span>
                    <span class="n">start_i</span> <span class="o">=</span> <span class="k">None</span>
                    <span class="n">turn_i</span> <span class="o">=</span> <span class="k">None</span>

                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">start_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">append_layers</span><span class="p">(</span><span class="n">start_i</span><span class="p">,</span> <span class="n">end_i</span><span class="p">,</span> <span class="n">turn_i</span><span class="p">)</span>

        <span class="n">su</span> <span class="o">=</span> <span class="s">&#39;(%s)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_phase</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">used_repr</span><span class="p">()</span>

        <span class="k">return</span> <span class="s">&#39;%-15s %-17s %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">definition</span><span class="p">(),</span> <span class="n">su</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<div class="viewcode-block" id="RayPath.critical_pstart"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.critical_pstart">[docs]</a>    <span class="k">def</span> <span class="nf">critical_pstart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get critical ray parameter for source depth choice.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span><span class="o">.</span><span class="n">critical_p_in</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayPath.critical_pstop"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.critical_pstop">[docs]</a>    <span class="k">def</span> <span class="nf">critical_pstop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get critical ray parameter for receiver depth choice.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span><span class="o">.</span><span class="n">critical_p_out</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span></div>

<div class="viewcode-block" id="RayPath.ranges"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.ranges">[docs]</a>    <span class="k">def</span> <span class="nf">ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get valid ranges of ray parameter, distance, and traveltime.&#39;&#39;&#39;</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draft_pxt</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">p</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>

<div class="viewcode-block" id="RayPath.describe"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.RayPath.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endgaps</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">as_degrees</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get textual representation.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">as_degrees</span><span class="p">:</span>
            <span class="n">xunit</span> <span class="o">=</span> <span class="s">&#39;deg&#39;</span>
            <span class="n">xfact</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xunit</span> <span class="o">=</span> <span class="s">&#39;km&#39;</span>
            <span class="n">xfact</span> <span class="o">=</span> <span class="n">d2m</span><span class="o">/</span><span class="n">km</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;  Ranges for all depths in source and receiver layers:</span>
<span class="s">   - x [%g, %g] %s</span>
<span class="s">   - t [%g, %g] s</span>
<span class="s">   - p [%g, %g] s/deg</span>
<span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmin</span><span class="o">*</span><span class="n">xfact</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xmax</span><span class="o">*</span><span class="n">xfact</span><span class="p">,</span>
            <span class="n">xunit</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmin</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmax</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pmin</span><span class="o">/</span><span class="n">r2d</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pmax</span><span class="o">/</span><span class="n">r2d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">endgaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">(</span><span class="n">endgaps</span><span class="p">)</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;  Ranges for given source and receiver depths:</span>
<span class="se">\n</span><span class="s">   - x [%g, %g] %s</span>
<span class="se">\n</span><span class="s">   - t [%g, %g] s</span>
<span class="se">\n</span><span class="s">   - p [%g, %g] s/deg</span>
<span class="se">\n</span><span class="s">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmin</span><span class="o">*</span><span class="n">xfact</span><span class="p">,</span> <span class="n">xmax</span><span class="o">*</span><span class="n">xfact</span><span class="p">,</span> <span class="n">xunit</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">pmin</span><span class="o">/</span><span class="n">r2d</span><span class="p">,</span> <span class="n">pmax</span><span class="o">/</span><span class="n">r2d</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">return</span> <span class="s">&#39;%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">ss</span> <span class="o">+</span> <span class="n">sg</span></div></div>


<span class="k">class</span> <span class="nc">RefineFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Ray"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray">[docs]</a><span class="k">class</span> <span class="nc">Ray</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Representation of a ray with a specific (path, ray parameter, distance,</span>
<span class="sd">    arrival time) choice.</span>

<span class="sd">    **Attributes:**</span>

<span class="sd">        .. py:attribute:: path</span>

<span class="sd">           :py:class:`RayPath` object containing complete propagation history.</span>

<span class="sd">        .. py:attribute:: p</span>

<span class="sd">           Ray parameter (spherical) [s/rad]</span>

<span class="sd">        .. py:attribute:: x</span>

<span class="sd">           Radial distance [deg]</span>

<span class="sd">        .. py:attribute:: t</span>

<span class="sd">           Traveltime [s]</span>

<span class="sd">        .. py:attribute:: endgaps</span>

<span class="sd">           Needed for source/receiver depth adjustments in many</span>
<span class="sd">           :py:class:`RayPath` methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span> <span class="n">draft_pxt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span> <span class="o">=</span> <span class="n">endgaps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draft_pxt</span> <span class="o">=</span> <span class="n">draft_pxt</span>

<div class="viewcode-block" id="Ray.given_phase"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.given_phase">[docs]</a>    <span class="k">def</span> <span class="nf">given_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get phase definition which was used to create the ray.</span>

<span class="sd">        :returns: :py:class:`PhaseDef` object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">phase</span></div>

<div class="viewcode-block" id="Ray.used_phase"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.used_phase">[docs]</a>    <span class="k">def</span> <span class="nf">used_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute phase definition from propagation path.</span>

<span class="sd">        :returns: :py:class:`PhaseDef` object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">used_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cp</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">ct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draft_pxt</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">ip</span> <span class="o">&lt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RefineFailed</span><span class="p">()</span>

        <span class="n">pl</span><span class="p">,</span> <span class="n">ph</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[</span><span class="n">ip</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cp</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
        <span class="n">p_to_t</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">xt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">)</span>
            <span class="n">p_to_t</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">p_to_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RefineFailed</span><span class="p">()</span>

<div class="viewcode-block" id="Ray.takeoff_angle"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.takeoff_angle">[docs]</a>    <span class="k">def</span> <span class="nf">takeoff_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get takeoff angle of ray.</span>

<span class="sd">        The angle is returned in [degrees].</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">first_straight</span><span class="p">()</span><span class="o">.</span><span class="n">angle_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ray.incidence_angle"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.incidence_angle">[docs]</a>    <span class="k">def</span> <span class="nf">incidence_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get incidence angle of ray.</span>

<span class="sd">        The angle is returned in [degrees].</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">last_straight</span><span class="p">()</span><span class="o">.</span><span class="n">angle_out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ray.efficiency"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get conversion/reflection efficiency of the ray.</span>

<span class="sd">        A value between 0 and 1 is returned, reflecting the relative amount of</span>
<span class="sd">        energy which is transmitted along the ray and not lost by reflections</span>
<span class="sd">        or conversions.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ray.spreading"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.spreading">[docs]</a>    <span class="k">def</span> <span class="nf">spreading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get geometrical spreading factor.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">spreading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">surface_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">d2r</span><span class="p">),</span> <span class="n">r2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">4.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>

<div class="viewcode-block" id="Ray.zxt_path_subdivided"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.Ray.zxt_path_subdivided">[docs]</a>    <span class="k">def</span> <span class="nf">zxt_path_subdivided</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points_per_straight</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get geometrical representation of ray path.</span>

<span class="sd">        Three arrays (depth, distance, time) with points on the ray&#39;s path of</span>
<span class="sd">        propagation are returned. The number of points which are used in each</span>
<span class="sd">        ray segment (passage through one layer) may be controlled by the</span>
<span class="sd">        ``points_per_straight`` parameter.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">zxt_path_subdivided</span><span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">endgaps</span><span class="p">,</span>
            <span class="n">points_per_straight</span><span class="o">=</span><span class="n">points_per_straight</span><span class="p">,</span>
            <span class="n">x_for_headwave</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_degrees</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">as_degrees</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="s">&#39;%6.3g deg&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="s">&#39;%7.5g km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">earthradius</span><span class="o">/</span><span class="n">km</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;%7.5g s/deg %s %6.4g s %5.1f %5.1f %3.0f%% %3.0f%% %s&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">/</span><span class="n">r2d</span><span class="p">,</span>
            <span class="n">sd</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">takeoff_angle</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">incidence_angle</span><span class="p">(),</span>
            <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="p">(),</span>
            <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">spreading</span><span class="p">()</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">surface_sphere</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">anything_to_crust2_profile</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">crust2x2</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">crust2_profile</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">,</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">Crust2Profile</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">crust2_profile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="k">False</span><span class="p">,</span> <span class="s">&#39;crust2_profile must be (lat, lon) a profile &#39;</span> \
            <span class="s">&#39;key or a crust2x2 Profile object)&#39;</span>


<span class="k">class</span> <span class="nc">DiscontinuityNotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth_or_name</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_or_name</span> <span class="o">=</span> <span class="n">depth_or_name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Cannot find discontinuity from given depth or name: %s&#39;</span> <span class="o">%</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">depth_or_name</span>


<span class="k">class</span> <span class="nc">LayeredModelError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="LayeredModel"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel">[docs]</a><span class="k">class</span> <span class="nc">LayeredModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Representation of a layer cake model.</span>

<span class="sd">    There are several ways to initialize an instance of this class.</span>

<span class="sd">    1. Use the module function :py:func:`load_model` to read a model from a</span>
<span class="sd">       file.</span>
<span class="sd">    2. Create an empty model with the default constructor and append layers and</span>
<span class="sd">       discontinuities with the :py:meth:`append` method (from top to bottom).</span>
<span class="sd">    3. Use the constructor :py:meth:`LayeredModel.from_scanlines`, to</span>
<span class="sd">       automatically create the :py:class:`Layer` and :py:class:`Discontinuity`</span>
<span class="sd">       objects from a given velocity profile.</span>

<span class="sd">    An earth model is represented by as stack of :py:class:`Layer` and</span>
<span class="sd">    :py:class:`Discontinuity` objects.  The method :py:meth:`arrivals` returns</span>
<span class="sd">    :py:class:`Ray` objects which may be e.g. queried for arrival times of</span>
<span class="sd">    specific phases. Each ray is associated with a :py:class:`RayPath` object.</span>
<span class="sd">    Ray objects share common ray paths if they have the same</span>
<span class="sd">    conversion/reflection/propagation history. Creating the ray path objects is</span>
<span class="sd">    relatively expensive (this is done in :py:meth:`gather_paths`), but they</span>
<span class="sd">    are cached for reuse in successive invocations.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_surface_material</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_np</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdepth</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathcache</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="LayeredModel.copy_with_elevation"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.copy_with_elevation">[docs]</a>    <span class="k">def</span> <span class="nf">copy_with_elevation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elevation</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a copy of the model with surface layer stretched to given elevation.</span>

<span class="sd">        :param elevation: new surface elevation in [m]</span>

<span class="sd">        Elevation is positiv upward, contrary to the layered models downward</span>
<span class="sd">        `z` axis.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">_pathcache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toplayer</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">toplayer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">elevation</span>

        <span class="n">surface</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">elevation</span>
        <span class="n">c</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">toplayer</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ztop</span><span class="o">=-</span><span class="n">elevation</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">c</span></div>

    <span class="k">def</span> <span class="nf">zeq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z1</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ZEPS</span>

<div class="viewcode-block" id="LayeredModel.append"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a layer or discontinuity at bottom of model.</span>

<span class="sd">        :param element: object of subclass of  :py:class:`Layer` or</span>
<span class="sd">            :py:class:`Discontinuity`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&gt;=</span> <span class="n">earthradius</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">zbot</span> <span class="o">=</span> <span class="n">earthradius</span> <span class="o">-</span> <span class="mf">1.</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&gt;=</span> <span class="n">earthradius</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Layer deeper than earthradius&#39;</span><span class="p">)</span>

            <span class="n">element</span><span class="o">.</span><span class="n">ilayer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayeredModel.elements"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.elements">[docs]</a>    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Iterate over all elements of the model.</span>

<span class="sd">        :param direction: direction of traversal :py:const:`DOWN` or</span>
<span class="sd">            :py:const:`UP`.</span>

<span class="sd">        Objects derived from the :py:class:`Discontinuity` and</span>
<span class="sd">        :py:class:`Layer` classes are yielded.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayeredModel.layers"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.layers">[docs]</a>    <span class="k">def</span> <span class="nf">layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Iterate over all layers of model.</span>

<span class="sd">        :param direction: direction of traversal :py:const:`DOWN` or</span>
<span class="sd">            :py:const:`UP`.</span>

<span class="sd">        Objects derived from the :py:class:`Layer` class are yielded.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Layer</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Layer</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayeredModel.layer"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.layer">[docs]</a>    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get layer for given depth.</span>

<span class="sd">        :param z: depth [m]</span>
<span class="sd">        :param direction: direction of traversal :py:const:`DOWN` or</span>
<span class="sd">            :py:const:`UP`.</span>

<span class="sd">        Returns first layer which touches depth ``z`` (tolerant at boundaries).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">l</span></div>

    <span class="k">def</span> <span class="nf">walker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Walker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span>

<div class="viewcode-block" id="LayeredModel.material"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.material">[docs]</a>    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">DOWN</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get material at given depth.</span>

<span class="sd">        :param z: depth [m]</span>
<span class="sd">        :param direction: direction of traversal :py:const:`DOWN` or</span>
<span class="sd">            :py:const:`UP`</span>
<span class="sd">        :returns: object of type :py:class:`Material`</span>

<span class="sd">        If given depth ``z`` happens to be at an interface, the material of the</span>
<span class="sd">        first layer with respect to the the traversal ordering is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayeredModel.discontinuities"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.discontinuities">[docs]</a>    <span class="k">def</span> <span class="nf">discontinuities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Iterate over all discontinuities of the model.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayeredModel.discontinuity"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.discontinuity">[docs]</a>    <span class="k">def</span> <span class="nf">discontinuity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get discontinuity by name or depth.</span>

<span class="sd">        :param name_or_z: name of discontinuity or depth [m] as float value</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_z</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">candi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discontinuities</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">z</span><span class="o">-</span><span class="n">name_or_z</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">candi</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuities</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name_or_z</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">candi</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DiscontinuityNotFound</span><span class="p">(</span><span class="n">name_or_z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="LayeredModel.adapt_phase"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.adapt_phase">[docs]</a>    <span class="k">def</span> <span class="nf">adapt_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adapt a phase definition for use with this model.</span>

<span class="sd">        This returns a copy of the phase definition, where named</span>
<span class="sd">        discontinuities are replaced with the actual depth of these, as defined</span>
<span class="sd">        in the model.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">knee</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">knees</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">!=</span> <span class="s">&#39;surface&#39;</span><span class="p">:</span>
                <span class="n">knee</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">knee</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">legs</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>

        <span class="k">return</span> <span class="n">phase</span></div>

<div class="viewcode-block" id="LayeredModel.path"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_stop</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get ray path for given combination of ray parameter, phase definition,</span>
<span class="sd">        source and receiver layers.</span>

<span class="sd">        :param p: ray parameter (spherical) [s/rad]</span>
<span class="sd">        :param phase: phase definition (:py:class:`PhaseDef` object)</span>
<span class="sd">        :param layer_start: layer with source</span>
<span class="sd">        :param layer_stop: layer with receiver</span>
<span class="sd">        :returns: :py:class:`RayPath` object</span>

<span class="sd">        If it is not possible to find a solution, an exception of type</span>
<span class="sd">        :py:exc:`NotPhaseConform`, :py:exc:`MinDepthReached`,</span>
<span class="sd">        :py:exc:`MaxDepthReached`, :py:exc:`CannotPropagate`,</span>
<span class="sd">        :py:exc:`BottomReached` or :py:exc:`SurfaceReached` is raised.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">knees</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">knees</span><span class="p">()</span>
        <span class="n">legs</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">legs</span><span class="p">()</span>
        <span class="n">next_knee</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">knees</span><span class="p">)</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">legs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">leg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">departure</span>
        <span class="n">direction_stop</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">direction_stop</span><span class="p">()</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">mode</span>
        <span class="n">mode_stop</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">last_leg</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span>

        <span class="n">walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walker</span><span class="p">()</span>
        <span class="n">walker</span><span class="o">.</span><span class="n">goto_layer</span><span class="p">(</span><span class="n">layer_start</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">walker</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="n">ttop</span><span class="p">,</span> <span class="n">tbot</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ttop</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbot</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CannotPropagate</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">ilayer</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DOWN</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ttop</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">UP</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbot</span><span class="p">):</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="n">direction</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">RayPath</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">trapdetect</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
            <span class="n">at_layer</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span>
            <span class="n">at_discontinuity</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">)</span>

            <span class="c"># detect trapped wave</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">next_knee</span><span class="p">),</span> <span class="nb">id</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">direction</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">trapdetect</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Trapped</span><span class="p">()</span>

            <span class="n">trapdetect</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">at_discontinuity</span><span class="p">:</span>
                <span class="n">oldmode</span><span class="p">,</span> <span class="n">olddirection</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span>
                <span class="n">headwave</span> <span class="o">=</span> <span class="k">False</span>
                <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span>
                        <span class="n">current</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>

                    <span class="n">headwave</span> <span class="o">=</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">headwave</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">out_direction</span><span class="p">()</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">next_knee</span><span class="o">.</span><span class="n">out_mode</span>
                    <span class="n">next_knee</span> <span class="o">=</span> <span class="n">next_or_none</span><span class="p">(</span><span class="n">knees</span><span class="p">)</span>
                    <span class="n">leg</span> <span class="o">=</span> <span class="n">legs</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c"># implicit reflection/transmission</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">headwave</span><span class="p">:</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">set_is_headwave</span><span class="p">(</span><span class="k">True</span><span class="p">)</span>

                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Kink</span><span class="p">(</span>
                        <span class="n">olddirection</span><span class="p">,</span> <span class="n">olddirection</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HeadwaveStraight</span><span class="p">(</span>
                        <span class="n">olddirection</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Kink</span><span class="p">(</span>
                        <span class="n">olddirection</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Kink</span><span class="p">(</span>
                        <span class="n">olddirection</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">oldmode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">at_layer</span><span class="p">:</span>
                <span class="n">direction_in</span> <span class="o">=</span> <span class="n">direction</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">direction_in</span><span class="p">)</span>

                <span class="n">zturn</span> <span class="o">=</span> <span class="k">None</span>
                <span class="k">if</span> <span class="n">direction_in</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">:</span>
                    <span class="n">zturn</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">zturn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

                <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmin</span><span class="p">,</span> <span class="n">leg</span><span class="o">.</span><span class="n">depthmax</span>
                <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">direction_in</span> <span class="o">!=</span> <span class="n">direction</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">zturn</span> <span class="o">&lt;=</span> <span class="n">zmin</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MinDepthReached</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">zturn</span> <span class="o">&gt;=</span> <span class="n">zmax</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MaxDepthReached</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">zmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&lt;=</span> <span class="n">zmin</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MinDepthReached</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">zmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&gt;=</span> <span class="n">zmax</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">MaxDepthReached</span><span class="p">()</span>

                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Straight</span><span class="p">(</span><span class="n">direction_in</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">next_knee</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">mode_stop</span> <span class="ow">and</span> \
                        <span class="n">current</span> <span class="ow">is</span> <span class="n">layer_stop</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">zturn</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">direction_stop</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="n">walker</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">walker</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="LayeredModel.gather_paths"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.gather_paths">[docs]</a>    <span class="k">def</span> <span class="nf">gather_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="o">=</span><span class="n">PhaseDef</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span> <span class="n">zstart</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get all possible ray paths for given source and receiver depths for one</span>
<span class="sd">        or more phase definitions.</span>

<span class="sd">        :param phases: a :py:class:`PhaseDef` object or a list of such objects.</span>
<span class="sd">            Comma-separated strings and lists of such strings are also accepted</span>
<span class="sd">            and are converted to :py:class:`PhaseDef` objects for convenience.</span>
<span class="sd">        :param zstart: source depth [m]</span>
<span class="sd">        :param zstop: receiver depth [m]</span>
<span class="sd">        :returns: a list of :py:class:`RayPath` objects</span>

<span class="sd">        Results of this method are cached internally. Cached results are</span>
<span class="sd">        returned, when a given combination of source layer, receiver layer and</span>
<span class="sd">        phase definition has been used before.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span>  <span class="c"># num.finfo(float).eps * 1000.</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="n">to_phase_defs</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>

            <span class="n">layer_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">zstart</span><span class="p">,</span> <span class="o">-</span><span class="n">phase</span><span class="o">.</span><span class="n">direction_start</span><span class="p">())</span>
            <span class="n">layer_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">zstop</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">direction_stop</span><span class="p">())</span>

            <span class="n">pathcachekey</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">definition</span><span class="p">(),</span> <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_stop</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pathcachekey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathcache</span><span class="p">:</span>
                <span class="n">phase_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathcache</span><span class="p">[</span><span class="n">pathcachekey</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hwknee</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">headwave_knee</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">hwknee</span><span class="p">:</span>
                    <span class="n">name_or_z</span> <span class="o">=</span> <span class="n">hwknee</span><span class="o">.</span><span class="n">depth</span>
                    <span class="n">interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">name_or_z</span><span class="p">)</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">hwknee</span><span class="o">.</span><span class="n">in_mode</span>
                    <span class="n">in_direction</span> <span class="o">=</span> <span class="n">hwknee</span><span class="o">.</span><span class="n">direction</span>

                    <span class="n">pabove</span><span class="p">,</span> <span class="n">pbelow</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">critical_ps</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

                    <span class="n">p</span> <span class="o">=</span> <span class="n">min_not_none</span><span class="p">(</span><span class="n">pabove</span><span class="p">,</span> <span class="n">pbelow</span><span class="p">)</span>

                    <span class="c"># diffracted wave:</span>
                    <span class="k">if</span> <span class="n">in_direction</span> <span class="o">==</span> <span class="n">DOWN</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">pbelow</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">pbelow</span> <span class="o">&gt;=</span> <span class="n">pabove</span><span class="p">):</span>

                        <span class="n">p</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>

                    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_stop</span><span class="p">)</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">set_prange</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

                    <span class="n">phase_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pmax_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span>
                            <span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">layer_start</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">first_leg</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">layer_start</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">layer_start</span><span class="o">.</span><span class="n">zbot</span><span class="p">)])</span>

                        <span class="n">pmax_stop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span>
                            <span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">layer_stop</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">last_leg</span><span class="p">()</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">layer_stop</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">layer_stop</span><span class="o">.</span><span class="n">zbot</span><span class="p">)])</span>

                        <span class="n">pmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pmax_start</span><span class="p">,</span> <span class="n">pmax_stop</span><span class="p">)</span>

                        <span class="n">pedges</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">zbot</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">S</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">eps2</span> <span class="ow">in</span> <span class="p">[</span><span class="n">eps</span><span class="p">]:</span>
                                        <span class="n">v</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                                            <span class="n">p</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">v</span>
                                            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">pmax</span><span class="p">:</span>
                                                <span class="n">pedges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">eps2</span><span class="p">))</span>
                                                <span class="n">pedges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                                                <span class="n">pedges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">eps2</span><span class="p">))</span>

                        <span class="n">pedges</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pedges</span><span class="p">))</span>

                        <span class="n">phase_paths</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">cached</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">def</span> <span class="nf">p_to_path</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cached</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">cached</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span>
                                    <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">layer_start</span><span class="p">,</span> <span class="n">layer_stop</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_paths</span><span class="p">:</span>
                                    <span class="n">phase_paths</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                                <span class="n">phase_paths</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

                            <span class="k">except</span> <span class="n">PathFailed</span><span class="p">:</span>
                                <span class="n">path</span> <span class="o">=</span> <span class="k">None</span>

                            <span class="n">cached</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                            <span class="k">return</span> <span class="n">path</span>

                        <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdepth</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="n">path1</span> <span class="o">=</span> <span class="n">p_to_path</span><span class="p">(</span><span class="n">pmin</span><span class="p">)</span>
                            <span class="n">path2</span> <span class="o">=</span> <span class="n">p_to_path</span><span class="p">(</span><span class="n">pmax</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">path1</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">path2</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">return</span>
                            <span class="k">if</span> <span class="n">path1</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">path2</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> \
                                    <span class="nb">hash</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">path2</span><span class="p">):</span>

                                <span class="n">recurse</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="p">(</span><span class="n">pmin</span><span class="o">+</span><span class="n">pmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">recurse</span><span class="p">((</span><span class="n">pmin</span><span class="o">+</span><span class="n">pmax</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">pmax</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                        <span class="k">for</span> <span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                            <span class="n">recurse</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">ph</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">phase_paths</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="n">path</span><span class="o">.</span><span class="n">set_prange</span><span class="p">(</span>
                                <span class="nb">min</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ps</span><span class="p">),</span> <span class="n">pmax</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_np</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

                        <span class="n">phase_paths</span> <span class="o">=</span> <span class="n">phase_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">phase_paths</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_pathcache</span><span class="p">[</span><span class="n">pathcachekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_paths</span>

            <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phase_paths</span><span class="p">)</span>

        <span class="n">paths</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pmin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span></div>

<div class="viewcode-block" id="LayeredModel.arrivals"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.arrivals">[docs]</a>    <span class="k">def</span> <span class="nf">arrivals</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">distances</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">phases</span><span class="o">=</span><span class="n">PhaseDef</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">),</span>
            <span class="n">zstart</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">zstop</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">refine</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute rays and traveltimes for given distances.</span>

<span class="sd">        :param distances: list or array of distances [deg]</span>
<span class="sd">        :param phases: a :py:class:`PhaseDef` object or a list of such objects.</span>
<span class="sd">            Comma-separated strings and lists of such strings are also accepted</span>
<span class="sd">            and are converted to :py:class:`PhaseDef` objects for convenience.</span>
<span class="sd">        :param zstart: source depth [m]</span>
<span class="sd">        :param zstop: receiver depth [m]</span>
<span class="sd">        :param refine: bool flag, whether to use bisectioning to improve</span>
<span class="sd">            (p, x, t) estimated from interpolation</span>
<span class="sd">        :returns: a list of :py:class:`Ray` objects, sorted by</span>
<span class="sd">            (distance, arrival time)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">distances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_paths</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">zstart</span><span class="o">=</span><span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="o">=</span><span class="n">zstop</span><span class="p">):</span>

            <span class="n">endgaps</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">endgaps</span><span class="p">(</span><span class="n">zstart</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">draft_pxt</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">interpolate_x2pt_linear</span><span class="p">(</span>
                    <span class="n">distances</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">):</span>

                <span class="n">arrivals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ray</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">endgaps</span><span class="p">,</span> <span class="n">draft_pxt</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>
            <span class="n">refined</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ray</span> <span class="ow">in</span> <span class="n">arrivals</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">ray</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">_is_headwave</span><span class="p">:</span>
                    <span class="n">refined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ray</span><span class="o">.</span><span class="n">refine</span><span class="p">()</span>
                    <span class="n">refined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">RefineFailed</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">arrivals</span> <span class="o">=</span> <span class="n">refined</span>

        <span class="n">arrivals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">arrivals</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="LayeredModel.from_scanlines"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.from_scanlines">[docs]</a>    <span class="k">def</span> <span class="nf">from_scanlines</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">producer</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create layer cake model from sequence of materials at depths.</span>

<span class="sd">        :param producer: iterable yielding (depth, material, name) tuples</span>

<span class="sd">        Creates a new :py:class:`LayeredModel` object and uses its</span>
<span class="sd">        :py:meth:`append` method to add layers and discontinuities as needed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">producer</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Surface</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeq</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Interface</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">):</span>
                        <span class="n">ztop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">z</span>
                        <span class="n">mtop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mbelow</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                        <span class="n">ztop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span>
                        <span class="n">mtop</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span>

                    <span class="k">if</span> <span class="n">mtop</span> <span class="o">==</span> <span class="n">material</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span>
                            <span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span>
                            <span class="n">ztop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">mtop</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">to_scanlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">vp</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">vs</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">qs</span><span class="p">)</span>

        <span class="n">last</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mtop</span><span class="p">))</span>

                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span><span class="p">))</span>

            <span class="n">last</span> <span class="o">=</span> <span class="n">element</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">last</span><span class="o">.</span><span class="n">mbelow</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">iter_material_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">get</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;vp&#39;</span><span class="p">,</span> <span class="s">&#39;vs&#39;</span><span class="p">,</span> <span class="s">&#39;rho&#39;</span><span class="p">,</span> <span class="s">&#39;qp&#39;</span><span class="p">,</span> <span class="s">&#39;qs&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get</span> <span class="o">==</span> <span class="s">&#39;z&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span>
                <span class="k">yield</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">getter</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">getter</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="p">)</span>

<div class="viewcode-block" id="LayeredModel.profile"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.profile">[docs]</a>    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get parameter profile along depth of the earthmodel.</span>

<span class="sd">        :param get: property to be queried (</span>
<span class="sd">            ``&#39;vp&#39;``, ``&#39;vs&#39;``, ``&#39;rho&#39;``, ``&#39;qp&#39;``, or ``&#39;qs&#39;``, or ``&#39;z&#39;``)</span>
<span class="sd">        :type get: string</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_material_parameter</span><span class="p">(</span><span class="n">get</span><span class="p">)))</span></div>

<div class="viewcode-block" id="LayeredModel.min"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="s">&#39;vp&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find minimum value of a material property or depth.</span>

<span class="sd">        :param get: property to be queried (</span>
<span class="sd">            ``&#39;vp&#39;``, ``&#39;vs&#39;``, ``&#39;rho&#39;``, ``&#39;qp&#39;``, or ``&#39;qs&#39;``, or ``&#39;z&#39;``)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_material_parameter</span><span class="p">(</span><span class="n">get</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayeredModel.max"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="s">&#39;vp&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find maximum value of a material property or depth.</span>

<span class="sd">        :param get: property to be queried (</span>
<span class="sd">            ``&#39;vp&#39;``, ``&#39;vs&#39;``, ``&#39;rho&#39;``, ``&#39;qp&#39;``, ``&#39;qs&#39;``, or ``&#39;z&#39;``)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_material_parameter</span><span class="p">(</span><span class="n">get</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">simplify_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">max_rel_error</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">layers</span>

        <span class="n">ztop</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ztop</span>
        <span class="n">zbot</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">zbot</span>
        <span class="n">zorigs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">ztop</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
        <span class="n">zorigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zbot</span><span class="p">)</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">ztop</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">UP</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">DOWN</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">astuple</span><span class="p">())</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">data_means</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="k">False</span>

        <span class="n">zcut_best</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ncutintervals</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">zdelta</span> <span class="o">=</span> <span class="p">(</span><span class="n">zbot</span><span class="o">-</span><span class="n">ztop</span><span class="p">)</span><span class="o">/</span><span class="n">ncutintervals</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">zcuts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">ztop</span><span class="p">,</span> <span class="n">ztop</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">zdelta</span><span class="p">,</span> <span class="n">zbot</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncutintervals</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">zcuts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncutintervals</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncutintervals</span><span class="p">):</span>
                        <span class="n">zcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">ztop</span><span class="p">,</span> <span class="n">ztop</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">zdelta</span><span class="p">,</span> <span class="n">ztop</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">zdelta</span><span class="p">,</span> <span class="n">zbot</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zcuts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">zcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">zcut_best</span><span class="p">:</span>
                    <span class="n">zcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">zcut_best</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">zcuts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">zcut_best</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="n">best</span> <span class="o">=</span> <span class="k">None</span>
            <span class="k">for</span> <span class="n">icut</span><span class="p">,</span> <span class="n">zcut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zcuts</span><span class="p">):</span>
                <span class="n">rel_par_errors</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">mpar_nodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">ipar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">znodes</span><span class="p">,</span> <span class="n">vnodes</span><span class="p">,</span> <span class="n">error_rms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">polylinefit</span><span class="p">(</span>
                        <span class="n">zs</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">ipar</span><span class="p">],</span> <span class="n">zcut</span><span class="p">)</span>

                    <span class="n">mpar_nodes</span><span class="p">[:,</span> <span class="n">ipar</span><span class="p">]</span> <span class="o">=</span> <span class="n">vnodes</span>
                    <span class="k">if</span> <span class="n">data_means</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">rel_par_errors</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rel_par_errors</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_rms</span><span class="o">/</span><span class="n">data_means</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>

                <span class="n">rel_error</span> <span class="o">=</span> <span class="n">rel_par_errors</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">rel_error</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">rel_error</span><span class="p">,</span> <span class="n">zcut</span><span class="p">,</span> <span class="n">mpar_nodes</span><span class="p">)</span>

            <span class="n">rel_error</span><span class="p">,</span> <span class="n">zcut</span><span class="p">,</span> <span class="n">mpar_nodes</span> <span class="o">=</span> <span class="n">best</span>

            <span class="n">zcut_best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">zcut</span><span class="p">))</span>
            <span class="n">zcut_best</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">zcut_best</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">rel_error</span> <span class="o">&lt;=</span> <span class="n">max_rel_error</span><span class="p">:</span>
                <span class="n">accept</span> <span class="o">=</span> <span class="k">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">accept</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">layers</span>

        <span class="n">rel_error</span><span class="p">,</span> <span class="n">zcut</span><span class="p">,</span> <span class="n">mpar_nodes</span> <span class="o">=</span> <span class="n">best</span>

        <span class="n">material_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">material_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Material</span><span class="p">(</span><span class="o">*</span><span class="n">mpar_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

        <span class="n">out_layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">mtop</span> <span class="o">=</span> <span class="n">material_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mbot</span> <span class="o">=</span> <span class="n">material_nodes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ztop</span> <span class="o">=</span> <span class="n">zcut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">zbot</span> <span class="o">=</span> <span class="n">zcut</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mtop</span> <span class="o">==</span> <span class="n">mbot</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">HomogeneousLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">mtop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">GradientLayer</span><span class="p">(</span><span class="n">ztop</span><span class="p">,</span> <span class="n">zbot</span><span class="p">,</span> <span class="n">mtop</span><span class="p">,</span> <span class="n">mbot</span><span class="p">)</span>

            <span class="n">out_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_layers</span>

<div class="viewcode-block" id="LayeredModel.simplify"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.simplify">[docs]</a>    <span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_rel_error</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get representation of model with lower resolution.</span>

<span class="sd">        Returns an approximation of the model. All discontinuities are kept,</span>
<span class="sd">        but layer stacks with continuous model parameters are represented, if</span>
<span class="sd">        possible, by a lower number of layers.  Piecewise linear functions are</span>
<span class="sd">        fitted against the original model parameter&#39;s piecewise linear</span>
<span class="sd">        functions.  Successively larger numbers of layers are tried, until the</span>
<span class="sd">        difference to the original model is below ``max_rel_error``. The</span>
<span class="sd">        difference is measured as the RMS error of the fit normalized by the</span>
<span class="sd">        mean of the input (i.e. the fitted curves should deviate, on average,</span>
<span class="sd">        less than 0.1% from the input curves if ``max_rel_error`` = 0.001).&#39;&#39;&#39;</span>

        <span class="n">mod_simple</span> <span class="o">=</span> <span class="n">LayeredModel</span><span class="p">()</span>

        <span class="n">glayers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Discontinuity</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_layers</span><span class="p">(</span>
                        <span class="n">glayers</span><span class="p">,</span> <span class="n">max_rel_error</span><span class="o">=</span><span class="n">max_rel_error</span><span class="p">):</span>

                    <span class="n">mod_simple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

                <span class="n">glayers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mod_simple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">glayers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_layers</span><span class="p">(</span><span class="n">glayers</span><span class="p">,</span> <span class="n">max_rel_error</span><span class="o">=</span><span class="n">max_rel_error</span><span class="p">):</span>
            <span class="n">mod_simple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mod_simple</span></div>

<div class="viewcode-block" id="LayeredModel.extract"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.LayeredModel.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth_min</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">depth_max</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Extract :py:class:`LayeredModel` from :py:class:`LayeredModel`.</span>

<span class="sd">        :param depth_min: depth of upper cut or name of :py:class:`Interface`</span>
<span class="sd">        :param depth_max: depth of lower cut or name of :py:class:`Interface`</span>

<span class="sd">        Interpolates a :py:class:`GradientLayer` at ``depth_min`` and/or</span>
<span class="sd">        ``depth_max``.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth_min</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">depth_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">depth_min</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth_max</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">depth_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discontinuity</span><span class="p">(</span><span class="n">depth_max</span><span class="p">)</span><span class="o">.</span><span class="n">z</span>

        <span class="n">mod_extracted</span> <span class="o">=</span> <span class="n">LayeredModel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">do_append</span> <span class="o">=</span> <span class="k">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">depth_min</span> <span class="o">&lt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">ztop</span> <span class="ow">or</span> <span class="n">depth_min</span> <span class="ow">is</span> <span class="k">None</span><span class="p">)</span> <span class="ow">and</span>\
                    <span class="p">(</span><span class="n">depth_max</span> <span class="o">&gt;=</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">or</span> <span class="n">depth_max</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>
                <span class="n">mod_extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">depth_min</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">ztop</span> <span class="ow">and</span> <span class="n">depth_min</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">depth_min</span><span class="p">)</span>
                <span class="n">do_append</span> <span class="o">=</span> <span class="k">True</span>

            <span class="k">if</span> <span class="n">depth_max</span> <span class="o">&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span> <span class="ow">and</span> <span class="n">depth_max</span> <span class="o">&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                <span class="n">element</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">depth_max</span><span class="p">)</span>
                <span class="n">do_append</span> <span class="o">=</span> <span class="k">True</span>

            <span class="k">if</span> <span class="n">do_append</span><span class="p">:</span>
                <span class="n">mod_extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mod_extracted</span></div>

    <span class="k">def</span> <span class="nf">replaced_crust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">crustmod</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">crust2_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">anything_to_crust2_profile</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">)</span>
            <span class="n">crustmod</span> <span class="o">=</span> <span class="n">LayeredModel</span><span class="o">.</span><span class="n">from_scanlines</span><span class="p">(</span>
                <span class="n">from_crust2x2_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>

        <span class="n">newmod</span> <span class="o">=</span> <span class="n">LayeredModel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">crustmod</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_max</span><span class="o">=</span><span class="s">&#39;moho&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;moho&#39;</span><span class="p">:</span>
                <span class="n">newmod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moho1</span> <span class="o">=</span> <span class="n">element</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_min</span><span class="o">=</span><span class="s">&#39;moho&#39;</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;moho&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">moho1</span><span class="o">.</span><span class="n">z</span><span class="p">:</span>
                    <span class="n">mbelow</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">moho1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">UP</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mbelow</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mbelow</span>

                <span class="n">moho</span> <span class="o">=</span> <span class="n">Interface</span><span class="p">(</span><span class="n">moho1</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">moho1</span><span class="o">.</span><span class="n">mabove</span><span class="p">,</span> <span class="n">mbelow</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;moho&#39;</span><span class="p">)</span>
                <span class="n">newmod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moho</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&gt;</span> <span class="n">moho</span><span class="o">.</span><span class="n">z</span><span class="p">:</span>
                        <span class="n">newmod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GradientLayer</span><span class="p">(</span>
                            <span class="n">moho</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span>
                            <span class="n">moho</span><span class="o">.</span><span class="n">mbelow</span><span class="p">,</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">mbot</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                        <span class="n">first</span> <span class="o">=</span> <span class="k">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newmod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newmod</span>

    <span class="k">def</span> <span class="nf">require_homogeneous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LayeredModelError</span><span class="p">(</span><span class="s">&#39;More than one layer in earthmodel&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">HomogeneousLayer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LayeredModelError</span><span class="p">(</span><span class="s">&#39;Layer has to be a HomogeneousLayer&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">m</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_hyposat_model"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.read_hyposat_model">[docs]</a><span class="k">def</span> <span class="nf">read_hyposat_model</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Reader for HYPOSAT earth model files.</span>

<span class="sd">    To be used as producer in :py:meth:`LayeredModel.from_scanlines`.</span>

<span class="sd">    Interface names are translated as follows: ``&#39;MOHO&#39;`` -&gt; ``&#39;moho&#39;``,</span>
<span class="sd">    ``&#39;CONR&#39;`` -&gt; ``&#39;conrad&#39;``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;MOHO&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;CONR&#39;</span><span class="p">:</span> <span class="s">&#39;conrad&#39;</span><span class="p">}</span>
    <span class="n">lname</span> <span class="o">=</span> <span class="k">None</span>
    <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">z</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">unpack_fixed</span><span class="p">(</span><span class="s">&#39;f10, f10, f10, a4&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">material</span> <span class="o">=</span> <span class="n">Material</span><span class="p">(</span><span class="n">vp</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)</span>

        <span class="n">tname</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">lname</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">z</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">tname</span>

        <span class="n">lname</span> <span class="o">=</span> <span class="n">name</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="read_nd_model"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.read_nd_model">[docs]</a><span class="k">def</span> <span class="nf">read_nd_model</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Reader for TauP style &#39;.nd&#39; (named discontinuity) files.</span>

<span class="sd">    To be used as producer in :py:meth:`LayeredModel.from_scanlines`.</span>

<span class="sd">    Interface names are translated as follows: ``&#39;mantle&#39;`` -&gt; ``&#39;moho&#39;``,</span>
<span class="sd">    ``&#39;outer-core&#39;`` -&gt; ``&#39;cmb&#39;``, ``&#39;inner-core&#39;`` -&gt; ``&#39;icb&#39;``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">read_nd_model_fh</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">x</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">read_nd_model_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">read_nd_model_fh</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">x</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">read_nd_model_fh</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;mantle&#39;</span><span class="p">:</span> <span class="s">&#39;moho&#39;</span><span class="p">,</span> <span class="s">&#39;outer-core&#39;</span><span class="p">:</span> <span class="s">&#39;cmb&#39;</span><span class="p">,</span> <span class="s">&#39;inner-core&#39;</span><span class="p">:</span> <span class="s">&#39;icb&#39;</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="k">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
            <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>

            <span class="n">material</span> <span class="o">=</span> <span class="n">Material</span><span class="p">(</span><span class="n">vp</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">rho</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">z</span><span class="o">*</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">from_crust2x2_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">depthmantle</span><span class="o">=</span><span class="mi">50000</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">crust2x2</span>

    <span class="n">default_qp_qs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;soft sed.&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">),</span>
        <span class="s">&#39;hard sed.&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">200.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">),</span>
        <span class="s">&#39;upper crust&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">600.</span><span class="p">,</span> <span class="mf">400.</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">z</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">dz</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">Crust2Profile</span><span class="o">.</span><span class="n">layer_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">default_qp_qs</span><span class="p">:</span>
            <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="n">default_qp_qs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="k">None</span><span class="p">,</span> <span class="k">None</span>

        <span class="n">material</span> <span class="o">=</span> <span class="n">Material</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">vs</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
        <span class="n">iname</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">iname</span> <span class="o">=</span> <span class="s">&#39;moho&#39;</span>
        <span class="k">if</span> <span class="n">dz</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">z</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">iname</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">z</span><span class="o">+</span><span class="n">depthmantle</span><span class="p">,</span> <span class="n">material</span><span class="p">,</span> <span class="n">name</span>

            <span class="n">z</span> <span class="o">+=</span> <span class="n">dz</span>


<span class="k">def</span> <span class="nf">write_nd_model_fh</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">gform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">z</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">vp</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">vs</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">rho</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">qs</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="n">translate</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;moho&#39;</span><span class="p">:</span> <span class="s">&#39;mantle&#39;</span><span class="p">,</span>
        <span class="s">&#39;cmb&#39;</span><span class="p">:</span> <span class="s">&#39;outer-core&#39;</span><span class="p">,</span>
        <span class="s">&#39;icb&#39;</span><span class="p">:</span> <span class="s">&#39;inner-core&#39;</span><span class="p">}</span>

    <span class="n">last</span> <span class="o">=</span> <span class="k">None</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Interface</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ztop</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mtop</span><span class="p">))</span>

            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">zbot</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mbot</span><span class="p">))</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">element</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">last</span><span class="o">.</span><span class="n">mbelow</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">write_nd_model_str</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">write_nd_model_fh</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">write_nd_model</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">write_nd_model_fh</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">builtin_models</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">builtin_model_filename</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">builtin_model_filename</span><span class="p">(</span><span class="n">modelname</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">data_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;earthmodels&#39;</span><span class="p">,</span> <span class="n">modelname</span><span class="o">+</span><span class="s">&#39;.nd&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="load_model"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.load_model">[docs]</a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="s">&#39;ak135-f-continental.m&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&#39;nd&#39;</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Load layered earth model from file.</span>

<span class="sd">    :param fn: filename</span>
<span class="sd">    :param format: format</span>
<span class="sd">    :param crust2_profile: ``(lat, lon)`` or</span>
<span class="sd">        :py:class:`pyrocko.crust2x2.Crust2Profile` object, merge model with</span>
<span class="sd">        crustal profile. If ``fn`` is forced to be ``None`` only the converted</span>
<span class="sd">        CRUST2.0 profile is returned.</span>
<span class="sd">    :returns: object of type :py:class:`LayeredModel`</span>

<span class="sd">    The following formats are currently supported:</span>

<span class="sd">    ============== ===========================================================</span>
<span class="sd">    format         description</span>
<span class="sd">    ============== ===========================================================</span>
<span class="sd">    ``&#39;nd&#39;``       &#39;named discontinuity&#39; format used by the TauP programs</span>
<span class="sd">    ``&#39;hyposat&#39;``  format used by the HYPOSAT location program</span>
<span class="sd">    ============== ===========================================================</span>

<span class="sd">    The naming of interfaces is translated from the file format&#39;s native naming</span>
<span class="sd">    to Cake&#39;s own convention (See :py:func:`read_nd_model` and</span>
<span class="sd">    :py:func:`read_hyposat_model` for details).  Cake likes the following</span>
<span class="sd">    internal names: ``&#39;conrad&#39;``, ``&#39;moho&#39;``, ``&#39;cmb&#39;`` (core-mantle boundary),</span>
<span class="sd">    ``&#39;icb&#39;`` (inner core boundary).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s">&#39;nd&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">builtin_models</span><span class="p">():</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">builtin_model_filename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">read_nd_model</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s">&#39;hyposat&#39;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">read_hyposat_model</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="k">False</span><span class="p">,</span> <span class="s">&#39;unsupported model format&#39;</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="n">LayeredModel</span><span class="o">.</span><span class="n">from_scanlines</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crust2_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span><span class="o">.</span><span class="n">replaced_crust</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mod</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">crust2_profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">anything_to_crust2_profile</span><span class="p">(</span><span class="n">crust2_profile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">LayeredModel</span><span class="o">.</span><span class="n">from_scanlines</span><span class="p">(</span>
            <span class="n">from_crust2x2_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span></div>


<div class="viewcode-block" id="castagna_vs_to_vp"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.castagna_vs_to_vp">[docs]</a><span class="k">def</span> <span class="nf">castagna_vs_to_vp</span><span class="p">(</span><span class="n">vs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate vp from vs using castagna&#39;s relation.</span>

<span class="sd">    Castagna&#39;s relation (the mudrock line) is an empirical relation for vp/vs</span>
<span class="sd">    for siliciclastic rocks (i.e. sandstones and shales). [Castagna et al.,</span>
<span class="sd">    1985]</span>

<span class="sd">        vp = 1.16 * vs + 1360 [m/s]</span>

<span class="sd">    :param vs: S-wave velocity [m/s]</span>
<span class="sd">    :returns: P-wave velocity [m/s]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">vs</span><span class="o">*</span><span class="mf">1.16</span> <span class="o">+</span> <span class="mf">1360.0</span></div>


<div class="viewcode-block" id="castagna_vp_to_vs"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.castagna_vp_to_vs">[docs]</a><span class="k">def</span> <span class="nf">castagna_vp_to_vs</span><span class="p">(</span><span class="n">vp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate vp from vs using castagna&#39;s relation.</span>

<span class="sd">    Castagna&#39;s relation (the mudrock line) is an empirical relation for vp/vs</span>
<span class="sd">    for siliciclastic rocks (i.e. sandstones and shales). [Castagna et al.,</span>
<span class="sd">    1985]</span>

<span class="sd">        vp = 1.16 * vs + 1360 [m/s]</span>

<span class="sd">    :param vp: P-wave velocity [m/s]</span>
<span class="sd">    :returns: S-wave velocity [m/s]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vp</span> <span class="o">-</span> <span class="mf">1360.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.16</span></div>


<span class="k">def</span> <span class="nf">evenize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">minsize</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ry</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x2</span>


<div class="viewcode-block" id="filled"><a class="viewcode-back" href="../../library/reference/cake.html#pyrocko.cake.filled">[docs]</a><span class="k">def</span> <span class="nf">filled</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create NumPy array filled with given value.</span>

<span class="sd">    This works like :py:func:`numpy.ones` but initializes the array with ``v``</span>
<span class="sd">    instead of ones.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<span class="k">def</span> <span class="nf">next_or_none</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">None</span>


<span class="k">def</span> <span class="nf">reci_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">x</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">None</span>


<span class="k">def</span> <span class="nf">mult_or_none</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">b</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">None</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span>


<span class="k">def</span> <span class="nf">min_not_none</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">xytups</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">monoton</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">monoton</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xytups</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">monoton</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xytups</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xv</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">xv</span><span class="p">,</span> <span class="n">xv</span> <span class="o">&gt;</span> <span class="n">xp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xv</span><span class="p">,</span> <span class="n">xv</span> <span class="o">&lt;</span> <span class="n">xp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">xr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xv</span> <span class="o">-</span> <span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">xr</span><span class="o">*</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">xr</span><span class="p">)</span><span class="o">*</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xv</span><span class="p">,</span> <span class="n">fv</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fs</span>


<span class="k">def</span> <span class="nf">float_or_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parstore_float</span><span class="p">(</span><span class="n">thelocals</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">thelocals</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">float_or_none</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Pyrocko Developers.
    </div>
  </body>
</html>