<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.orthodrome &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    

  </head>
  <body role="document">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &#187;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyrocko.orthodrome</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="kn">from</span> <span class="nn">pyrocko.moment_tensor</span> <span class="k">import</span> <span class="n">euler_to_matrix</span>
<span class="kn">from</span> <span class="nn">pyrocko.beachball</span> <span class="k">import</span> <span class="n">spoly_cut</span>
<span class="kn">from</span> <span class="nn">pyrocko.config</span> <span class="k">import</span> <span class="n">config</span>

<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="k">import</span> <span class="n">Path</span>

<span class="n">d2r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
<span class="n">r2d</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">d2r</span>
<span class="n">earth_oblateness</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">298.257223563</span>
<span class="n">earthradius_equator</span> <span class="o">=</span> <span class="mf">6378.14</span> <span class="o">*</span> <span class="mf">1000.</span>
<span class="n">earthradius</span> <span class="o">=</span> <span class="n">config</span><span class="p">()</span><span class="o">.</span><span class="n">earthradius</span>
<span class="n">d2m</span> <span class="o">=</span> <span class="n">earthradius_equator</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
<span class="n">m2d</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">d2m</span>


<div class="viewcode-block" id="float_array_broadcast"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.float_array_broadcast">[docs]</a><span class="k">def</span> <span class="nf">float_array_broadcast</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
        <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span></div>


<div class="viewcode-block" id="Loc"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.Loc">[docs]</a><span class="k">class</span> <span class="nc">Loc</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Simple location representation</span>

<span class="sd">        :attrib lat: Latitude degree</span>
<span class="sd">        :attrib lon: Longitude degree</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="clip"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.clip">[docs]</a><span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Clipping data array ``x``</span>

<span class="sd">    :param x: Continunous data to be clipped</span>
<span class="sd">    :param mi: Clip minimum</span>
<span class="sd">    :param ma: Clip maximum</span>
<span class="sd">    :type x: :py:class:`numpy.ndarray`</span>
<span class="sd">    :type mi: float</span>
<span class="sd">    :type ma: float</span>

<span class="sd">    :return: Clipped data</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">ma</span><span class="p">)</span></div>


<div class="viewcode-block" id="wrap"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.wrap">[docs]</a><span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapping continuous data to fundamental phase values.</span>

<span class="sd">    .. math::</span>
<span class="sd">        x_{\\mathrm{wrapped}} = x_{\\mathrm{cont},i} - \</span>
<span class="sd">            \\frac{ x_{\\mathrm{cont},i} - r_{\\mathrm{min}} }\</span>
<span class="sd">                  { r_{\\mathrm{max}} -  r_{\\mathrm{min}}} \</span>
<span class="sd">            \cdot ( r_{\\mathrm{max}} -  r_{\\mathrm{min}}),\ \quad</span>
<span class="sd">        x_{\\mathrm{wrapped}}\; \in</span>
<span class="sd">            \;[ r_{\\mathrm{min}},\, r_{\\mathrm{max}}].</span>

<span class="sd">    :param x: Continunous data to be wrapped</span>
<span class="sd">    :param mi: Minimum value of wrapped data</span>
<span class="sd">    :param ma: Maximum value of wrapped data</span>
<span class="sd">    :type x: :py:class:`numpy.ndarray`</span>
<span class="sd">    :type mi: float</span>
<span class="sd">    :type ma: float</span>

<span class="sd">    :return: Wrapped data</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span><span class="o">-</span><span class="n">mi</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ma</span><span class="o">-</span><span class="n">mi</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_latlon_pair</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">lon</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">args</span>


<div class="viewcode-block" id="cosdelta"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.cosdelta">[docs]</a><span class="k">def</span> <span class="nf">cosdelta</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Cosine of the angular distance between two points ``a`` and ``b`` on</span>
<span class="sd">    a sphere.</span>

<span class="sd">    This function (find implementation below) returns the cosine of the</span>
<span class="sd">    distance angle &#39;delta&#39; between two points ``a`` and ``b``, coordinates of</span>
<span class="sd">    which are expected to be given in geographical coordinates and in degrees.</span>
<span class="sd">    For numerical stability a maximum of 1.0 is enforced.</span>

<span class="sd">    .. math::</span>

<span class="sd">        A_{\\mathrm{lat&#39;}} = \\frac{ \pi}{180} \cdot A_{lat}, \quad \</span>
<span class="sd">        A_{\\mathrm{lon&#39;}} = \\frac{ \pi}{180} \cdot A_{lon}, \quad \</span>
<span class="sd">        B_{\\mathrm{lat&#39;}} = \\frac{ \pi}{180} \cdot B_{lat}, \quad \</span>
<span class="sd">        B_{\\mathrm{lon&#39;}} = \\frac{ \pi}{180} \cdot B_{lon}\\\\[0.5cm]</span>

<span class="sd">        \\cos(\Delta) = \\min( 1.0, \quad  \\sin( A_{\\mathrm{lat&#39;}}) \</span>
<span class="sd">                     \\sin( B_{\\mathrm{lat&#39;}} ) + \</span>
<span class="sd">                     \\cos(A_{\\mathrm{lat&#39;}})  \\cos( B_{\\mathrm{lat&#39;}} ) \</span>
<span class="sd">                     \\cos( B_{\\mathrm{lon&#39;}} - A_{\\mathrm{lon&#39;}} )</span>

<span class="sd">    :param a: Location point A</span>
<span class="sd">    :type a: :py:class:`pyrocko.orthodrome.Loc`</span>
<span class="sd">    :param b: Location point B</span>
<span class="sd">    :type b: :py:class:`pyrocko.orthodrome.Loc`</span>

<span class="sd">    :return: cosdelta</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span> <span class="o">=</span> <span class="n">_latlon_pair</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span>
        <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">blat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">blat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">blon</span><span class="o">-</span><span class="n">alon</span><span class="p">)))</span></div>


<div class="viewcode-block" id="cosdelta_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.cosdelta_numpy">[docs]</a><span class="k">def</span> <span class="nf">cosdelta_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Cosine of the angular distance between two points ``a`` and ``b``</span>
<span class="sd">    on a sphere.</span>

<span class="sd">    This function returns the cosines of the distance</span>
<span class="sd">    angles *delta* between two points ``a`` and ``b`` given as</span>
<span class="sd">    :py:class:`numpy.ndarray`.</span>
<span class="sd">    The coordinates are expected to be given in geographical coordinates</span>
<span class="sd">    and in degrees. For numerical stability a maximum of ``1.0`` is enforced.</span>

<span class="sd">    Please find the details of the implementation in the documentation of</span>
<span class="sd">    the function :py:func:`pyrocko.orthodrome.cosdelta` above.</span>

<span class="sd">    :param a_lats: Latitudes (degree) point A</span>
<span class="sd">    :param a_lons: Longitudes (degree) point A</span>
<span class="sd">    :param b_lats: Latitudes (degree) point B</span>
<span class="sd">    :param b_lons: Longitudes (degree) point B</span>
<span class="sd">    :type a_lats: :py:class:`numpy.ndarray`</span>
<span class="sd">    :type a_lons: :py:class:`numpy.ndarray`</span>
<span class="sd">    :type b_lats: :py:class:`numpy.ndarray`</span>
<span class="sd">    :type b_lons: :py:class:`numpy.ndarray`</span>

<span class="sd">    :return: cosdelta</span>
<span class="sd">    :type b_lons: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
        <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">b_lons</span><span class="o">-</span><span class="n">a_lons</span><span class="p">)))</span></div>


<div class="viewcode-block" id="azimuth"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azimuth">[docs]</a><span class="k">def</span> <span class="nf">azimuth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Azimuth calculation</span>

<span class="sd">    This function (find implementation below) returns azimuth ...</span>
<span class="sd">    between points ``a`` and ``b``, coordinates of</span>
<span class="sd">    which are expected to be given in geographical coordinates and in degrees.</span>

<span class="sd">    .. math::</span>

<span class="sd">        A_{\\mathrm{lat&#39;}} = \\frac{ \pi}{180} \cdot A_{lat}, \quad \</span>
<span class="sd">        A_{\\mathrm{lon&#39;}} = \\frac{ \pi}{180} \cdot A_{lon}, \quad \</span>
<span class="sd">        B_{\\mathrm{lat&#39;}} = \\frac{ \pi}{180} \cdot B_{lat}, \quad \</span>
<span class="sd">        B_{\\mathrm{lon&#39;}} = \\frac{ \pi}{180} \cdot B_{lon}\\\\</span>

<span class="sd">        \\varphi_{\\mathrm{azi},AB} = \\frac{180}{\pi} \\arctan \left[ \\frac{\</span>
<span class="sd">                \\cos( A_{\\mathrm{lat&#39;}}) \\cos( B_{\\mathrm{lat&#39;}} ) \</span>
<span class="sd">                \\sin(B_{\\mathrm{lon&#39;}} - A_{\\mathrm{lon&#39;}} )} \</span>
<span class="sd">                {\\sin ( B_{\\mathrm{lat&#39;}} ) - \\sin( A_{\\mathrm{lat&#39;}} \</span>
<span class="sd">                  cosdelta) } \\right]</span>

<span class="sd">    :param a: Location point A</span>
<span class="sd">    :type a: :py:class:`pyrocko.orthodrome.Loc`</span>
<span class="sd">    :param b: Location point B</span>
<span class="sd">    :type b: :py:class:`pyrocko.orthodrome.Loc`</span>

<span class="sd">    :return: Azimuth in degree</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span> <span class="o">=</span> <span class="n">_latlon_pair</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r2d</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">blat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">blon</span><span class="o">-</span><span class="n">alon</span><span class="p">)),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">blat</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">alat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosdelta</span><span class="p">(</span>
            <span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span><span class="p">))</span></div>


<div class="viewcode-block" id="azimuth_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azimuth_numpy">[docs]</a><span class="k">def</span> <span class="nf">azimuth_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">,</span> <span class="n">_cosdelta</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculation of the azimuth (*track angle*) from a location A towards B.</span>

<span class="sd">    This function returns azimuths (*track angles*) from locations A towards B</span>
<span class="sd">    given in :py:class:`numpy.ndarray`. Coordinates are expected to be given in</span>
<span class="sd">    geographical coordinates and in degrees.</span>

<span class="sd">    Please find the details of the implementation in the documentation of the</span>
<span class="sd">    function :py:func:`pyrocko.orthodrome.azimuth`.</span>


<span class="sd">    :param a_lats: Latitudes (degree) point A</span>
<span class="sd">    :param a_lons: Longitudes (degree) point A</span>
<span class="sd">    :param b_lats: Latitudes (degree) point B</span>
<span class="sd">    :param b_lons: Longitudes (degree) point B</span>
<span class="sd">    :type a_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type a_lons: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lons: :py:class:`numpy.ndarray`, ``(N)``</span>

<span class="sd">    :return: Azimuths in degrees</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_cosdelta</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">_cosdelta</span> <span class="o">=</span> <span class="n">cosdelta_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r2d</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b_lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">b_lons</span><span class="o">-</span><span class="n">a_lons</span><span class="p">)),</span>
        <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">b_lats</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">a_lats</span><span class="p">)</span> <span class="o">*</span> <span class="n">_cosdelta</span><span class="p">)</span></div>


<div class="viewcode-block" id="azibazi"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azibazi">[docs]</a><span class="k">def</span> <span class="nf">azibazi</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span> <span class="o">=</span> <span class="n">_latlon_pair</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alat</span> <span class="o">==</span> <span class="n">blat</span> <span class="ow">and</span> <span class="n">alon</span> <span class="o">==</span> <span class="n">blon</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span>

    <span class="n">implementation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;implementation&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">implementation</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">implementation</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome_ext</span>
        <span class="k">return</span> <span class="n">orthodrome_ext</span><span class="o">.</span><span class="n">azibazi</span><span class="p">(</span><span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span><span class="p">)</span>

    <span class="n">cd</span> <span class="o">=</span> <span class="n">cosdelta</span><span class="p">(</span><span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span><span class="p">)</span>
    <span class="n">azi</span> <span class="o">=</span> <span class="n">r2d</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">blat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">blon</span><span class="o">-</span><span class="n">alon</span><span class="p">)),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">blat</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">alat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cd</span><span class="p">)</span>
    <span class="n">bazi</span> <span class="o">=</span> <span class="n">r2d</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">blat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alat</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="p">(</span><span class="n">alon</span><span class="o">-</span><span class="n">blon</span><span class="p">)),</span>
        <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">alat</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d2r</span><span class="o">*</span><span class="n">blat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">azi</span><span class="p">,</span> <span class="n">bazi</span></div>


<div class="viewcode-block" id="azibazi_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azibazi_numpy">[docs]</a><span class="k">def</span> <span class="nf">azibazi_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">,</span> <span class="n">implementation</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">):</span>

    <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span> <span class="o">=</span> <span class="n">float_array_broadcast</span><span class="p">(</span>
        <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">implementation</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">implementation</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome_ext</span>
        <span class="k">return</span> <span class="n">orthodrome_ext</span><span class="o">.</span><span class="n">azibazi_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>

    <span class="n">_cosdelta</span> <span class="o">=</span> <span class="n">cosdelta_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>
    <span class="n">azis</span> <span class="o">=</span> <span class="n">azimuth_numpy</span><span class="p">(</span><span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">,</span> <span class="n">_cosdelta</span><span class="p">)</span>
    <span class="n">bazis</span> <span class="o">=</span> <span class="n">azimuth_numpy</span><span class="p">(</span><span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">,</span> <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">_cosdelta</span><span class="p">)</span>

    <span class="n">eq</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">a_lats</span> <span class="o">==</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">a_lons</span> <span class="o">==</span> <span class="n">b_lons</span><span class="p">)</span>
    <span class="n">ii_eq</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">azis</span><span class="p">[</span><span class="n">ii_eq</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">bazis</span><span class="p">[</span><span class="n">ii_eq</span><span class="p">]</span> <span class="o">=</span> <span class="mf">180.0</span>
    <span class="k">return</span> <span class="n">azis</span><span class="p">,</span> <span class="n">bazis</span></div>


<div class="viewcode-block" id="azidist_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azidist_numpy">[docs]</a><span class="k">def</span> <span class="nf">azidist_numpy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculation of the azimuth (*track angle*) and the distance from</span>
<span class="sd">    locations A towards B on a sphere.</span>

<span class="sd">    The assisting functions used are :py:func:`pyrocko.orthodrome.cosdelta` and</span>
<span class="sd">    :py:func:`pyrocko.orthodrome.azimuth`</span>

<span class="sd">    :param a_lats: Latitudes (degree) point A</span>
<span class="sd">    :param a_lons: Longitudes (degree) point A</span>
<span class="sd">    :param b_lats: Latitudes (degree) point B</span>
<span class="sd">    :param b_lons: Longitudes (degree) point B</span>
<span class="sd">    :type a_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type a_lons: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lons: :py:class:`numpy.ndarray`, ``(N)``</span>

<span class="sd">    :return: Azimuths in degrees, distances in degrees</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_cosdelta</span> <span class="o">=</span> <span class="n">cosdelta_numpy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">_azimuths</span> <span class="o">=</span> <span class="n">azimuth_numpy</span><span class="p">(</span><span class="n">_cosdelta</span><span class="o">=</span><span class="n">_cosdelta</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_azimuths</span><span class="p">,</span> <span class="n">r2d</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">_cosdelta</span><span class="p">)</span></div>


<div class="viewcode-block" id="distance_accurate50m"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.distance_accurate50m">[docs]</a><span class="k">def</span> <span class="nf">distance_accurate50m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Accurate distance calculation based on a spheroid of rotation.</span>

<span class="sd">    Function returns distance in meter between points A and B, coordinates of</span>
<span class="sd">    which must be given in geographical coordinates and in degrees.</span>
<span class="sd">    The returned distance should be accurate to 50\,m using WGS84.</span>
<span class="sd">    Values for the Earth&#39;s equator radius and the Earth&#39;s oblateness</span>
<span class="sd">    (``f_oblate``) are defined in the pyrocko configuration file</span>
<span class="sd">    :py:class:`pyrocko.config`.</span>

<span class="sd">    From wikipedia (http://de.wikipedia.org/wiki/Orthodrome), based on:</span>

<span class="sd">    ``Meeus, J.: Astronomical Algorithms, S 85, Willmann-Bell,</span>
<span class="sd">    Richmond 2000 (2nd ed., 2nd printing), ISBN 0-943396-61-1``</span>

<span class="sd">    .. math::</span>

<span class="sd">        F = \\frac{\pi}{180} \</span>
<span class="sd">                            \\frac{(A_{lat} + B_{lat})}{2}, \quad \</span>
<span class="sd">        G = \\frac{\pi}{180}  \</span>
<span class="sd">                            \\frac{(A_{lat} - B_{lat})}{2}, \quad \</span>
<span class="sd">        l = \\frac{\pi}{180} \</span>
<span class="sd">                            \\frac{(A_{lon} - B_{lon})}{2} \quad \</span>
<span class="sd">        \\\\[0.5cm]</span>
<span class="sd">        S = \\sin^2(G) \\cdot \\cos^2(l) + \</span>
<span class="sd">              \\cos^2(F) \\cdot \\sin^2(l), \quad \quad</span>
<span class="sd">        C = \\cos^2(G) \\cdot \\cos^2(l) + \</span>
<span class="sd">                  \\sin^2(F) \\cdot \\sin^2(l)</span>

<span class="sd">    .. math::</span>

<span class="sd">        w = \\arctan \\left( \\sqrt{ \\frac{S}{C}} \\right) , \quad \</span>
<span class="sd">        r =  \\sqrt{\\frac{S}{C} }</span>

<span class="sd">    The spherical-earth distance D between A and B, can be given with:</span>

<span class="sd">    .. math::</span>

<span class="sd">        D_{sphere} = 2w \cdot R_{equator}</span>

<span class="sd">    The oblateness of the Earth requires some correction with</span>
<span class="sd">    correction factors h1 and h2:</span>

<span class="sd">     .. math::</span>

<span class="sd">        h_1 = \\frac{3r - 1}{2C}, \quad \</span>
<span class="sd">        h_2 = \\frac{3r +1 }{2S}\\\\[0.5cm]</span>

<span class="sd">        D = D_{\\mathrm{sphere}} \cdot [ 1 + h_1 \,f_{\\mathrm{oblate}} \</span>
<span class="sd">                 \cdot \\sin^2(F) \</span>
<span class="sd">                 \\cos^2(G) - h_2\, f_{\\mathrm{oblate}} \</span>
<span class="sd">                 \cdot \\cos^2(F) \\sin^2(G)]</span>


<span class="sd">    :param a: Location point A</span>
<span class="sd">    :type a: :py:class:`pyrocko.orthodrome.Loc`</span>
<span class="sd">    :param b: Location point B</span>
<span class="sd">    :type b: :py:class:`pyrocko.orthodrome.Loc`</span>

<span class="sd">    :return: Distance in meter</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span> <span class="o">=</span> <span class="n">_latlon_pair</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">implementation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;implementation&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">implementation</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">implementation</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome_ext</span>
        <span class="k">return</span> <span class="n">orthodrome_ext</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">alat</span><span class="p">,</span> <span class="n">alon</span><span class="p">,</span> <span class="n">blat</span><span class="p">,</span> <span class="n">blon</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">alat</span> <span class="o">+</span> <span class="n">blat</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">alat</span> <span class="o">-</span> <span class="n">blat</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">alon</span> <span class="o">-</span> <span class="n">blon</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">c</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="n">w</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">earthradius_equator</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">r</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span>
                <span class="n">earth_oblateness</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
                <span class="n">earth_oblateness</span> <span class="o">*</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="distance_accurate50m_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.distance_accurate50m_numpy">[docs]</a><span class="k">def</span> <span class="nf">distance_accurate50m_numpy</span><span class="p">(</span>
        <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">,</span> <span class="n">implementation</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Accurate distance calculation based on a spheroid of rotation.</span>

<span class="sd">    Function returns distance in meter between points ``a`` and ``b``,</span>
<span class="sd">    coordinates of which must be given in geographical coordinates and in</span>
<span class="sd">    degrees.</span>
<span class="sd">    The returned distance should be accurate to 50\,m using WGS84.</span>
<span class="sd">    Values for the Earth&#39;s equator radius and the Earth&#39;s oblateness</span>
<span class="sd">    (``f_oblate``) are defined in the pyrocko configuration file</span>
<span class="sd">    :py:class:`pyrocko.config`.</span>

<span class="sd">    From wikipedia (http://de.wikipedia.org/wiki/Orthodrome), based on:</span>

<span class="sd">    ``Meeus, J.: Astronomical Algorithms, S 85, Willmann-Bell,</span>
<span class="sd">    Richmond 2000 (2nd ed., 2nd printing), ISBN 0-943396-61-1``</span>

<span class="sd">    .. math::</span>

<span class="sd">        F_i = \\frac{\pi}{180} \</span>
<span class="sd">                           \\frac{(a_{lat,i} + a_{lat,i})}{2}, \quad \</span>
<span class="sd">        G_i = \\frac{\pi}{180}  \</span>
<span class="sd">                           \\frac{(a_{lat,i} - b_{lat,i})}{2}, \quad \</span>
<span class="sd">        l_i= \\frac{\pi}{180} \</span>
<span class="sd">                            \\frac{(a_{lon,i} - b_{lon,i})}{2} \\\\[0.5cm]</span>
<span class="sd">        S_i = \\sin^2(G_i) \\cdot \\cos^2(l_i) + \</span>
<span class="sd">              \\cos^2(F_i) \\cdot \\sin^2(l_i), \quad \quad</span>
<span class="sd">        C_i = \\cos^2(G_i) \\cdot \\cos^2(l_i) + \</span>
<span class="sd">                  \\sin^2(F_i) \\cdot \\sin^2(l_i)</span>

<span class="sd">    .. math::</span>

<span class="sd">        w_i = \\arctan \\left( \\sqrt{\\frac{S_i}{C_i}} \\right), \quad \</span>
<span class="sd">        r_i =  \\sqrt{\\frac{S_i}{C_i} }</span>

<span class="sd">    The spherical-earth distance ``D`` between ``a`` and ``b``,</span>
<span class="sd">    can be given with:</span>

<span class="sd">    .. math::</span>

<span class="sd">        D_{\\mathrm{sphere},i} = 2w_i \cdot R_{\\mathrm{equator}}</span>

<span class="sd">    The oblateness of the Earth requires some correction with</span>
<span class="sd">    correction factors ``h1`` and ``h2``:</span>

<span class="sd">     .. math::</span>

<span class="sd">        h_{1.i} = \\frac{3r - 1}{2C_i}, \quad \</span>
<span class="sd">        h_{2,i} = \\frac{3r +1 }{2S_i}\\\\[0.5cm]</span>

<span class="sd">        D_{AB,i} = D_{\\mathrm{sphere},i} \cdot [1 + h_{1,i}</span>
<span class="sd">            \,f_{\\mathrm{oblate}} \</span>
<span class="sd">            \cdot \\sin^2(F_i) \</span>
<span class="sd">            \\cos^2(G_i) - h_{2,i}\, f_{\\mathrm{oblate}} \</span>
<span class="sd">            \cdot \\cos^2(F_i) \\sin^2(G_i)]</span>

<span class="sd">    :param a_lats: Latitudes (degree) point A</span>
<span class="sd">    :param a_lons: Longitudes (degree) point A</span>
<span class="sd">    :param b_lats: Latitudes (degree) point B</span>
<span class="sd">    :param b_lons: Longitudes (degree) point B</span>
<span class="sd">    :type a_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type a_lons: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type b_lons: :py:class:`numpy.ndarray`, ``(N)``</span>

<span class="sd">    :return: Distances in degrees</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span> <span class="o">=</span> <span class="n">float_array_broadcast</span><span class="p">(</span>
        <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">implementation</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">implementation</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome_ext</span>
        <span class="k">return</span> <span class="n">orthodrome_ext</span><span class="o">.</span><span class="n">distance_accurate50m_numpy</span><span class="p">(</span>
            <span class="n">a_lats</span><span class="p">,</span> <span class="n">a_lons</span><span class="p">,</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">b_lons</span><span class="p">)</span>

    <span class="n">eq</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">a_lats</span> <span class="o">==</span> <span class="n">b_lats</span><span class="p">,</span> <span class="n">a_lons</span> <span class="o">==</span> <span class="n">b_lons</span><span class="p">)</span>
    <span class="n">ii_neq</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">eq</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">eq</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">ii_neq</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="n">a_lats</span> <span class="o">=</span> <span class="n">extr</span><span class="p">(</span><span class="n">a_lats</span><span class="p">)</span>
    <span class="n">a_lons</span> <span class="o">=</span> <span class="n">extr</span><span class="p">(</span><span class="n">a_lons</span><span class="p">)</span>
    <span class="n">b_lats</span> <span class="o">=</span> <span class="n">extr</span><span class="p">(</span><span class="n">b_lats</span><span class="p">)</span>
    <span class="n">b_lons</span> <span class="o">=</span> <span class="n">extr</span><span class="p">(</span><span class="n">b_lons</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_lats</span> <span class="o">+</span> <span class="n">b_lats</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_lats</span> <span class="o">-</span> <span class="n">b_lats</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_lons</span> <span class="o">-</span> <span class="n">b_lons</span><span class="p">)</span><span class="o">*</span><span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">c</span><span class="p">))</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="n">w</span>

    <span class="n">d</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">earthradius_equator</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">r</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">r</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">dists</span><span class="p">[</span><span class="n">ii_neq</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="p">(</span>
        <span class="mf">1.</span> <span class="o">+</span>
        <span class="n">earth_oblateness</span> <span class="o">*</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>
        <span class="n">earth_oblateness</span> <span class="o">*</span> <span class="n">h2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dists</span></div>


<div class="viewcode-block" id="ne_to_latlon"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.ne_to_latlon">[docs]</a><span class="k">def</span> <span class="nf">ne_to_latlon</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">north_m</span><span class="p">,</span> <span class="n">east_m</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Transform local cartesian coordinates to latitude and longitude.</span>

<span class="sd">    From east and north coordinates (``x`` and ``y`` coordinate</span>
<span class="sd">    :py:class:`numpy.ndarray`)  relative to a reference differences in</span>
<span class="sd">    longitude and latitude are calculated, which are effectively changes in</span>
<span class="sd">    azimuth and distance, respectively:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\text{distance change:}\; \Delta {\\bf{a}} &amp;= \sqrt{{\\bf{y}}^2 + \</span>
<span class="sd">                                           {\\bf{x}}^2 }/ \mathrm{R_E},</span>

<span class="sd">        \\text{azimuth change:}\; \Delta \\bf{\gamma} &amp;= \\arctan( \\bf{x}  \</span>
<span class="sd">                                                         / \\bf{y}).</span>

<span class="sd">    The projection used preserves the azimuths of the input points.</span>

<span class="sd">    :param lat0: Latitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param lon0: Longitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param north_m: Northing distances from origin in meters.</span>
<span class="sd">    :param east_m: Easting distances from origin in meters.</span>
<span class="sd">    :type north_m: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type east_m: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type lat0: float</span>
<span class="sd">    :type lon0: float</span>

<span class="sd">    :return: Array with latitudes and longitudes</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">north_m</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">east_m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">config</span><span class="p">()</span><span class="o">.</span><span class="n">earthradius</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">east_m</span><span class="p">,</span> <span class="n">north_m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">azidist_to_latlon_rad</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="azidist_to_latlon"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azidist_to_latlon">[docs]</a><span class="k">def</span> <span class="nf">azidist_to_latlon</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">azimuth_deg</span><span class="p">,</span> <span class="n">distance_deg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;(Durchreichen??).</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">azidist_to_latlon_rad</span><span class="p">(</span>
        <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">azimuth_deg</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">distance_deg</span><span class="o">/</span><span class="mf">180.</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></div>


<div class="viewcode-block" id="azidist_to_latlon_rad"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.azidist_to_latlon_rad">[docs]</a><span class="k">def</span> <span class="nf">azidist_to_latlon_rad</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">azimuth_rad</span><span class="p">,</span> <span class="n">distance_rad</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Absolute latitudes and longitudes are calculated from relative changes.</span>

<span class="sd">    For numerical stability a range between of ``-1.0`` and ``1.0`` is</span>
<span class="sd">    enforced for ``c`` and ``alpha``.</span>

<span class="sd">    .. math::</span>

<span class="sd">        \Delta {\\bf a}_i \; \\text{and} \; \Delta \gamma_i \; \</span>
<span class="sd">            \\text{are relative distances and azimuths from lat0 and lon0 for \</span>
<span class="sd">                \\textit{i} source points of a finite source.}</span>

<span class="sd">    .. math::</span>

<span class="sd">        \mathrm{b} &amp;= \\frac{\pi}{2} -\\frac{\pi}{180} \;\mathrm{lat_0}\\\\</span>
<span class="sd">        {\\bf c}_i &amp;=\\arccos[\; \cos(\Delta {\\bf{a}}_i) \cos(\mathrm{b}) \</span>
<span class="sd">              + |\Delta \gamma_i| \,\sin(\Delta {\\bf a}_i)</span>
<span class="sd">                \sin(\mathrm{b})\; ] \\\\</span>
<span class="sd">        \mathrm{lat}_i &amp;=  \\frac{180}{\pi}  \</span>
<span class="sd">                          \\left(\\frac{\pi}{2} - {\\bf c}_i \\right)</span>

<span class="sd">    .. math::</span>

<span class="sd">         \\alpha_i &amp;= \\arcsin \\left[ \; \\frac{ \sin(\Delta {\\bf a}_i ) \</span>
<span class="sd">                         \sin(|\Delta \\gamma_i|)}{\sin({\\bf c}_i)}\;</span>
<span class="sd">                         \\right] \\\\</span>
<span class="sd">        \\alpha_i &amp;= \\begin{cases}</span>
<span class="sd">                 \\alpha_i, &amp;\\text{if}  \; \cos(\Delta {\\bf a}_i) - \</span>
<span class="sd">                 \cos(\mathrm{b}) \cos({\\bf{c}}_i) &gt; 0, \; \</span>
<span class="sd">                 \\text{else} \\\\</span>
<span class="sd">                 \pi - \\alpha_i, &amp; \\text{if} \; \\alpha_i &gt; 0,\;</span>
<span class="sd">                 \\text{else}\\\\</span>
<span class="sd">                -\pi - \\alpha_i, &amp; \\text{if} \; \\alpha_i &lt; 0.</span>
<span class="sd">                \\end{cases} \\\\</span>
<span class="sd">        \mathrm{lon}_i &amp;=   \mathrm{lon_0} + \</span>
<span class="sd">             \\frac{180}{\pi} \, \\frac{\Delta \gamma_i }{|\Delta \gamma_i|} \</span>
<span class="sd">                            \cdot \\alpha_i  \</span>
<span class="sd">                             \\text{, with $\\alpha_i \\in [-\pi,\pi]$}</span>

<span class="sd">    :param lat0: Latitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param lon0: Longitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param distance_rad: Distances from origin in radians.</span>
<span class="sd">    :param azimuth_rad: Azimuth from radians.</span>
<span class="sd">    :type distance_rad: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type azimuth_rad: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type lat0: float</span>
<span class="sd">    :type lon0: float</span>

<span class="sd">    :return: Array with latitudes and longitudes</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">distance_rad</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">azimuth_rad</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="o">-</span><span class="n">lat0</span><span class="o">*</span><span class="n">d2r</span>

    <span class="n">alphasign</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">alphasign</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">alpha</span><span class="p">),</span>
        <span class="n">alpha</span><span class="p">)</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">r2d</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">lon0</span> <span class="o">+</span> <span class="n">r2d</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">alphasign</span><span class="p">,</span> <span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="ne_to_latlon_alternative_method"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.ne_to_latlon_alternative_method">[docs]</a><span class="k">def</span> <span class="nf">ne_to_latlon_alternative_method</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">north_m</span><span class="p">,</span> <span class="n">east_m</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Transform local cartesian coordinates to latitude and longitude.</span>

<span class="sd">    Like :py:func:`pyrocko.orthodrome.ne_to_latlon`,</span>
<span class="sd">    but this method (implementation below), although it should be numerically</span>
<span class="sd">    more stable, suffers problems at points which are *across the pole*</span>
<span class="sd">    as seen from the cartesian origin.</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\text{distance change:}\; \Delta {{\\bf a}_i} &amp;=\sqrt{{\\bf{y}}^2_i +</span>
<span class="sd">                                        {\\bf{x}}^2_i }/ \mathrm{R_E},\\\\</span>
<span class="sd">        \\text{azimuth change:}\; \Delta {\\bf \gamma}_i &amp;=</span>
<span class="sd">                                        \\arctan( {\\bf x}_i {\\bf y}_i). \\\\</span>
<span class="sd">        \mathrm{b} &amp;= \\frac{\pi}{2} -\\frac{\pi}{180} \;\mathrm{lat_0}\\\\</span>

<span class="sd">    .. math::</span>

<span class="sd">        {{\\bf z}_1}_i &amp;= \\cos{\\left( \\frac{\Delta {\\bf a}_i - \</span>
<span class="sd">                            \\mathrm{b}}{2} \\right)} \</span>
<span class="sd">                            \\cos {\\left( \\frac{|\gamma_i|}{2} \\right) }\\\\</span>
<span class="sd">        {{\\bf n}_1}_i &amp;= \\cos{\\left( \\frac{\Delta {\\bf a}_i + \</span>
<span class="sd">                            \\mathrm{b}}{2} \\right)}\</span>
<span class="sd">                            \\sin {\\left( \\frac{|\gamma_i|}{2} \\right) }\\\\</span>
<span class="sd">        {{\\bf z}_2}_i &amp;= \\sin{\\left( \\frac{\Delta {\\bf a}_i - \</span>
<span class="sd">                            \\mathrm{b}}{2} \\right)}\</span>
<span class="sd">                            \\cos {\\left( \\frac{|\gamma_i|}{2} \\right) }\\\\</span>
<span class="sd">        {{\\bf n}_2}_i &amp;= \\sin{\\left( \\frac{\Delta {\\bf a}_i + \</span>
<span class="sd">                            \\mathrm{b}}{2} \\right)}\</span>
<span class="sd">                            \\sin {\\left( \\frac{|\gamma_i|}{2} \\right) }\\\\</span>
<span class="sd">        {{\\bf t}_1}_i &amp;= \\arctan{\\left( \\frac{{{\\bf z}_1}_i} \</span>
<span class="sd">                                    {{{\\bf n}_1}_i} \\right) }\\\\</span>
<span class="sd">        {{\\bf t}_2}_i &amp;= \\arctan{\\left( \\frac{{{\\bf z}_2}_i} \</span>
<span class="sd">                                    {{{\\bf n}_2}_i} \\right) } \\\\[0.5cm]</span>
<span class="sd">        c &amp;= \\begin{cases}</span>
<span class="sd">              2 \cdot \\arccos \\left( {{\\bf z}_1}_i / \\sin({{\\bf t}_1}_i) \</span>
<span class="sd">                              \\right),\; \\text{if } \</span>
<span class="sd">                              |\\sin({{\\bf t}_1}_i)| &gt; \</span>
<span class="sd">                                |\\sin({{\\bf t}_2}_i)|,\; \\text{else} \\\\</span>
<span class="sd">              2 \cdot \\arcsin{\\left( {{\\bf z}_2}_i / \</span>
<span class="sd">                                 \\sin({{\\bf t}_2}_i) \\right)}.</span>
<span class="sd">             \\end{cases}\\\\</span>

<span class="sd">    .. math::</span>

<span class="sd">        {\\bf {lat}}_i  &amp;= \\frac{180}{ \pi } \\left( \\frac{\pi}{2} \</span>
<span class="sd">                                              - {\\bf {c}}_i \\right) \\\\</span>
<span class="sd">        {\\bf {lon}}_i &amp;=  {\\bf {lon}}_0 + \\frac{180}{ \pi } \</span>
<span class="sd">                                      \\frac{\gamma_i}{|\gamma_i|}, \</span>
<span class="sd">                                     \\text{ with}\; \gamma \\in [-\pi,\pi]</span>

<span class="sd">    :param lat0: Latitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param lon0: Longitude origin of the cartesian coordinate system.</span>
<span class="sd">    :param north_m: Northing distances from origin in meters.</span>
<span class="sd">    :param east_m: Easting distances from origin in meters.</span>
<span class="sd">    :type north_m: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type east_m: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type lat0: float</span>
<span class="sd">    :type lon0: float</span>

<span class="sd">    :return: Array with latitudes and longitudes</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="o">-</span><span class="n">lat0</span><span class="o">*</span><span class="n">d2r</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">north_m</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">east_m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">config</span><span class="p">()</span><span class="o">.</span><span class="n">earthradius</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">east_m</span><span class="p">,</span> <span class="n">north_m</span><span class="p">)</span>
    <span class="n">alphasign</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">alphasign</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gamma</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

    <span class="n">z1</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">z2</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>

    <span class="n">sin_t1</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">sin_t2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sin_t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sin_t2</span><span class="p">),</span>
        <span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z1</span><span class="o">/</span><span class="n">sin_t1</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">,</span>
        <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">z2</span><span class="o">/</span><span class="n">sin_t2</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">)</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">r2d</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">lon0</span> <span class="o">+</span> <span class="n">r2d</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">alphasign</span><span class="p">,</span> <span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span></div>


<div class="viewcode-block" id="latlon_to_ne"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.latlon_to_ne">[docs]</a><span class="k">def</span> <span class="nf">latlon_to_ne</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Relative cartesian coordinates with respect to a reference location.</span>

<span class="sd">    For two locations, a reference location A and another location B, given in</span>
<span class="sd">    geographical coordinates in degrees, the corresponding cartesian</span>
<span class="sd">    coordinates are calculated.</span>
<span class="sd">    Assisting functions are :py:func:`pyrocko.orthodrome.azimuth&#39; and</span>
<span class="sd">    :py:func:`pyrocko.orthodrome.distance_accurate50m`</span>

<span class="sd">    .. math::</span>

<span class="sd">        D_{AB} &amp;= \\mathrm{distance\\_accurate50m(}A, B \\mathrm{)}, \quad \</span>
<span class="sd">                        \\varphi_{\\mathrm{azi},AB} = \\mathrm{azimuth(}A,B \</span>
<span class="sd">                            \\mathrm{)}\\\\[0.3cm]</span>

<span class="sd">        n &amp;= D_{AB} \cdot \\cos( \\frac{\pi }{180} \</span>
<span class="sd">                                    \\varphi_{\\mathrm{azi},AB} )\\\\</span>
<span class="sd">        e &amp;= D_{AB} \cdot \\sin( \\frac{\pi }{180} \\varphi_{\\mathrm{azi},AB})</span>

<span class="sd">    :param refloc: Location reference point</span>
<span class="sd">    :type refloc: :py:class:`pyrocko.orthodrome.Loc`</span>
<span class="sd">    :param loc: Location of interest</span>
<span class="sd">    :type loc: :py:class:`pyrocko.orthodrome.Loc`</span>

<span class="sd">    :return: Northing and easting from refloc to location</span>
<span class="sd">    :rtype: tuple, float</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">azi</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">distance_accurate50m</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span></div>


<div class="viewcode-block" id="latlon_to_ne_numpy"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.latlon_to_ne_numpy">[docs]</a><span class="k">def</span> <span class="nf">latlon_to_ne_numpy</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Relative cartesian coordinates with respect to a reference location.</span>

<span class="sd">    For two locations, a reference location (``lat0``, ``lon0``) and another</span>
<span class="sd">    location B, given in geographical coordinates in degrees,</span>
<span class="sd">    the corresponding cartesian coordinates are calculated.</span>
<span class="sd">    Assisting functions are :py:func:`azimuth`</span>
<span class="sd">    and :py:func:`distance_accurate50m`.</span>

<span class="sd">    :param lat0: reference location latitude</span>
<span class="sd">    :param lon0: reference location longitude</span>
<span class="sd">    :param lat: absolute location latitude</span>
<span class="sd">    :param lon: absolute location longitude</span>

<span class="sd">    :return: ``(n, e)``: relative north and east positions</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>

<span class="sd">    Implemented formulations:</span>

<span class="sd">       .. math::</span>

<span class="sd">           D_{AB} &amp;= \\mathrm{distance\\_accurate50m(}A, B \\mathrm{)}, \quad \</span>
<span class="sd">           \\varphi_{\\mathrm{azi},AB} = \\mathrm{azimuth(}A,B \</span>
<span class="sd">                                                \\mathrm{)}\\\\[0.3cm]</span>

<span class="sd">           n &amp;= D_{AB} \cdot \\cos( \\frac{\pi }{180} \\varphi_{ \</span>
<span class="sd">                                                \\mathrm{azi},AB} )\\\\</span>
<span class="sd">           e &amp;= D_{AB} \cdot \\sin( \\frac{\pi }{180} \\varphi_{ \</span>
<span class="sd">                                                \\mathrm{azi},AB} )</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">azi</span> <span class="o">=</span> <span class="n">azimuth_numpy</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">distance_accurate50m_numpy</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azi</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span></div>


<span class="n">_wgs84</span> <span class="o">=</span> <span class="k">None</span>


<div class="viewcode-block" id="get_wgs84"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.get_wgs84">[docs]</a><span class="k">def</span> <span class="nf">get_wgs84</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_wgs84</span>
    <span class="k">if</span> <span class="n">_wgs84</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">geographiclib.geodesic</span> <span class="k">import</span> <span class="n">Geodesic</span>
        <span class="n">_wgs84</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">WGS84</span>

    <span class="k">return</span> <span class="n">_wgs84</span></div>


<div class="viewcode-block" id="amap"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.amap">[docs]</a><span class="k">def</span> <span class="nf">amap</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="k">None</span><span class="p">,))</span>
                <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">ops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">(</span><span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ops</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                    <span class="n">ops</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="n">ops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">ops</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

                <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">it</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">func</span>
    <span class="k">return</span> <span class="n">wrap</span></div>


<span class="nd">@amap</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<div class="viewcode-block" id="ne_to_latlon2"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.ne_to_latlon2">[docs]</a><span class="k">def</span> <span class="nf">ne_to_latlon2</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">north_m</span><span class="p">,</span> <span class="n">east_m</span><span class="p">):</span>
    <span class="n">wgs84</span> <span class="o">=</span> <span class="n">get_wgs84</span><span class="p">()</span>
    <span class="n">az</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">east_m</span><span class="p">,</span> <span class="n">north_m</span><span class="p">)</span><span class="o">*</span><span class="n">r2d</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">east_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">north_m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">wgs84</span><span class="o">.</span><span class="n">Direct</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;lat2&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;lon2&#39;</span><span class="p">]</span></div>


<span class="nd">@amap</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<div class="viewcode-block" id="latlon_to_ne2"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.latlon_to_ne2">[docs]</a><span class="k">def</span> <span class="nf">latlon_to_ne2</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">):</span>
    <span class="n">wgs84</span> <span class="o">=</span> <span class="n">get_wgs84</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">wgs84</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;s12&#39;</span><span class="p">]</span>
    <span class="n">az</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;azi1&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span></div>


<span class="nd">@amap</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<div class="viewcode-block" id="distance_accurate15nm"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.distance_accurate15nm">[docs]</a><span class="k">def</span> <span class="nf">distance_accurate15nm</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">):</span>
    <span class="n">wgs84</span> <span class="o">=</span> <span class="n">get_wgs84</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wgs84</span><span class="o">.</span><span class="n">Inverse</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">)[</span><span class="s">&#39;s12&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="positive_region"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.positive_region">[docs]</a><span class="k">def</span> <span class="nf">positive_region</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Normalize parameterization of a rectangular geographical region.</span>

<span class="sd">    :param region: ``(west, east, south, north)``</span>
<span class="sd">    :returns: ``(west, east, south, north)``, where ``west &lt;= east`` and</span>
<span class="sd">        where ``west`` and ``east`` are in the range ``[-180., 180.+360.[``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">region</span><span class="p">]</span>

    <span class="k">assert</span> <span class="o">-</span><span class="mf">180.</span> <span class="o">-</span> <span class="mf">360.</span> <span class="o">&lt;=</span> <span class="n">west</span> <span class="o">&lt;</span> <span class="mf">180.</span>
    <span class="k">assert</span> <span class="o">-</span><span class="mf">180.</span> <span class="o">&lt;</span> <span class="n">east</span> <span class="o">&lt;=</span> <span class="mf">180.</span> <span class="o">+</span> <span class="mf">360.</span>
    <span class="k">assert</span> <span class="o">-</span><span class="mf">90.</span> <span class="o">&lt;=</span> <span class="n">south</span> <span class="o">&lt;</span> <span class="mf">90.</span>
    <span class="k">assert</span> <span class="o">-</span><span class="mf">90.</span> <span class="o">&lt;</span> <span class="n">north</span> <span class="o">&lt;=</span> <span class="mf">90.</span>

    <span class="k">if</span> <span class="n">east</span> <span class="o">&lt;</span> <span class="n">west</span><span class="p">:</span>
        <span class="n">east</span> <span class="o">+=</span> <span class="mf">360.</span>

    <span class="k">if</span> <span class="n">west</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">180.</span><span class="p">:</span>
        <span class="n">west</span> <span class="o">+=</span> <span class="mf">360.</span>
        <span class="n">east</span> <span class="o">+=</span> <span class="mf">360.</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">)</span></div>


<div class="viewcode-block" id="points_in_region"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.points_in_region">[docs]</a><span class="k">def</span> <span class="nf">points_in_region</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check what points are contained in a rectangular geographical region.</span>

<span class="sd">    :param p: NumPy array of shape ``(N, 2)`` where each row is a</span>
<span class="sd">        ``(lat, lon)`` pair [deg]</span>
<span class="sd">    :param region: ``(west, east, south, north)`` [deg]</span>
<span class="sd">    :returns: NumPy array of shape ``(N)``, type ``bool``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">positive_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">),</span>
        <span class="n">num</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">),</span>
            <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mf">360.</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">-</span><span class="mf">360.</span><span class="p">)))</span></div>


<div class="viewcode-block" id="point_in_region"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.point_in_region">[docs]</a><span class="k">def</span> <span class="nf">point_in_region</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check if a point is contained in a rectangular geographical region.</span>

<span class="sd">    :param p: ``(lat, lon)`` [deg]</span>
<span class="sd">    :param region: ``(west, east, south, north)`` [deg]</span>
<span class="sd">    :returns: ``bool``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">positive_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">),</span>
        <span class="n">num</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">),</span>
            <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mf">360.</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">-</span><span class="mf">360.</span><span class="p">)))</span></div>


<div class="viewcode-block" id="radius_to_region"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.radius_to_region">[docs]</a><span class="k">def</span> <span class="nf">radius_to_region</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get a rectangular region which fully contains a given circular region.</span>

<span class="sd">    :param lat,lon: center of circular region [deg]</span>
<span class="sd">    :param radius: radius of circular region [m]</span>
<span class="sd">    :return: rectangular region as ``(east, west, south, north)`` [deg]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">radius_deg</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">m2d</span>
    <span class="k">if</span> <span class="n">radius_deg</span> <span class="o">&lt;</span> <span class="mf">45.</span><span class="p">:</span>
        <span class="n">lat_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="n">lat</span> <span class="o">-</span> <span class="n">radius_deg</span><span class="p">)</span>
        <span class="n">lat_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">90.</span><span class="p">,</span> <span class="n">lat</span> <span class="o">+</span> <span class="n">radius_deg</span><span class="p">)</span>
        <span class="n">absmaxlat</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat_min</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_max</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">absmaxlat</span> <span class="o">&gt;</span> <span class="mi">89</span><span class="p">:</span>
            <span class="n">lon_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.</span>
            <span class="n">lon_max</span> <span class="o">=</span> <span class="mf">180.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lon_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="o">-</span><span class="mf">180.</span> <span class="o">-</span> <span class="mf">360.</span><span class="p">,</span>
                <span class="n">lon</span> <span class="o">-</span> <span class="n">radius_deg</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">absmaxlat</span><span class="o">*</span><span class="n">d2r</span><span class="p">))</span>
            <span class="n">lon_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="mf">180.</span> <span class="o">+</span> <span class="mf">360.</span><span class="p">,</span>
                <span class="n">lon</span> <span class="o">+</span> <span class="n">radius_deg</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">absmaxlat</span><span class="o">*</span><span class="n">d2r</span><span class="p">))</span>

        <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">positive_region</span><span class="p">(</span>
            <span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">None</span></div>


<div class="viewcode-block" id="geographic_midpoint"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.geographic_midpoint">[docs]</a><span class="k">def</span> <span class="nf">geographic_midpoint</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate geographic midpoints by finding the center of gravity.</span>

<span class="sd">    This method suffers from instabilities if points are centered around the</span>
<span class="sd">    poles.</span>

<span class="sd">    :param lats: array of latitudes</span>
<span class="sd">    :param lons: array of longitudes</span>
<span class="sd">    :param weights: array weighting factors (optional)</span>
<span class="sd">    :type lats: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type lons: :py:class:`numpy.ndarray`, ``(N)``</span>
<span class="sd">    :type weights: :py:class:`numpy.ndarray`, ``(N)``</span>

<span class="sd">    :return: Latitudes and longitudes of the modpoints</span>
<span class="sd">    :rtype: :py:class:`numpy.ndarray`, ``(2xN)``</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">weights</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span>

    <span class="n">total_weigth</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">/=</span> <span class="n">total_weigth</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">lats</span> <span class="o">*</span> <span class="n">d2r</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">lons</span> <span class="o">*</span> <span class="n">d2r</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span>

    <span class="n">lon</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">hyp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">hyp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lat</span><span class="o">/</span><span class="n">d2r</span><span class="p">,</span> <span class="n">lon</span><span class="o">/</span><span class="n">d2r</span></div>


<div class="viewcode-block" id="geodetic_to_ecef"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.geodetic_to_ecef">[docs]</a><span class="k">def</span> <span class="nf">geodetic_to_ecef</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert geodetic coordinates to Earth-Centered, Earth-Fixed (ECEF)</span>
<span class="sd">    Cartesian coordinates.</span>

<span class="sd">    :param lat: Geodetic latitude in [deg].</span>
<span class="sd">    :param lon: Geodetic longitude in [deg].</span>
<span class="sd">    :param alt: Geodetic altitude (height) in [m] (positive for points outside</span>
<span class="sd">        the geoid).</span>
<span class="sd">    :type lat: float</span>
<span class="sd">    :type lon: float</span>
<span class="sd">    :type alt: float</span>

<span class="sd">    :return: ECEF Cartesian coordinates (X, Y, Z) in [m].</span>
<span class="sd">    :rtype: tuple, float</span>

<span class="sd">    .. [#1] https://en.wikipedia.org/wiki/ECEF</span>
<span class="sd">    .. [#2] https://en.wikipedia.org/wiki/Geographic_coordinate_conversion</span>
<span class="sd">        #From_geodetic_to_ECEF_coordinates</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wgs</span> <span class="o">=</span> <span class="n">get_wgs84</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">wgs</span><span class="o">.</span><span class="n">a</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">wgs</span><span class="o">.</span><span class="n">f</span> <span class="o">-</span> <span class="n">wgs</span><span class="o">.</span><span class="n">f</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="c"># Normal (plumb line)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">e2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span> <span class="o">+</span> <span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span></div>


<div class="viewcode-block" id="ecef_to_geodetic"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.ecef_to_geodetic">[docs]</a><span class="k">def</span> <span class="nf">ecef_to_geodetic</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert Earth-Centered, Earth-Fixed (ECEF) Cartesian coordinates to</span>
<span class="sd">    geodetic coordinates (Ferrari&#39;s solution).</span>

<span class="sd">    :param X, Y, Z: Cartesian coordinates in ECEF system in [m].</span>
<span class="sd">    :type X, Y, Z: float</span>

<span class="sd">    :return: Geodetic coordinates (lat, lon, alt). Latitude and longitude are</span>
<span class="sd">        in [deg] and altitude is in [m]</span>
<span class="sd">        (positive for points outside the geoid).</span>
<span class="sd">    :rtype: tuple, float</span>

<span class="sd">    .. seealso ::</span>
<span class="sd">        https://en.wikipedia.org/wiki/Geographic_coordinate_conversion</span>
<span class="sd">        #The_application_of_Ferrari.27s_solution</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wgs</span> <span class="o">=</span> <span class="n">get_wgs84</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">wgs</span><span class="o">.</span><span class="n">a</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">wgs</span><span class="o">.</span><span class="n">f</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">wgs</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">f</span> <span class="o">-</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span>

    <span class="c"># usefull</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">e4</span> <span class="o">=</span> <span class="n">e2</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">Z2</span> <span class="o">=</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X2</span> <span class="o">+</span> <span class="n">Y2</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">e_prime2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span> <span class="o">-</span> <span class="n">b2</span><span class="p">)</span><span class="o">/</span><span class="n">b2</span>
    <span class="n">E2</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">-</span> <span class="n">b2</span>
    <span class="n">F</span> <span class="o">=</span> <span class="mf">54.</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">Z2</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span><span class="o">*</span><span class="n">Z2</span> <span class="o">-</span> <span class="p">(</span><span class="n">e2</span><span class="o">*</span><span class="n">E2</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">e4</span> <span class="o">*</span> <span class="n">F</span> <span class="o">*</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">G</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">C</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">C</span><span class="p">))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">F</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">S</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">G</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">e4</span><span class="o">*</span><span class="n">P</span><span class="p">))</span>

    <span class="n">dum1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="n">e2</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">dum2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">a2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">dum3</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">Q</span><span class="p">))</span>
    <span class="n">dum4</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">P</span> <span class="o">*</span> <span class="n">r2</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">dum1</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dum2</span> <span class="o">-</span> <span class="n">dum3</span> <span class="o">-</span> <span class="n">dum4</span><span class="p">)</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="n">e2</span><span class="o">*</span><span class="n">r0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Z2</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="n">e2</span><span class="o">*</span><span class="n">r0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span><span class="o">*</span><span class="n">Z2</span><span class="p">)</span>
    <span class="n">Z0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">V</span><span class="p">)</span>

    <span class="n">alt</span> <span class="o">=</span> <span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">b2</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">V</span><span class="p">)))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">Z</span> <span class="o">+</span> <span class="n">e_prime2</span> <span class="o">*</span> <span class="n">Z0</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">lat</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="n">lon</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span></div>


<div class="viewcode-block" id="Farside"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.Farside">[docs]</a><span class="k">class</span> <span class="nc">Farside</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="latlon_to_xyz"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.latlon_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">latlon_to_xyz</span><span class="p">(</span><span class="n">latlons</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">latlons</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">latlons</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">latlons</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">latlons</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">latlons</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lons</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lons</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lats</span><span class="o">*</span><span class="n">d2r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">points</span></div>


<div class="viewcode-block" id="xyz_to_latlon"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.xyz_to_latlon">[docs]</a><span class="k">def</span> <span class="nf">xyz_to_latlon</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">xyz</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyz_to_latlon</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">latlons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">latlons</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">r2d</span>
    <span class="n">latlons</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">r2d</span>
    <span class="k">return</span> <span class="n">latlons</span></div>


<div class="viewcode-block" id="rot_to_00"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.rot_to_00">[docs]</a><span class="k">def</span> <span class="nf">rot_to_00</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="n">rot0</span> <span class="o">=</span> <span class="n">euler_to_matrix</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">90.</span><span class="o">*</span><span class="n">d2r</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">A</span>
    <span class="n">rot1</span> <span class="o">=</span> <span class="n">euler_to_matrix</span><span class="p">(</span><span class="o">-</span><span class="n">d2r</span><span class="o">*</span><span class="n">lat</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">d2r</span><span class="o">*</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">A</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot1</span><span class="p">,</span> <span class="n">rot0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="distances3d"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.distances3d">[docs]</a><span class="k">def</span> <span class="nf">distances3d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="circulation"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.circulation">[docs]</a><span class="k">def</span> <span class="nf">circulation</span><span class="p">(</span><span class="n">points2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="p">(</span><span class="n">points2</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">points2</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">points2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="stereographic"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.stereographic">[docs]</a><span class="k">def</span> <span class="nf">stereographic</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">distances3d</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">if</span> <span class="n">dists</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">maxdist</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">maxdist</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1.0e-5</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Farside</span><span class="p">()</span>

    <span class="n">points_out</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">points_out</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">points_out</span></div>


<div class="viewcode-block" id="stereographic_poly"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.stereographic_poly">[docs]</a><span class="k">def</span> <span class="nf">stereographic_poly</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">distances3d</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span> <span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">if</span> <span class="n">dists</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">maxdist</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">maxdist</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1.0e-5</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Farside</span><span class="p">()</span>

    <span class="n">points_out</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">points_out</span> <span class="o">*=</span> <span class="n">factor</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">circulation</span><span class="p">(</span><span class="n">points_out</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Farside</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">points_out</span></div>


<div class="viewcode-block" id="contains_point"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.contains_point">[docs]</a><span class="k">def</span> <span class="nf">contains_point</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">rot_to_00</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="n">points_rot</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">points_xyz</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">spoly_cut</span><span class="p">([</span><span class="n">points_rot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">points_g</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">points2</span> <span class="o">=</span> <span class="n">stereographic_poly</span><span class="p">(</span><span class="n">points_g</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">points2</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">contains_point</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="k">True</span>

            <span class="k">except</span> <span class="n">Farside</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">return</span> <span class="k">False</span></div>


<div class="viewcode-block" id="contains_points"><a class="viewcode-back" href="../../library/reference/orthodrome.html#pyrocko.orthodrome.contains_points">[docs]</a><span class="k">def</span> <span class="nf">contains_points</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">center_xyz</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
        <span class="n">distances3d</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">center_xyz</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">xyz_to_latlon</span><span class="p">(</span><span class="n">center_xyz</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">rot_to_00</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>

    <span class="n">points_rot_xyz</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">points_xyz</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">points_rot_pro</span> <span class="o">=</span> <span class="n">stereographic</span><span class="p">(</span><span class="n">points_rot_xyz</span><span class="p">)</span>

    <span class="n">poly_xyz</span> <span class="o">=</span> <span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    <span class="n">poly_rot_xyz</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">poly_xyz</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">spoly_cut</span><span class="p">([</span><span class="n">poly_rot_xyz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">poly_rot_group_xyz</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">poly_rot_group_pro</span> <span class="o">=</span> <span class="n">stereographic_poly</span><span class="p">(</span><span class="n">poly_rot_group_xyz</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">poly_rot_group_pro</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#39;contains_points&#39;</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">points_rot_pro</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">contains_point</span><span class="p">(</span><span class="n">points_rot_pro</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">except</span> <span class="n">Farside</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span></div>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Pyrocko Developers.
    </div>
  </body>
</html>