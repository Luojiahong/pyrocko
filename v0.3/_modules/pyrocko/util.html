<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.util &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    

  </head>
  <body role="document">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &#187;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyrocko.util</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;Utility functions for Pyrocko.&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>


<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;Darwin&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">util_ext</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">util_ext</span> <span class="o">=</span> <span class="k">None</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;pyrocko.util&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">progressbar</span> <span class="k">as</span> <span class="nn">progressbar_mod</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">dummy_progressbar</span> <span class="k">as</span> <span class="n">progressbar_mod</span>


<div class="viewcode-block" id="progressbar_module"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.progressbar_module">[docs]</a><span class="k">def</span> <span class="nf">progressbar_module</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">progressbar_mod</span></div>


<div class="viewcode-block" id="setup_logging"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.setup_logging">[docs]</a><span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="n">programname</span><span class="o">=</span><span class="s">&#39;pyrocko&#39;</span><span class="p">,</span> <span class="n">levelname</span><span class="o">=</span><span class="s">&#39;warning&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialize logging.</span>

<span class="sd">    :param programname: program name to be written in log</span>
<span class="sd">    :param levelname: string indicating the logging level (&#39;debug&#39;, &#39;info&#39;,</span>
<span class="sd">        &#39;warning&#39;, &#39;error&#39;, &#39;critical&#39;)</span>

<span class="sd">    This function is called at startup by most pyrocko programs to set up a</span>
<span class="sd">    consistent logging format. This is simply a shortcut to a call to</span>
<span class="sd">    :py:func:`logging.basicConfig()`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;debug&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
              <span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
              <span class="s">&#39;warning&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
              <span class="s">&#39;error&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
              <span class="s">&#39;critical&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">}</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">[</span><span class="n">levelname</span><span class="p">],</span>
        <span class="nb">format</span><span class="o">=</span><span class="n">programname</span><span class="o">+</span><span class="s">&#39;:%(name)-20s - %(levelname)-8s - %(message)s&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="data_file"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.data_file">[docs]</a><span class="k">def</span> <span class="nf">data_file</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="DownloadError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.DownloadError">[docs]</a><span class="k">class</span> <span class="nc">DownloadError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="download_file"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.download_file">[docs]</a><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">urllib2</span>
    <span class="kn">import</span> <span class="nn">base64</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;starting download of %s&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">ensuredirs</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">base64string</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">&#39;%s:%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
            <span class="n">request</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Basic %s&quot;</span> <span class="o">%</span> <span class="n">base64string</span><span class="p">)</span>

        <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPCookieProcessor</span><span class="p">())</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DownloadError</span><span class="p">(</span><span class="s">&#39;cannot download file from url %s: %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="n">fpath_tmp</span> <span class="o">=</span> <span class="n">fpath</span> <span class="o">+</span> <span class="s">&#39;.%i.temp&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath_tmp</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">fpath_tmp</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;finished download of %s&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span></div>


<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;float128&#39;</span><span class="p">):</span>
    <span class="n">hpfloat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">float128</span>
<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;float96&#39;</span><span class="p">):</span>
    <span class="n">hpfloat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">float96</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">hpfloat</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s">&#39;NumPy lacks support for float128 or float96 data type on this &#39;</span>
            <span class="s">&#39;platform.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Stopwatch"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.Stopwatch">[docs]</a><span class="k">class</span> <span class="nc">Stopwatch</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Simple stopwatch to measure elapsed wall clock time.</span>

<span class="sd">    Usage::</span>

<span class="sd">        s = Stopwatch()</span>
<span class="sd">        time.sleep(1)</span>
<span class="sd">        print s()</span>
<span class="sd">        time.sleep(1)</span>
<span class="sd">        print s()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span></div>


<div class="viewcode-block" id="wrap"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.wrap">[docs]</a><span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">line_length</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Paragraph and list-aware wrapping of text.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">at_lineend</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39; *\n&#39;</span><span class="p">)</span>
    <span class="n">at_para</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;((^|(\n\s*)?\n)(\s+[*] )|\n\s*\n)&#39;</span><span class="p">)</span>

    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[::</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">listindents</span> <span class="o">=</span> <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="mi">4</span><span class="p">::</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="n">at_para</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="mi">3</span><span class="p">::</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">listindents</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="k">None</span><span class="p">]</span>
    <span class="n">listindents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">True</span><span class="p">)</span>
    <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>

    <span class="n">det_indent</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^ *&#39;</span><span class="p">)</span>

    <span class="n">outlines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">_indent</span> <span class="o">=</span> <span class="n">det_indent</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">findent</span> <span class="o">=</span> <span class="n">_indent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">findent</span> <span class="o">=</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
            <span class="n">_indent</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">findent</span><span class="p">)</span>

        <span class="n">ll</span> <span class="o">=</span> <span class="n">line_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">_indent</span><span class="p">)</span>
        <span class="n">llf</span> <span class="o">=</span> <span class="n">ll</span>

        <span class="n">oldlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">at_lineend</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oldlines</span><span class="p">)</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(^.{1,%i}|.{1,%i})( |$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">llf</span><span class="p">,</span> <span class="n">ll</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">imatch</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">possible</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">p1</span><span class="p">)):</span>
            <span class="n">parout</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imatch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">findent</span> <span class="o">+</span> <span class="n">parout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_indent</span> <span class="o">+</span> <span class="n">parout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="k">None</span>
                <span class="ow">or</span> <span class="n">newlist</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span>
                <span class="ow">or</span> <span class="n">listindents</span><span class="p">[</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="k">None</span><span class="p">):</span>

            <span class="n">outlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outlines</span></div>


<div class="viewcode-block" id="BetterHelpFormatter"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.BetterHelpFormatter">[docs]</a><span class="k">class</span> <span class="nc">BetterHelpFormatter</span><span class="p">(</span><span class="n">optparse</span><span class="o">.</span><span class="n">IndentedHelpFormatter</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">optparse</span><span class="o">.</span><span class="n">IndentedHelpFormatter</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="BetterHelpFormatter.format_option"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.BetterHelpFormatter.format_option">[docs]</a>    <span class="k">def</span> <span class="nf">format_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        From IndentedHelpFormatter but using a different wrap method.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">help_text_position</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span>
        <span class="n">help_text_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">help_text_position</span>

        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="s">&quot;%*s%s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_default</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_position</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">help_text</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;%-*s %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help_position</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">help_text</span><span class="p">),</span>
                <span class="s">&#39;&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
                <span class="n">help_lines</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">help_text</span><span class="p">,</span> <span class="n">help_text_width</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;%*s%s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">help_text_position</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">help_lines</span><span class="p">])</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="BetterHelpFormatter.format_description"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.BetterHelpFormatter.format_description">[docs]</a>    <span class="k">def</span> <span class="nf">format_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s">&#39;%*s%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="progressbar"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.progressbar">[docs]</a><span class="k">def</span> <span class="nf">progressbar</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">maxval</span><span class="p">):</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">label</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span>
        <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="s">&#39;[&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="s">&#39;]&#39;</span><span class="p">),</span> <span class="s">&#39; &#39;</span><span class="p">,</span>
        <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span> <span class="s">&#39; &#39;</span><span class="p">]</span>

    <span class="n">pbar</span> <span class="o">=</span> <span class="n">progressbar_mod</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pbar</span></div>


<div class="viewcode-block" id="progress_beg"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.progress_beg">[docs]</a><span class="k">def</span> <span class="nf">progress_beg</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Notify user that an operation has started.</span>

<span class="sd">    :param label: name of the operation</span>

<span class="sd">    To be used in conjuction with :py:func:`progress_end`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="progress_end"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.progress_end">[docs]</a><span class="k">def</span> <span class="nf">progress_end</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Notify user that an operation has ended.</span>

<span class="sd">    :param label: name of the operation</span>

<span class="sd">    To be used in conjuction with :py:func:`progress_beg`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; done. %s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="ArangeError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.ArangeError">[docs]</a><span class="k">class</span> <span class="nc">ArangeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="arange2"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.arange2">[docs]</a><span class="k">def</span> <span class="nf">arange2</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return evenly spaced numbers over a specified interval.</span>

<span class="sd">    Like :py:func:`numpy.arange` but returning floating point numbers by</span>
<span class="sd">    default and with defined behaviour when stepsize is inconsistent with</span>
<span class="sd">    interval bounds. It is considered inconsistent if the difference between</span>
<span class="sd">    the closest multiple of ``step`` and ``stop`` is larger than ``epsilon *</span>
<span class="sd">    step``. Inconsistencies are handled according to the ``error`` parameter.</span>
<span class="sd">    If it is set to ``&#39;raise&#39;`` an exception of type :py:exc:`ArangeError` is</span>
<span class="sd">    raised. If it is set to ``&#39;round&#39;``, ``&#39;floor&#39;``, or ``&#39;ceil&#39;``, ``stop``</span>
<span class="sd">    is silently changed to the closest, the next smaller, or next larger</span>
<span class="sd">    multiple of ``step``, respectively.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">error</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;raise&#39;</span><span class="p">,</span> <span class="s">&#39;round&#39;</span><span class="p">,</span> <span class="s">&#39;floor&#39;</span><span class="p">,</span> <span class="s">&#39;ceil&#39;</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

    <span class="n">rnd</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;floor&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span> <span class="s">&#39;ceil&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">round</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rnd</span><span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">stop_check</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>

    <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="s">&#39;raise&#39;</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stop_check</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">step</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ArangeError</span><span class="p">(</span>
            <span class="s">&#39;inconsistent range specification: start=%g, stop=%g, step=%g&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="n">step</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="n">start</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="polylinefit"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.polylinefit">[docs]</a><span class="k">def</span> <span class="nf">polylinefit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_or_xnodes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fit piece-wise linear function to data.</span>

<span class="sd">    :param x,y: arrays with coordinates of data</span>
<span class="sd">    :param n_or_xnodes: int, number of segments or x coordinates of polyline</span>

<span class="sd">    :returns: `(xnodes, ynodes, rms_error)` arrays with coordinates of</span>
<span class="sd">        polyline, root-mean-square error</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_or_xnodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n_or_xnodes</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">xnodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xnodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">n_or_xnodes</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">xnodes</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndata</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">xmin_block</span> <span class="o">=</span> <span class="n">xnodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">xmax_block</span> <span class="o">=</span> <span class="n">xnodes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c"># don&#39;t loose last point</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xmin_block</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">xmax_block</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xmin_block</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">xmax_block</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">a</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ndata</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xmax_block</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">xmax_block</span><span class="o">*</span><span class="n">w</span>
            <span class="n">a</span><span class="p">[</span><span class="n">ndata</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">w</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">ynodes</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ynodes</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xnodes</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ynodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">model</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xnodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">model</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ynodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.5</span>

    <span class="n">rms_error</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xnodes</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xnodes</span><span class="p">,</span> <span class="n">ynodes</span><span class="p">,</span> <span class="n">rms_error</span></div>


<div class="viewcode-block" id="plf_integrate_piecewise"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.plf_integrate_piecewise">[docs]</a><span class="k">def</span> <span class="nf">plf_integrate_piecewise</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Calculate definite integral of piece-wise linear function on intervals.</span>

<span class="sd">    Use trapezoidal rule to calculate definite integral of a piece-wise linear</span>
<span class="sd">    function for a series of consecutive intervals. ``x_edges`` and ``x`` must</span>
<span class="sd">    be sorted.</span>

<span class="sd">    :param x_edges: array with edges of the intervals</span>
<span class="sd">    :param x,y: arrays with coordinates of piece-wise linear function&#39;s</span>
<span class="sd">                 control points</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">x_all</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">))</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_all</span><span class="p">)</span>
    <span class="n">y_edges</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_all</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">))</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">x_all</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">y_all</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    <span class="n">y_all</span><span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cumsum</span><span class="p">((</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">xs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y_all</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">y_edges</span><span class="p">):])</span></div>


<div class="viewcode-block" id="GlobalVars"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.GlobalVars">[docs]</a><span class="k">class</span> <span class="nc">GlobalVars</span><span class="p">:</span>
    <span class="n">reuse_store</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">decitab_nmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">decitab</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">decimate_fir_coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">decimate_iir_coeffs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">re_frac</span> <span class="o">=</span> <span class="k">None</span></div>


<div class="viewcode-block" id="decimate_coeffs"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.decimate_coeffs">[docs]</a><span class="k">def</span> <span class="nf">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;iir&#39;</span><span class="p">):</span>

    <span class="n">q</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;fir&#39;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s">&#39;fir&#39;</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decimate_fir_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">firwin</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">&#39;hamming&#39;</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="n">n</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decimate_iir_coeffs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">cheby1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">)</span>

        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">q</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span></div>


<div class="viewcode-block" id="decimate"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.decimate">[docs]</a><span class="k">def</span> <span class="nf">decimate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s">&#39;iir&#39;</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">ioff</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Downsample the signal x by an integer factor q, using an order n filter</span>

<span class="sd">    By default, an order 8 Chebyshev type I filter is used or a 30 point FIR</span>
<span class="sd">    filter with hamming window if ftype is &#39;fir&#39;.</span>

<span class="sd">    :param x: the signal to be downsampled (1D NumPy array)</span>
<span class="sd">    :param q: the downsampling factor</span>
<span class="sd">    :param n: order of the filter (1 less than the length of the filter for a</span>
<span class="sd">         &#39;fir&#39; filter)</span>
<span class="sd">    :param ftype: type of the filter; can be &#39;iir&#39; or &#39;fir&#39;</span>

<span class="sd">    :returns: the downsampled signal (1D NumPy array)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">decimate_coeffs</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zi</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">zi</span> <span class="ow">is</span> <span class="k">True</span><span class="p">:</span>
        <span class="n">zi_</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zi_</span> <span class="o">=</span> <span class="n">zi</span>

    <span class="n">y</span><span class="p">,</span> <span class="n">zf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">zi</span><span class="o">=</span><span class="n">zi_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">ioff</span><span class="p">::</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">zf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">ioff</span><span class="p">::</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="UnavailableDecimation"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.UnavailableDecimation">[docs]</a><span class="k">class</span> <span class="nc">UnavailableDecimation</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised by :py:func:`decitab` for unavailable decimation factors.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="gcd"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gcd">[docs]</a><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Greatest common divisor.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">while</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="o">*</span><span class="n">a</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="lcm"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.lcm">[docs]</a><span class="k">def</span> <span class="nf">lcm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Least common multiple.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">/</span><span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="mk_decitab"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.mk_decitab">[docs]</a><span class="k">def</span> <span class="nf">mk_decitab</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Make table with decimation sequences.</span>

<span class="sd">    Decimation from one sampling rate to a lower one is achieved by a</span>
<span class="sd">    successive application of :py:func:`decimation` with small integer</span>
<span class="sd">    downsampling factors (because using large downampling factors can make the</span>
<span class="sd">    decimation unstable or slow). This function sets up a table with downsample</span>
<span class="sd">    sequences for factors up to ``nmax``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tab</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">m</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tab</span><span class="p">:</span>
                            <span class="n">tab</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab_nmax</span> <span class="o">=</span> <span class="n">nmax</span></div>


<div class="viewcode-block" id="zfmt"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.zfmt">[docs]</a><span class="k">def</span> <span class="nf">zfmt</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;%%0%ii&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="julian_day_of_year"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.julian_day_of_year">[docs]</a><span class="k">def</span> <span class="nf">julian_day_of_year</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the day number after the 1st of January of year in ``timestamp``.</span>

<span class="sd">    :returns: day number as int</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">tm_yday</span></div>


<div class="viewcode-block" id="day_start"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.day_start">[docs]</a><span class="k">def</span> <span class="nf">day_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get beginning of day for any point in time.</span>

<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of day start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span></div>


<div class="viewcode-block" id="month_start"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.month_start">[docs]</a><span class="k">def</span> <span class="nf">month_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get beginning of month for any point in time.</span>

<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of month start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span></div>


<div class="viewcode-block" id="year_start"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.year_start">[docs]</a><span class="k">def</span> <span class="nf">year_start</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get beginning of year for any point in time.</span>

<span class="sd">    :param timestamp: time instant as system timestamp (in seconds)</span>

<span class="sd">    :returns: instant of year start as system timestamp</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="n">tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span></div>


<div class="viewcode-block" id="iter_days"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.iter_days">[docs]</a><span class="k">def</span> <span class="nf">iter_days</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Yields begin and end of days until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>

<span class="sd">    :yields: tuples with (begin, end) of days as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">day_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">day_start</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">26</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span></div>


<div class="viewcode-block" id="iter_months"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.iter_months">[docs]</a><span class="k">def</span> <span class="nf">iter_months</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Yields begin and end of months until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>

<span class="sd">    :yields: tuples with (begin, end) of months as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">month_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">month_start</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">33</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span></div>


<div class="viewcode-block" id="iter_years"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.iter_years">[docs]</a><span class="k">def</span> <span class="nf">iter_years</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Yields begin and end of years until given time span is covered.</span>

<span class="sd">    :param tmin,tmax: input time span</span>

<span class="sd">    :yields: tuples with (begin, end) of years as system timestamps</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">year_start</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tmax</span><span class="p">:</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">year_start</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">369</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">t</span><span class="p">,</span> <span class="n">tend</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tend</span></div>


<div class="viewcode-block" id="decitab"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.decitab">[docs]</a><span class="k">def</span> <span class="nf">decitab</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get integer decimation sequence for given downampling factor.</span>

<span class="sd">    :param n: target decimation factor</span>

<span class="sd">    :returns: tuple with downsampling sequence</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab_nmax</span><span class="p">:</span>
        <span class="n">mk_decitab</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnavailableDecimation</span><span class="p">(</span><span class="s">&#39;ratio = %g&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">decitab</span><span class="p">[</span><span class="n">n</span><span class="p">]</span></div>


<div class="viewcode-block" id="ctimegm"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.ctimegm">[docs]</a><span class="k">def</span> <span class="nf">ctimegm</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert string representing UTC time to system time.</span>

<span class="sd">    :param s: string to be interpreted</span>
<span class="sd">    :param format: format string passed to :py:func:`strptime`</span>

<span class="sd">    :returns: system time stamp</span>

<span class="sd">    Interpretes string with format ``&#39;%Y-%m-%d %H:%M:%S&#39;``, using strptime.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`str_to_time`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span></div>


<div class="viewcode-block" id="gmctime"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gmctime">[docs]</a><span class="k">def</span> <span class="nf">gmctime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get string representation from system time, UTC.</span>

<span class="sd">    Produces string with format ``&#39;%Y-%m-%d %H:%M:%S&#39;``, using strftime.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This function is to be repaced by :py:func:`time_to_str`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span></div>


<div class="viewcode-block" id="gmctime_v"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gmctime_v">[docs]</a><span class="k">def</span> <span class="nf">gmctime_v</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&quot;%a, %d %b %Y %H:%M:%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get string representation from system time, UTC. Same as</span>
<span class="sd">    :py:func:`gmctime` but with a more verbose default format.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`time_to_str`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span></div>


<div class="viewcode-block" id="gmctime_fn"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gmctime_fn">[docs]</a><span class="k">def</span> <span class="nf">gmctime_fn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-%d_%H-%M-%S&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get string representation from system time, UTC. Same as</span>
<span class="sd">    :py:func:`gmctime` but with a default usable in filenames.</span>

<span class="sd">    .. note::</span>
<span class="sd">       This function is to be replaced by :py:func:`time_to_str`.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span></div>


<div class="viewcode-block" id="TimeStrError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.TimeStrError">[docs]</a><span class="k">class</span> <span class="nc">TimeStrError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="FractionalSecondsMissing"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.FractionalSecondsMissing">[docs]</a><span class="k">class</span> <span class="nc">FractionalSecondsMissing</span><span class="p">(</span><span class="n">TimeStrError</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised by :py:func:`str_to_time` when the given string lacks</span>
<span class="sd">    fractional seconds.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="FractionalSecondsWrongNumberOfDigits"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.FractionalSecondsWrongNumberOfDigits">[docs]</a><span class="k">class</span> <span class="nc">FractionalSecondsWrongNumberOfDigits</span><span class="p">(</span><span class="n">TimeStrError</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised by :py:func:`str_to_time` when the given string has an</span>
<span class="sd">    incorrect number of digits in the fractional seconds part.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">_endswith_n</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">endings</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">endings</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ix</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>


<div class="viewcode-block" id="str_to_time"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.str_to_time">[docs]</a><span class="k">def</span> <span class="nf">str_to_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-%d %H:%M:%S.OPTFRAC&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert string representing UTC time to floating point system time.</span>

<span class="sd">    :param s: string representing UTC time</span>
<span class="sd">    :param format: time string format</span>
<span class="sd">    :returns: system time stamp as floating point value</span>

<span class="sd">    Uses the semantics of :py:func:`time.strptime` but allows for fractional</span>
<span class="sd">    seconds. If the format ends with ``&#39;.FRAC&#39;``, anything after a dot is</span>
<span class="sd">    interpreted as fractional seconds. If the format ends with ``&#39;.OPTFRAC&#39;``,</span>
<span class="sd">    the fractional part, including the dot is made optional. The latter has the</span>
<span class="sd">    consequence, that the time strings and the format may not contain any other</span>
<span class="sd">    dots. If the format ends with ``&#39;.xFRAC&#39;`` where x is 1, 2, or 3, it is</span>
<span class="sd">    ensured, that exactly that number of digits are present in the fractional</span>
<span class="sd">    seconds.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">util_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">tfrac</span> <span class="o">=</span> <span class="n">util_ext</span><span class="o">.</span><span class="n">stt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">util_ext</span><span class="o">.</span><span class="n">UtilExtError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TimeStrError</span><span class="p">(</span>
                <span class="s">&#39;%s, string=%s, format=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">t</span><span class="o">+</span><span class="n">tfrac</span>

    <span class="n">fracsec</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fixed_endings</span> <span class="o">=</span> <span class="s">&#39;.FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.1FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.2FRAC&#39;</span><span class="p">,</span> <span class="s">&#39;.3FRAC&#39;</span>

    <span class="n">iend</span> <span class="o">=</span> <span class="n">_endswith_n</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">fixed_endings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iend</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dotpos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FractionalSecondsMissing</span><span class="p">(</span>
                <span class="s">&#39;string=%s, format=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">iend</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">iend</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="n">dotpos</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FractionalSecondsWrongNumberOfDigits</span><span class="p">(</span>
                <span class="s">&#39;string=%s, format=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span>

        <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">fixed_endings</span><span class="p">[</span><span class="n">iend</span><span class="p">])]</span>
        <span class="n">fracsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">dotpos</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">format</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.OPTFRAC&#39;</span><span class="p">):</span>
        <span class="n">dotpos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fracsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">dotpos</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">dotpos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">dotpos</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span> <span class="o">+</span> <span class="n">fracsec</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TimeStrError</span><span class="p">(</span><span class="s">&#39;%s, string=%s, format=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span></div>


<span class="n">stt</span> <span class="o">=</span> <span class="n">str_to_time</span>


<div class="viewcode-block" id="time_to_str"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.time_to_str">[docs]</a><span class="k">def</span> <span class="nf">time_to_str</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">&#39;%Y-%m-%d %H:%M:%S.3FRAC&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get string representation for floating point system time.</span>

<span class="sd">    :param t: floating point system time</span>
<span class="sd">    :param format: time string format</span>
<span class="sd">    :returns: string representing UTC time</span>

<span class="sd">    Uses the semantics of :py:func:`time.strftime` but additionally allows for</span>
<span class="sd">    fractional seconds. If ``format`` contains ``&#39;.xFRAC&#39;``, where ``x`` is a</span>
<span class="sd">    digit between 1 and 9, this is replaced with the fractional part of ``t``</span>
<span class="sd">    with ``x`` digits precision.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s">&#39;%Y-%m-%d %H:%M:%S.&#39;</span> <span class="o">+</span> <span class="s">&#39;%iFRAC&#39;</span> <span class="o">%</span> <span class="nb">format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s">&#39;%Y-%m-%d %H:%M:%S&#39;</span>

    <span class="k">if</span> <span class="n">util_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">util_ext</span><span class="o">.</span><span class="n">tts</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t0</span><span class="p">),</span> <span class="n">t</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">util_ext</span><span class="o">.</span><span class="n">UtilExtError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TimeStrError</span><span class="p">(</span>
                <span class="s">&#39;%s, timestamp=%f, format=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="p">:</span>
        <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\.[1-9]FRAC&#39;</span><span class="p">)</span>
        <span class="n">GlobalVars</span><span class="o">.</span><span class="n">frac_formats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[(</span><span class="s">&#39;.%sFRAC&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="s">&#39;%.&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;f&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s">&#39;123456789&#39;</span><span class="p">])</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="n">tfrac</span> <span class="o">=</span> <span class="n">t</span><span class="o">-</span><span class="n">ts</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">sfrac</span> <span class="o">=</span> <span class="p">(</span><span class="n">GlobalVars</span><span class="o">.</span><span class="n">frac_formats</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">%</span> <span class="n">tfrac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sfrac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">+=</span> <span class="mf">1.</span>

        <span class="nb">format</span><span class="p">,</span> <span class="n">nsub</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">re_frac</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="n">sfrac</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">format</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span></div>


<span class="n">tts</span> <span class="o">=</span> <span class="n">time_to_str</span>


<div class="viewcode-block" id="mystrftime"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.mystrftime">[docs]</a><span class="k">def</span> <span class="nf">mystrftime</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">milliseconds</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;%Y-%m-%d %H:%M:%S .%r&#39;</span>

    <span class="k">if</span> <span class="n">tt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%r&#39;</span><span class="p">,</span> <span class="s">&#39;%03i&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">)))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%u&#39;</span><span class="p">,</span> <span class="s">&#39;%06i&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">*</span><span class="mi">1000</span><span class="p">)))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%n&#39;</span><span class="p">,</span> <span class="s">&#39;%09i&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">tt</span><span class="p">)</span></div>


<div class="viewcode-block" id="gmtime_x"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gmtime_x">[docs]</a><span class="k">def</span> <span class="nf">gmtime_x</span><span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
    <span class="n">etimestamp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">etimestamp</span><span class="p">)</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span><span class="o">-</span><span class="n">etimestamp</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>
    <span class="k">return</span> <span class="n">tt</span><span class="p">,</span> <span class="n">ms</span></div>


<div class="viewcode-block" id="plural_s"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.plural_s">[docs]</a><span class="k">def</span> <span class="nf">plural_s</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;s&#39;</span></div>


<div class="viewcode-block" id="ensuredirs"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.ensuredirs">[docs]</a><span class="k">def</span> <span class="nf">ensuredirs</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create all intermediate path components for a target path.</span>

<span class="sd">    :param dst: target path</span>

<span class="sd">    The leaf part of the target path is not created (use :py:func:`ensuredir`</span>
<span class="sd">    if a the target path is a directory to be created).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">d</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">d</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="n">dirs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensuredir"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.ensuredir">[docs]</a><span class="k">def</span> <span class="nf">ensuredir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create directory and all intermediate path components to it as needed.</span>

<span class="sd">    :param dst: directory name</span>

<span class="sd">    Nothing is done if the given target already exists.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">ensuredirs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span></div>


<div class="viewcode-block" id="reuse"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.reuse">[docs]</a><span class="k">def</span> <span class="nf">reuse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get unique instance of an object.</span>

<span class="sd">    :param x: hashable object</span>
<span class="sd">    :returns: reference to x or an equivalent object</span>

<span class="sd">    Cache object ``x`` in a global dict for reuse, or if x already</span>
<span class="sd">    is in that dict, return a reference to it.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">grs</span> <span class="o">=</span> <span class="n">GlobalVars</span><span class="o">.</span><span class="n">reuse_store</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grs</span><span class="p">:</span>
        <span class="n">grs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">grs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span></div>


<div class="viewcode-block" id="Anon"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.Anon">[docs]</a><span class="k">class</span> <span class="nc">Anon</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Dict-to-object utility.</span>

<span class="sd">    Any given arguments are stored as attributes.</span>

<span class="sd">    Example::</span>

<span class="sd">        a = Anon(x=1, y=2)</span>
<span class="sd">        print a.x, a.y</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span></div>


<div class="viewcode-block" id="select_files"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.select_files">[docs]</a><span class="k">def</span> <span class="nf">select_files</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Recursively select files.</span>

<span class="sd">    :param paths: entry path names</span>
<span class="sd">    :param selector: callback for conditional inclusion</span>
<span class="sd">    :param regex: pattern for conditional inclusion</span>
<span class="sd">    :param show_progress: if True, indicate start and stop of processing</span>
<span class="sd">    :returns: list of path names</span>

<span class="sd">    Recursively finds all files under given entry points ``paths``. If</span>
<span class="sd">    parameter ``regex`` is a regular expression, only files with matching path</span>
<span class="sd">    names are included. If additionally parameter ``selector`` is given a</span>
<span class="sd">    callback function, only files for which the callback returns ``True`` are</span>
<span class="sd">    included. The callback should take a single argument. The callback is</span>
<span class="sd">    called with a single argument, an object, having as attributes, any named</span>
<span class="sd">    groups given in ``regex``.</span>

<span class="sd">    Examples</span>

<span class="sd">    To find all files ending in ``&#39;.mseed&#39;`` or ``&#39;.msd&#39;``::</span>

<span class="sd">        select_files(paths,</span>
<span class="sd">            regex=r&#39;\.(mseed|msd)$&#39;)</span>

<span class="sd">    To find all files ending with ``&#39;$Year.$DayOfYear&#39;``, having set 2009 for</span>
<span class="sd">    the year::</span>

<span class="sd">        select_files(paths,</span>
<span class="sd">            regex=r&#39;(?P&lt;year&gt;\d\d\d\d)\.(?P&lt;doy&gt;\d\d\d)$&#39;,</span>
<span class="sd">            selector=(lambda x: int(x.year) == 2009))</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
        <span class="n">progress_beg</span><span class="p">(</span><span class="s">&#39;selecting files...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">good</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
        <span class="n">rselector</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;looking at filename: &#39;%s&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">rselector</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">infos</span> <span class="o">=</span> <span class="n">Anon</span><span class="p">(</span><span class="o">**</span><span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;   regex &#39;%s&#39; matches.&quot;</span> <span class="o">%</span> <span class="n">regex</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s">&quot;      attribute &#39;%s&#39; has value &#39;%s&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">selector</span><span class="p">(</span><span class="n">infos</span><span class="p">):</span>
                    <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;   regex &#39;%s&#39; does not match.&quot;</span> <span class="o">%</span> <span class="n">regex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">addfile</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_progress</span><span class="p">:</span>
        <span class="n">progress_end</span><span class="p">(</span><span class="s">&#39;%i file%s selected.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">),</span> <span class="n">plural_s</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">good</span></div>


<div class="viewcode-block" id="base36encode"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.base36encode">[docs]</a><span class="k">def</span> <span class="nf">base36encode</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">alphabet</span><span class="o">=</span><span class="s">&#39;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert positive integer to a base36 string.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">long</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;number must be an integer&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;number must be positive&#39;</span><span class="p">)</span>

    <span class="c"># Special case for small numbers</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">number</span><span class="p">]</span>

    <span class="n">base36</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">number</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">number</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
        <span class="n">base36</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">base36</span>

    <span class="k">return</span> <span class="n">base36</span></div>


<div class="viewcode-block" id="base36decode"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.base36decode">[docs]</a><span class="k">def</span> <span class="nf">base36decode</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Decode base36 endcoded positive integer.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnpackError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.UnpackError">[docs]</a><span class="k">class</span> <span class="nc">UnpackError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised when :py:func:`unpack_fixed` encounters an error.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span></div>


<span class="n">ruler</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;%-10i&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)])</span> \
    <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;0123456789&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>


<div class="viewcode-block" id="unpack_fixed"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.unpack_fixed">[docs]</a><span class="k">def</span> <span class="nf">unpack_fixed</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Unpack fixed format string, as produced by many fortran codes.</span>

<span class="sd">    :param format: format specification</span>
<span class="sd">    :param line: string to be processed</span>
<span class="sd">    :param callargs: callbacks for callback fields in the format</span>

<span class="sd">    The format is described by a string of comma-separated fields. Each field</span>
<span class="sd">    is defined by a character for the field type followed by the field width. A</span>
<span class="sd">    questionmark may be appended to the field description to allow the argument</span>
<span class="sd">    to be optional (The data string is then allowed to be filled with blanks</span>
<span class="sd">    and ``None`` is returned in this case).</span>

<span class="sd">    The following field types are available:</span>

<span class="sd">    ====  ================================================================</span>
<span class="sd">    Type  Description</span>
<span class="sd">    ====  ================================================================</span>
<span class="sd">    A     string (full field width is extracted)</span>
<span class="sd">    a     string (whitespace at the beginning and the end is removed)</span>
<span class="sd">    i     integer value</span>
<span class="sd">    f     floating point value</span>
<span class="sd">    @     special type, a callback must be given for the conversion</span>
<span class="sd">    x     special field type to skip parts of the string</span>
<span class="sd">    ====  ================================================================</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ipos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">icall</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="nb">format</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">]</span>
        <span class="n">cast</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="k">None</span><span class="p">,</span>
            <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
            <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="s">&#39;@&#39;</span><span class="p">:</span> <span class="s">&#39;extra&#39;</span><span class="p">}[</span><span class="n">typ</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cast</span> <span class="o">==</span> <span class="s">&#39;extra&#39;</span><span class="p">:</span>
            <span class="n">cast</span> <span class="o">=</span> <span class="n">callargs</span><span class="p">[</span><span class="n">icall</span><span class="p">]</span>
            <span class="n">icall</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">cast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">optional</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">80</span>
                    <span class="n">mark</span><span class="p">[</span><span class="n">ipos</span><span class="p">:</span><span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;^&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">l</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">UnpackError</span><span class="p">(</span>
                        <span class="s">&#39;Invalid cast to type &quot;%s&quot; at position [%i:%i] of &#39;</span>
                        <span class="s">&#39;line: </span><span class="se">\n</span><span class="s">%s%s</span><span class="se">\n</span><span class="s">%s&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">typ</span><span class="p">,</span> <span class="n">ipos</span><span class="p">,</span> <span class="n">ipos</span><span class="o">+</span><span class="n">l</span><span class="p">,</span> <span class="n">ruler</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">mark</span><span class="p">))</span>

        <span class="n">ipos</span> <span class="o">+=</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">values</span></div>


<span class="n">_pattern_cache</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_nslc_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_pattern_cache</span><span class="p">:</span>
        <span class="n">rpattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="n">_pattern_cache</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpattern</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rpattern</span> <span class="o">=</span> <span class="n">_pattern_cache</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rpattern</span>


<div class="viewcode-block" id="match_nslc"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.match_nslc">[docs]</a><span class="k">def</span> <span class="nf">match_nslc</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Match network-station-location-channel code against pattern or list of</span>
<span class="sd">    patterns.</span>

<span class="sd">    :param patterns: pattern or list of patterns</span>
<span class="sd">    :param nslc: tuple with (network, station, location, channel) as strings</span>

<span class="sd">    :returns: ``True`` if the pattern matches or if any of the given patterns</span>
<span class="sd">        match; or ``False``.</span>

<span class="sd">    The patterns may contain shell-style wildcards: \*, ?, [seq], [!seq].</span>

<span class="sd">    Example::</span>

<span class="sd">        match_nslc(&#39;*.HAM3.*.BH?&#39;, (&#39;GR&#39;, &#39;HAM3&#39;, &#39;&#39;, &#39;BHZ&#39;))   # -&gt; True</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nslc</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nslc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">nslc</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_nslc_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">True</span>

    <span class="k">return</span> <span class="k">False</span></div>


<div class="viewcode-block" id="match_nslcs"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.match_nslcs">[docs]</a><span class="k">def</span> <span class="nf">match_nslcs</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslcs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get network-station-location-channel codes that match given pattern or any</span>
<span class="sd">    of several given patterns.</span>

<span class="sd">    :param patterns: pattern or list of patterns</span>
<span class="sd">    :param nslcs: list of (network, station, location, channel) tuples</span>

<span class="sd">    See also :py:func:`match_nslc`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">matching</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nslc</span> <span class="ow">in</span> <span class="n">nslcs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">match_nslc</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">nslc</span><span class="p">):</span>
            <span class="n">matching</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nslc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">matching</span></div>


<div class="viewcode-block" id="SoleError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.SoleError">[docs]</a><span class="k">class</span> <span class="nc">SoleError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exception raised by objects of type :py:class:`Sole`, when an concurrent</span>
<span class="sd">    instance is running.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="Sole"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.Sole">[docs]</a><span class="k">class</span> <span class="nc">Sole</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Use POSIX advisory file locking to ensure that only a single instance of a</span>
<span class="sd">    program is running.</span>

<span class="sd">    :param pid_path: path to lockfile to be used</span>

<span class="sd">    Usage::</span>

<span class="sd">        from pyrocko.util import Sole, SoleError, setup_logging</span>
<span class="sd">        import os</span>

<span class="sd">        setup_logging(&#39;my_program&#39;)</span>

<span class="sd">        pid_path =  os.path.join(os.environ[&#39;HOME&#39;], &#39;.my_program_lock&#39;)</span>
<span class="sd">        try:</span>
<span class="sd">            sole = Sole(pid_path)</span>

<span class="sd">        except SoleError, e:</span>
<span class="sd">            logger.fatal( str(e) )</span>
<span class="sd">            sys.exit(1)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span> <span class="o">=</span> <span class="n">pid_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span> <span class="o">=</span> <span class="k">False</span>
        <span class="n">ensuredirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="k">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SoleError</span><span class="p">(</span>
                <span class="s">&#39;Cannot open lockfile (path = %s)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span> <span class="o">=</span> <span class="k">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>

            <span class="k">raise</span> <span class="n">SoleError</span><span class="p">(</span><span class="s">&#39;Other instance is running (pid = %s)&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">ftruncate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="s">&#39;%i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="c"># the pid is only stored for user information, so this is allowed</span>
            <span class="c"># to fail</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_running</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">os</span>
            <span class="kn">import</span> <span class="nn">fcntl</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">lockf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lockfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid_path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>


<span class="n">re_escapequotes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;([&#39;</span><span class="se">\\</span><span class="s">])&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="escapequotes"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.escapequotes">[docs]</a><span class="k">def</span> <span class="nf">escapequotes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re_escapequotes</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;</span><span class="se">\\</span><span class="s">\1&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="TableWriter"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.TableWriter">[docs]</a><span class="k">class</span> <span class="nc">TableWriter</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Write table of space separated values to a file.</span>

<span class="sd">    :param f: file like object</span>

<span class="sd">    Strings containing spaces are quoted on output.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>

<div class="viewcode-block" id="TableWriter.writerow"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.TableWriter.writerow">[docs]</a>    <span class="k">def</span> <span class="nf">writerow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">minfieldwidths</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Write one row of values to underlying file.</span>

<span class="sd">        :param row: iterable of values</span>
<span class="sd">        :param minfieldwidths: minimum field widths for the values</span>

<span class="sd">        Each value in in ``row`` is converted to a string and optionally padded</span>
<span class="sd">        with blanks. The resulting strings are output separated with blanks. If</span>
<span class="sd">        any values given are strings and if they contain whitespace, they are</span>
<span class="sd">        quoted with single quotes, and any internal single quotes are</span>
<span class="sd">        backslash-escaped.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">minfieldwidths</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">minfieldwidths</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">minfieldwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;\s|&#39;&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;&#39;%s&#39;&quot;</span> <span class="o">%</span> <span class="n">escapequotes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TableReader"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.TableReader">[docs]</a><span class="k">class</span> <span class="nc">TableReader</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read table of space separated values from a file.</span>

<span class="sd">    :param f: file-like object</span>

<span class="sd">    This uses Pythons shlex module to tokenize lines. Should deal correctly</span>
<span class="sd">    with quoted strings.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="k">False</span>

<div class="viewcode-block" id="TableReader.readrow"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.TableReader.readrow">[docs]</a>    <span class="k">def</span> <span class="nf">readrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read one row from the underlying file, tokenize it with shlex.</span>

<span class="sd">        :returns: tokenized line as a list of strings.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eof</span> <span class="o">=</span> <span class="k">True</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">shlex</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">whitespace_split</span> <span class="o">=</span> <span class="k">True</span>
        <span class="n">s</span><span class="o">.</span><span class="n">whitespace</span> <span class="o">=</span> <span class="s">&#39; </span><span class="se">\t\n\r\f\v</span><span class="s">&#39;</span>  <span class="c"># compatible with re&#39;s \s</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="k">True</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">row</span></div></div>


<div class="viewcode-block" id="gform"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gform">[docs]</a><span class="k">def</span> <span class="nf">gform</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">significant_digits</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Pretty print floating point numbers.</span>

<span class="sd">    Align floating point numbers at the decimal dot.</span>

<span class="sd">    ::</span>

<span class="sd">      |  -d.dde+xxx|</span>
<span class="sd">      |  -d.dde+xx |</span>
<span class="sd">      |-ddd.       |</span>
<span class="sd">      | -dd.d      |</span>
<span class="sd">      |  -d.dd     |</span>
<span class="sd">      |  -0.ddd    |</span>
<span class="sd">      |  -0.0ddd   |</span>
<span class="sd">      |  -0.00ddd  |</span>
<span class="sd">      |  -d.dde-xx |</span>
<span class="sd">      |  -d.dde-xxx|</span>
<span class="sd">      |         nan|</span>


<span class="sd">    The formatted string has length ``significant_digits * 2 + 6``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">no_exp_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="nb">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">significant_digits</span><span class="p">))</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">significant_digits</span><span class="o">+</span><span class="n">significant_digits</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">5</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">no_exp_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">no_exp_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="n">number</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;%#.*g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significant_digits</span><span class="p">,</span> <span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;%.*E&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">significant_digits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">significant_digits</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;nan&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;nan&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="human_bytesize"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.human_bytesize">[docs]</a><span class="k">def</span> <span class="nf">human_bytesize</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>

    <span class="n">exts</span> <span class="o">=</span> <span class="s">&#39;Bytes kB MB GB TB PB EB ZB YB&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;1 Byte&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exts</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="n">i</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">10.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;%.1f %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1000.</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;%.0f %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&#39;%i Bytes&#39;</span> <span class="o">%</span> <span class="n">value</span></div>


<span class="n">re_compatibility</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">r&#39;!pyrocko\.(trace|gf\.(meta|seismosizer)|fomosto\.&#39;</span> <span class="o">+</span>
    <span class="s">r&#39;(dummy|poel|qseis|qssp))\.&#39;</span>
<span class="p">)</span>


<div class="viewcode-block" id="pf_is_old"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.pf_is_old">[docs]</a><span class="k">def</span> <span class="nf">pf_is_old</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">oldstyle</span> <span class="o">=</span> <span class="k">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re_compatibility</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">oldstyle</span> <span class="o">=</span> <span class="k">True</span>

    <span class="k">return</span> <span class="n">oldstyle</span></div>


<div class="viewcode-block" id="pf_upgrade"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.pf_upgrade">[docs]</a><span class="k">def</span> <span class="nf">pf_upgrade</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">need</span> <span class="o">=</span> <span class="n">pf_is_old</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">need</span><span class="p">:</span>
        <span class="n">fn_temp</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="s">&#39;.temp&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn_temp</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">re_compatibility</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;!pf.&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">fn_temp</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">need</span></div>


<div class="viewcode-block" id="read_leap_seconds"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.read_leap_seconds">[docs]</a><span class="k">def</span> <span class="nf">read_leap_seconds</span><span class="p">(</span><span class="n">tzfile</span><span class="o">=</span><span class="s">&#39;/usr/share/zoneinfo/right/UTC&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extract leap second information from tzdata.</span>

<span class="sd">    Based on example at http://stackoverflow.com/questions/19332902/\</span>
<span class="sd">            extract-historic-leap-seconds-from-tzdata</span>

<span class="sd">    See also &#39;man 5 tzfile&#39;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">struct</span> <span class="k">import</span> <span class="n">unpack</span><span class="p">,</span> <span class="n">calcsize</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tzfile</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c"># read header</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&gt;4s c 15x 6l&#39;</span>
        <span class="p">(</span><span class="n">magic</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">ttisgmtcnt</span><span class="p">,</span> <span class="n">ttisstdcnt</span><span class="p">,</span> <span class="n">leapcnt</span><span class="p">,</span> <span class="n">timecnt</span><span class="p">,</span>
            <span class="n">typecnt</span><span class="p">,</span> <span class="n">charcnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">magic</span> <span class="o">==</span> <span class="s">&#39;TZif&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;US-ASCII&#39;</span><span class="p">),</span> <span class="s">&#39;Not a timezone file&#39;</span>

        <span class="c"># skip over some uninteresting data</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&gt;%(timecnt)dl %(timecnt)dB %(ttinfo)s %(charcnt)ds&#39;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">timecnt</span><span class="o">=</span><span class="n">timecnt</span><span class="p">,</span> <span class="n">ttinfo</span><span class="o">=</span><span class="s">&#39;lBB&#39;</span><span class="o">*</span><span class="n">typecnt</span><span class="p">,</span> <span class="n">charcnt</span><span class="o">=</span><span class="n">charcnt</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>

        <span class="c"># read leap-seconds</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;&gt;2l&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">leapcnt</span><span class="p">):</span>
            <span class="n">tleap</span><span class="p">,</span> <span class="n">nleap</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tleap</span><span class="o">-</span><span class="n">nleap</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleap</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="LeapSecondsError"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.LeapSecondsError">[docs]</a><span class="k">class</span> <span class="nc">LeapSecondsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="LeapSecondsOutdated"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.LeapSecondsOutdated">[docs]</a><span class="k">class</span> <span class="nc">LeapSecondsOutdated</span><span class="p">(</span><span class="n">LeapSecondsError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="parse_leap_seconds_list"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.parse_leap_seconds_list">[docs]</a><span class="k">def</span> <span class="nf">parse_leap_seconds_list</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">texpires</span> <span class="o">=</span> <span class="k">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">str_to_time</span><span class="p">(</span><span class="s">&#39;1900-01-01 00:00:00&#39;</span><span class="p">)))</span>
    <span class="k">except</span> <span class="n">TimeStrError</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">str_to_time</span><span class="p">(</span><span class="s">&#39;1970-01-01 00:00:00&#39;</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">2208988800</span>

    <span class="n">tnow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">LeapSecondsOutdated</span><span class="p">(</span><span class="s">&#39;no leap seconds file found&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#@&#39;</span><span class="p">):</span>
                    <span class="n">texpires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">t0</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">t0</span>
                    <span class="n">nleap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">10</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">nleap</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LeapSecondsError</span><span class="p">(</span><span class="s">&#39;cannot read leap seconds file %s&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">texpires</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">tnow</span> <span class="o">&gt;</span> <span class="n">texpires</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LeapSecondsOutdated</span><span class="p">(</span><span class="s">&#39;leap seconds list is outdated&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="read_leap_seconds2"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.read_leap_seconds2">[docs]</a><span class="k">def</span> <span class="nf">read_leap_seconds2</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">config</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="p">()</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">leapseconds_path</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">leapseconds_url</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parse_leap_seconds_list</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">LeapSecondsOutdated</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;updating leap seconds list...&#39;</span><span class="p">)</span>
            <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LeapSecondsError</span><span class="p">(</span>
                <span class="s">&#39;cannot download leap seconds list from %s to %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">parse_leap_seconds_list</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="gps_utc_offset"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.gps_utc_offset">[docs]</a><span class="k">def</span> <span class="nf">gps_utc_offset</span><span class="p">(</span><span class="n">t_utc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Time offset t_gps - t_utc for a given t_utc.&#39;&#39;&#39;</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">read_leap_seconds2</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">t_utc</span> <span class="o">&lt;</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">9</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t_utc</span> <span class="ow">and</span> <span class="n">t_utc</span> <span class="o">&lt;</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span></div>


<div class="viewcode-block" id="utc_gps_offset"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.utc_gps_offset">[docs]</a><span class="k">def</span> <span class="nf">utc_gps_offset</span><span class="p">(</span><span class="n">t_gps</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Time offset t_utc - t_gps for a given t_gps.&#39;&#39;&#39;</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">read_leap_seconds2</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">t_gps</span> <span class="o">&lt;</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span> <span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span> <span class="o">&lt;=</span> <span class="n">t_gps</span> \
                <span class="ow">and</span> <span class="n">t_gps</span> <span class="o">&lt;</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span> <span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span> <span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_iload_family"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.make_iload_family">[docs]</a><span class="k">def</span> <span class="nf">make_iload_family</span><span class="p">(</span><span class="n">iload_fh</span><span class="p">,</span> <span class="n">doc_fmt</span><span class="o">=</span><span class="s">&#39;FMT&#39;</span><span class="p">,</span> <span class="n">doc_yielded_objects</span><span class="o">=</span><span class="s">&#39;FMT&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">from</span> <span class="nn">io_common</span> <span class="k">import</span> <span class="n">FileLoadError</span>

    <span class="k">def</span> <span class="nf">iload_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">iload_fh</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">cr</span>

        <span class="k">except</span> <span class="n">FileLoadError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">iload_dirname</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">iload_filename</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">cr</span>

    <span class="k">def</span> <span class="nf">iload_glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">fns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">iload_filename</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">cr</span>

    <span class="k">def</span> <span class="nf">iload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">iload_dirname</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">iload_filename</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">iload_glob</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">iload_fh</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
                <span class="n">iload</span><span class="p">(</span><span class="n">subsource</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">subsource</span> <span class="ow">in</span> <span class="n">source</span><span class="p">)</span>

    <span class="n">iload_filename</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        Read %s information from named file.</span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">doc_fmt</span>

    <span class="n">iload_dirname</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        Read %s information from directory of %s files.</span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doc_fmt</span><span class="p">,</span> <span class="n">doc_fmt</span><span class="p">)</span>

    <span class="n">iload_glob</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        Read %s information from files matching a glob pattern.</span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">doc_fmt</span>

    <span class="n">iload</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        Load %s information from given source(s)</span>

<span class="s">        The ``source`` can be specified as the name of a %s file, the name of a</span>
<span class="s">        directory containing %s files, a glob pattern of %s files, an open</span>
<span class="s">        filehandle or an iterator yielding any of the forementioned sources.</span>

<span class="s">        This function behaves as a generator yielding %s objects.</span>
<span class="s">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doc_fmt</span><span class="p">,</span> <span class="n">doc_fmt</span><span class="p">,</span> <span class="n">doc_fmt</span><span class="p">,</span> <span class="n">doc_fmt</span><span class="p">,</span> <span class="n">doc_yielded_objects</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">iload_filename</span><span class="p">,</span> <span class="n">iload_dirname</span><span class="p">,</span> <span class="n">iload_glob</span><span class="p">,</span> <span class="n">iload</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">__module__</span> <span class="o">=</span> <span class="n">iload_fh</span><span class="o">.</span><span class="n">__module__</span>

    <span class="k">return</span> <span class="n">iload_filename</span><span class="p">,</span> <span class="n">iload_dirname</span><span class="p">,</span> <span class="n">iload_glob</span><span class="p">,</span> <span class="n">iload</span></div>


<div class="viewcode-block" id="Inconsistency"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.Inconsistency">[docs]</a><span class="k">class</span> <span class="nc">Inconsistency</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="consistency_check"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.consistency_check">[docs]</a><span class="k">def</span> <span class="nf">consistency_check</span><span class="p">(</span><span class="n">list_of_tuples</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;values differ:&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check for inconsistencies.</span>

<span class="sd">    Given a list of tuples, check that all tuple elements except for first one</span>
<span class="sd">    match. E.g. ``[(&#39;STA.N&#39;, 55.3, 103.2), (&#39;STA.E&#39;, 55.3, 103.2)]`` would be</span>
<span class="sd">    valid because the coordinates at the two channels are the same.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_tuples</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">list_of_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">list_of_tuples</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">raise</span> <span class="n">Inconsistency</span><span class="p">(</span><span class="s">&#39;%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s">&#39;  %s: %s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;%g&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">list_of_tuples</span><span class="p">))</span></div>


<div class="viewcode-block" id="defaultzerodict"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.defaultzerodict">[docs]</a><span class="k">class</span> <span class="nc">defaultzerodict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="mostfrequent"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.mostfrequent">[docs]</a><span class="k">def</span> <span class="nf">mostfrequent</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">defaultzerodict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="consistency_merge"><a class="viewcode-back" href="../../library/reference/util.html#pyrocko.util.consistency_merge">[docs]</a><span class="k">def</span> <span class="nf">consistency_merge</span><span class="p">(</span><span class="n">list_of_tuples</span><span class="p">,</span>
                      <span class="n">message</span><span class="o">=</span><span class="s">&#39;values differ:&#39;</span><span class="p">,</span>
                      <span class="n">error</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">,</span>
                      <span class="n">merge</span><span class="o">=</span><span class="n">mostfrequent</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">error</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;raise&#39;</span><span class="p">,</span> <span class="s">&#39;warn&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_tuples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;cannot merge empty sequence&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">consistency_check</span><span class="p">(</span><span class="n">list_of_tuples</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_of_tuples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">except</span> <span class="n">Inconsistency</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">==</span> <span class="s">&#39;raise&#39;</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">elif</span> <span class="n">error</span> <span class="o">==</span> <span class="s">&#39;warn&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">merge</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_tuples</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]])</span></div>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Pyrocko Developers.
    </div>
  </body>
</html>