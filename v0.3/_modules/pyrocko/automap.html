<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyrocko.automap &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    

  </head>
  <body role="document">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &#187;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyrocko.automap</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>

<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="n">Object</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts_array</span> <span class="k">import</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome</span> <span class="k">as</span> <span class="n">od</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">gmtpy</span><span class="p">,</span> <span class="n">topo</span>

<span class="n">points_in_region</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">points_in_region</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;pyrocko.automap&#39;</span><span class="p">)</span>

<span class="n">earthradius</span> <span class="o">=</span> <span class="mf">6371000.0</span>
<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">r2d</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">d2m</span> <span class="o">=</span> <span class="n">d2r</span><span class="o">*</span><span class="n">earthradius</span>
<span class="n">m2d</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">d2m</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span>


<span class="k">def</span> <span class="nf">darken</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">corners</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    <span class="n">ll_lat</span><span class="p">,</span> <span class="n">ll_lon</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
    <span class="n">ur_lat</span><span class="p">,</span> <span class="n">ur_lon</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll_lon</span><span class="p">,</span> <span class="n">ll_lat</span><span class="p">,</span> <span class="n">ur_lon</span><span class="p">,</span> <span class="n">ur_lat</span>


<span class="k">def</span> <span class="nf">extent</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">slats</span><span class="p">,</span> <span class="n">slons</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">nlats</span><span class="p">,</span> <span class="n">nlons</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">south</span> <span class="o">=</span> <span class="n">slats</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">north</span> <span class="o">=</span> <span class="n">nlats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">wlats</span><span class="p">,</span> <span class="n">wlons</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">elats</span><span class="p">,</span> <span class="n">elons</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">elons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elons</span> <span class="o">&lt;</span> <span class="n">wlons</span><span class="p">,</span> <span class="n">elons</span> <span class="o">+</span> <span class="mf">360.</span><span class="p">,</span> <span class="n">elons</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">elons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">elons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">180</span> <span class="ow">or</span> <span class="n">wlons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">wlons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">180.</span><span class="p">:</span>
        <span class="n">west</span> <span class="o">=</span> <span class="o">-</span><span class="mf">180.</span>
        <span class="n">east</span> <span class="o">=</span> <span class="mf">180.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">west</span> <span class="o">=</span> <span class="n">wlons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">east</span> <span class="o">=</span> <span class="n">elons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">topo</span><span class="o">.</span><span class="n">positive_region</span><span class="p">((</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">NoTopo</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">OutOfBounds</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">FloatTile</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="k">None</span><span class="p">,</span> <span class="k">None</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">serialize_as</span><span class="o">=</span><span class="s">&#39;table&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_props</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_maxes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_maxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>

    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>

    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">))</span>
        <span class="n">iy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">))</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">iy</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfBounds</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">City</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">population</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">asciiname</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asciiname</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">asciiname</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">population</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">population</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">population</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="n">Object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span>
                        <span class="n">population</span><span class="o">=</span><span class="n">population</span><span class="p">,</span> <span class="n">asciiname</span><span class="o">=</span><span class="n">asciiname</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">Unicode</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">population</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">asciiname</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>


<div class="viewcode-block" id="Map"><a class="viewcode-back" href="../../library/reference/automap.html#pyrocko.automap.Map">[docs]</a><span class="k">class</span> <span class="nc">Map</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">14.</span><span class="p">)</span>
    <span class="n">margins</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">illuminate</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">skip_feature_factor</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">show_grid</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
    <span class="n">show_topo</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">show_topo_scale</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
    <span class="n">show_center_mark</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
    <span class="n">show_rivers</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">show_plates</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
    <span class="n">illuminate_factor_land</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">illuminate_factor_ocean</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">color_wet</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">254</span><span class="p">))</span>
    <span class="n">color_dry</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">172</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">165</span><span class="p">))</span>
    <span class="n">topo_resolution_min</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;minimum resolution of topography [dpi]&#39;</span><span class="p">)</span>
    <span class="n">topo_resolution_max</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">200.</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;maximum resolution of topography [dpi]&#39;</span><span class="p">)</span>
    <span class="n">replace_topo_color_only</span> <span class="o">=</span> <span class="n">FloatTile</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;replace topo color while keeping topographic shading&#39;</span><span class="p">)</span>
    <span class="n">topo_cpt_wet</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;light_sea&#39;</span><span class="p">)</span>
    <span class="n">topo_cpt_dry</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&#39;light_land&#39;</span><span class="p">)</span>
    <span class="n">axes_layout</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">custom_cities</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">City</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">gmt_config</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gmtversion</span><span class="o">=</span><span class="s">&#39;newest&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">Object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minarea</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coastline_resolution</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rivers</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dems</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_land</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo_have</span> <span class="o">=</span> <span class="k">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_area_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gmtversion</span> <span class="o">=</span> <span class="n">gmtversion</span>

<div class="viewcode-block" id="Map.save"><a class="viewcode-back" href="../../library/reference/automap.html#pyrocko.automap.Map.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">75.</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
             <span class="n">width</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save the image.</span>

<span class="sd">        Save the image to ``outpath``. The format is determined by the filename</span>
<span class="sd">        extension. Formats are handled as follows: ``&#39;.eps&#39;`` and ``&#39;.ps&#39;``</span>
<span class="sd">        produce EPS and PS, respectively, directly with GMT. If the file name</span>
<span class="sd">        ends with ``&#39;.pdf&#39;``, GMT output is fed through ``gmtpy-epstopdf`` to</span>
<span class="sd">        create a PDF file. For any other filename extension, output is first</span>
<span class="sd">        converted to PDF with ``gmtpy-epstopdf``, then with ``pdftocairo`` to</span>
<span class="sd">        PNG with a resolution oversampled by the factor ``oversample`` and</span>
<span class="sd">        finally the PNG is downsampled and converted to the target format with</span>
<span class="sd">        ``convert``. The resolution of rasterized target image can be</span>
<span class="sd">        controlled either by ``resolution`` in DPI or by specifying ``width``</span>
<span class="sd">        or ``height`` or ``size``, where the latter fits the image into a</span>
<span class="sd">        square with given side length.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_axes</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_topo</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_topo_scale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_topo_scale</span><span class="p">()</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span>
                 <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_geometry</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wesn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_geometry</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jxyr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pxyr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pxyr</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pxyr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_background</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_geometry</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_lod</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_gmt</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wpage</span><span class="p">,</span> <span class="n">hpage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
        <span class="n">ml</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_margins</span><span class="p">()</span>
        <span class="n">wpage</span> <span class="o">-=</span> <span class="n">ml</span> <span class="o">+</span> <span class="n">mr</span>
        <span class="n">hpage</span> <span class="o">-=</span> <span class="n">mt</span> <span class="o">+</span> <span class="n">mb</span>

        <span class="n">wreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="n">hreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="n">wpage</span> <span class="o">&gt;=</span> <span class="n">hpage</span><span class="p">:</span>
            <span class="n">wreg</span> <span class="o">*=</span> <span class="n">wpage</span><span class="o">/</span><span class="n">hpage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hreg</span> <span class="o">*=</span> <span class="n">hpage</span><span class="o">/</span><span class="n">wpage</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wreg</span> <span class="o">=</span> <span class="n">wreg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hreg</span> <span class="o">=</span> <span class="n">hreg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span> <span class="o">=</span> <span class="n">corners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">wreg</span><span class="p">,</span> <span class="n">hreg</span><span class="p">)</span>
        <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">extent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">wreg</span><span class="p">,</span> <span class="n">hreg</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">((</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">),</span> <span class="p">(</span><span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">6000.</span><span class="p">,</span> <span class="mf">4500.</span><span class="p">))</span>

        <span class="n">xax</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">Ax</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;min-max&#39;</span><span class="p">,</span> <span class="n">approx_ticks</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>
        <span class="n">yax</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">Ax</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;min-max&#39;</span><span class="p">,</span> <span class="n">approx_ticks</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>
        <span class="n">zax</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">Ax</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;min-max&#39;</span><span class="p">,</span> <span class="n">inc</span><span class="o">=</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Height&#39;</span><span class="p">,</span>
                       <span class="n">scaled_unit</span><span class="o">=</span><span class="s">&#39;km&#39;</span><span class="p">,</span> <span class="n">scaled_unit_factor</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="n">scaler</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">ScaleGuru</span><span class="p">(</span><span class="n">data_tuples</span><span class="o">=</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="n">xax</span><span class="p">,</span> <span class="n">yax</span><span class="p">,</span> <span class="n">zax</span><span class="p">))</span>

        <span class="n">par</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

        <span class="n">west</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s">&#39;xmin&#39;</span><span class="p">]</span>
        <span class="n">east</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s">&#39;xmax&#39;</span><span class="p">]</span>
        <span class="n">south</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s">&#39;ymin&#39;</span><span class="p">]</span>
        <span class="n">north</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s">&#39;ymax&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span> <span class="o">=</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">scaler</span>

    <span class="k">def</span> <span class="nf">_setup_lod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">&gt;</span> <span class="mf">1500.</span><span class="o">*</span><span class="n">km</span><span class="p">:</span>
            <span class="n">coastline_resolution</span> <span class="o">=</span> <span class="s">&#39;i&#39;</span>
            <span class="n">rivers</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coastline_resolution</span> <span class="o">=</span> <span class="s">&#39;f&#39;</span>
            <span class="n">rivers</span> <span class="o">=</span> <span class="k">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_minarea</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_feature_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">/</span><span class="n">km</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coastline_resolution</span> <span class="o">=</span> <span class="n">coastline_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rivers</span> <span class="o">=</span> <span class="n">rivers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo_have</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dems</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">cm2inch</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="o">/</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">inch</span>

        <span class="n">dmin</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">m2d</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_resolution_max</span> <span class="o">*</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">cm2inch</span><span class="p">))</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="n">m2d</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_resolution_min</span> <span class="o">*</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">cm2inch</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;ocean&#39;</span><span class="p">,</span> <span class="s">&#39;land&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dems</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">select_dem_names</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dems</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;using topography dataset %s for %s&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dems</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span> <span class="n">k</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_expand_margins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">mr</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">mb</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">mr</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">mr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">ml</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margins</span>

        <span class="k">return</span> <span class="n">ml</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">mb</span>

    <span class="k">def</span> <span class="nf">_setup_gmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>

        <span class="k">if</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gmtversion</span><span class="p">):</span>
            <span class="n">gmtconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">MAP_TICK_PEN_PRIMARY</span><span class="o">=</span><span class="s">&#39;1.25p&#39;</span><span class="p">,</span>
                <span class="n">MAP_TICK_PEN_SECONDARY</span><span class="o">=</span><span class="s">&#39;1.25p&#39;</span><span class="p">,</span>
                <span class="n">MAP_TICK_LENGTH_PRIMARY</span><span class="o">=</span><span class="s">&#39;0.2c&#39;</span><span class="p">,</span>
                <span class="n">MAP_TICK_LENGTH_SECONDARY</span><span class="o">=</span><span class="s">&#39;0.6c&#39;</span><span class="p">,</span>
                <span class="n">FONT_ANNOT_PRIMARY</span><span class="o">=</span><span class="s">&#39;12p,1,black&#39;</span><span class="p">,</span>
                <span class="n">FONT_LABEL</span><span class="o">=</span><span class="s">&#39;12p,1,black&#39;</span><span class="p">,</span>
                <span class="n">PS_CHAR_ENCODING</span><span class="o">=</span><span class="s">&#39;ISOLatin1+&#39;</span><span class="p">,</span>
                <span class="n">MAP_FRAME_TYPE</span><span class="o">=</span><span class="s">&#39;fancy&#39;</span><span class="p">,</span>
                <span class="n">FORMAT_GEO_MAP</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                <span class="n">PS_MEDIA</span><span class="o">=</span><span class="s">&#39;Custom_%ix%i&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">w</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span>
                    <span class="n">h</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
                <span class="n">PS_PAGE_ORIENTATION</span><span class="o">=</span><span class="s">&#39;portrait&#39;</span><span class="p">,</span>
                <span class="n">MAP_GRID_PEN_PRIMARY</span><span class="o">=</span><span class="s">&#39;thinnest,0/50/0&#39;</span><span class="p">,</span>
                <span class="n">MAP_ANNOT_OBLIQUE</span><span class="o">=</span><span class="s">&#39;6&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gmtconf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">TICK_PEN</span><span class="o">=</span><span class="s">&#39;1.25p&#39;</span><span class="p">,</span>
                <span class="n">TICK_LENGTH</span><span class="o">=</span><span class="s">&#39;0.2c&#39;</span><span class="p">,</span>
                <span class="n">ANNOT_FONT_PRIMARY</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">,</span>
                <span class="n">ANNOT_FONT_SIZE_PRIMARY</span><span class="o">=</span><span class="s">&#39;12p&#39;</span><span class="p">,</span>
                <span class="n">LABEL_FONT</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">,</span>
                <span class="n">LABEL_FONT_SIZE</span><span class="o">=</span><span class="s">&#39;12p&#39;</span><span class="p">,</span>
                <span class="n">CHAR_ENCODING</span><span class="o">=</span><span class="s">&#39;ISOLatin1+&#39;</span><span class="p">,</span>
                <span class="n">BASEMAP_TYPE</span><span class="o">=</span><span class="s">&#39;fancy&#39;</span><span class="p">,</span>
                <span class="n">PLOT_DEGREE_FORMAT</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                <span class="n">PAPER_MEDIA</span><span class="o">=</span><span class="s">&#39;Custom_%ix%i&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">w</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span>
                    <span class="n">h</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
                <span class="n">GRID_PEN_PRIMARY</span><span class="o">=</span><span class="s">&#39;thinnest/0/50/0&#39;</span><span class="p">,</span>
                <span class="n">DOTS_PR_INCH</span><span class="o">=</span><span class="s">&#39;1200&#39;</span><span class="p">,</span>
                <span class="n">OBLIQUE_ANNOTATION</span><span class="o">=</span><span class="s">&#39;6&#39;</span><span class="p">)</span>

        <span class="n">gmtconf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt_config</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

        <span class="n">gmt</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GMT</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">gmtconf</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gmtversion</span><span class="p">)</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">default_layout</span><span class="p">()</span>

        <span class="n">layout</span><span class="o">.</span><span class="n">set_fixed_margins</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">cm</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_margins</span><span class="p">()])</span>

        <span class="n">widget</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">get_widget</span><span class="p">()</span>
        <span class="n">widget</span><span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">widget</span><span class="p">[</span><span class="s">&#39;J&#39;</span><span class="p">]</span>
        <span class="n">widget</span><span class="p">[</span><span class="s">&#39;J&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;-JA%g/%g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;/%(width)gp&#39;</span>
        <span class="n">scaler</span><span class="p">[</span><span class="s">&#39;R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;-R%g/%g/%g/%gr&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span>

        <span class="c"># aspect = gmtpy.aspect_for_projection(</span>
        <span class="c">#     gmt.installation[&#39;version&#39;], *(widget.J() + scaler.R()))</span>

        <span class="n">aspect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_aspect</span><span class="p">(</span><span class="n">jr</span><span class="o">=</span><span class="n">widget</span><span class="o">.</span><span class="n">J</span><span class="p">()</span> <span class="o">+</span> <span class="n">scaler</span><span class="o">.</span><span class="n">R</span><span class="p">())</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">aspect</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span> <span class="o">=</span> <span class="n">gmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layout</span> <span class="o">=</span> <span class="n">layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span> <span class="o">=</span> <span class="n">widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span><span class="o">.</span><span class="n">JXY</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">R</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pxyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span><span class="o">.</span><span class="n">PXY</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&#39;-R%g/%g/%g/%g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">height</span><span class="p">())]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_axes</span> <span class="o">=</span> <span class="k">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_labels</span> <span class="o">=</span> <span class="k">False</span>

    <span class="k">def</span> <span class="nf">_draw_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_land</span> <span class="o">=</span> <span class="k">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_topo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_topo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_draw_basefeatures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_topo_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">demname</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">for</span> <span class="n">dem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dems</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span><span class="p">)</span>
            <span class="n">demname</span> <span class="o">=</span> <span class="n">dem</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoTopo</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">demname</span>

    <span class="k">def</span> <span class="nf">_prep_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">demname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_topo_tile</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">demname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo_have</span><span class="p">:</span>

            <span class="n">grdfile</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span>

            <span class="n">is_flat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="n">gmtpy</span><span class="o">.</span><span class="n">savegrd</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span> <span class="n">naming</span><span class="o">=</span><span class="s">&#39;lonlat&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">illuminate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_flat</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;ocean&#39;</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">illuminate_factor_ocean</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">illuminate_factor_land</span>

                <span class="n">ilumfn</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span>
                <span class="n">gmt</span><span class="o">.</span><span class="n">grdgradient</span><span class="p">(</span>
                    <span class="n">grdfile</span><span class="p">,</span>
                    <span class="n">N</span><span class="o">=</span><span class="s">&#39;e%g&#39;</span> <span class="o">%</span> <span class="n">factor</span><span class="p">,</span>
                    <span class="n">A</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span>
                    <span class="n">G</span><span class="o">=</span><span class="n">ilumfn</span><span class="p">,</span>
                    <span class="n">out_discard</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

                <span class="n">ilumargs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-I%s&#39;</span> <span class="o">%</span> <span class="n">ilumfn</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ilumargs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_topo_color_only</span><span class="p">:</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_topo_color_only</span>
                <span class="n">grdfile2</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span>

                <span class="n">gmtpy</span><span class="o">.</span><span class="n">savegrd</span><span class="p">(</span>
                    <span class="n">t2</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">t2</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">t2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">grdfile2</span><span class="p">,</span>
                    <span class="n">naming</span><span class="o">=</span><span class="s">&#39;lonlat&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                    <span class="n">gmt</span><span class="o">.</span><span class="n">grdsample</span><span class="p">(</span>
                        <span class="n">grdfile2</span><span class="p">,</span>
                        <span class="n">G</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span>
                        <span class="n">n</span><span class="o">=</span><span class="s">&#39;l&#39;</span><span class="p">,</span>
                        <span class="n">I</span><span class="o">=</span><span class="s">&#39;%g/%g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dy</span><span class="p">),</span>
                        <span class="n">R</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span>
                        <span class="n">out_discard</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gmt</span><span class="o">.</span><span class="n">grdsample</span><span class="p">(</span>
                        <span class="n">grdfile2</span><span class="p">,</span>
                        <span class="n">G</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span>
                        <span class="n">Q</span><span class="o">=</span><span class="s">&#39;l&#39;</span><span class="p">,</span>
                        <span class="n">I</span><span class="o">=</span><span class="s">&#39;%g/%g&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dy</span><span class="p">),</span>
                        <span class="n">R</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span>
                        <span class="n">out_discard</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

                <span class="n">gmt</span><span class="o">.</span><span class="n">grdmath</span><span class="p">(</span>
                    <span class="n">grdfile</span><span class="p">,</span> <span class="s">&#39;0.0&#39;</span><span class="p">,</span> <span class="s">&#39;AND&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">grdfile2</span><span class="p">,</span>
                    <span class="n">out_discard</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

                <span class="n">grdfile</span> <span class="o">=</span> <span class="n">grdfile2</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo_have</span><span class="p">[</span><span class="n">demname</span><span class="p">]</span> <span class="o">=</span> <span class="n">grdfile</span><span class="p">,</span> <span class="n">ilumargs</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo_have</span><span class="p">[</span><span class="n">demname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_draw_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>
        <span class="n">cres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coastline_resolution</span>
        <span class="n">minarea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minarea</span>

        <span class="n">JXY</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">JXY</span><span class="p">()</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">R</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">grdfile</span><span class="p">,</span> <span class="n">ilumargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo</span><span class="p">(</span><span class="s">&#39;ocean&#39;</span><span class="p">)</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span><span class="n">D</span><span class="o">=</span><span class="n">cres</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">minarea</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grdfile</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">topo</span><span class="o">.</span><span class="n">cpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_cpt_wet</span><span class="p">),</span>
                         <span class="o">*</span><span class="p">(</span><span class="n">ilumargs</span><span class="o">+</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">except</span> <span class="n">NoTopo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span> <span class="o">=</span> <span class="k">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">grdfile</span><span class="p">,</span> <span class="n">ilumargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_topo</span><span class="p">(</span><span class="s">&#39;land&#39;</span><span class="p">)</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span><span class="n">D</span><span class="o">=</span><span class="n">cres</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">minarea</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grdfile</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">topo</span><span class="o">.</span><span class="n">cpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_cpt_dry</span><span class="p">),</span>
                         <span class="o">*</span><span class="p">(</span><span class="n">ilumargs</span><span class="o">+</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span><span class="n">Q</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">JXY</span><span class="o">+</span><span class="n">R</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_land</span> <span class="o">=</span> <span class="k">True</span>
        <span class="k">except</span> <span class="n">NoTopo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_land</span> <span class="o">=</span> <span class="k">False</span>

    <span class="k">def</span> <span class="nf">_draw_topo_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;Elevation [km]&#39;</span><span class="p">):</span>
        <span class="n">dry</span> <span class="o">=</span> <span class="n">read_cpt</span><span class="p">(</span><span class="n">topo</span><span class="o">.</span><span class="n">cpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_cpt_dry</span><span class="p">))</span>
        <span class="n">wet</span> <span class="o">=</span> <span class="n">read_cpt</span><span class="p">(</span><span class="n">topo</span><span class="o">.</span><span class="n">cpt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topo_cpt_wet</span><span class="p">))</span>
        <span class="n">combi</span> <span class="o">=</span> <span class="n">cpt_merge_wet_dry</span><span class="p">(</span><span class="n">wet</span><span class="p">,</span> <span class="n">dry</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">combi</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">/=</span> <span class="n">km</span>
            <span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">/=</span> <span class="n">km</span>

        <span class="n">topo_cpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;.cpt&#39;</span>
        <span class="n">write_cpt</span><span class="p">(</span><span class="n">combi</span><span class="p">,</span> <span class="n">topo_cpt</span><span class="p">)</span>

        <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psscale</span><span class="p">(</span>
            <span class="n">D</span><span class="o">=</span><span class="s">&#39;%gp/%gp/%gp/%gph&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xo</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">yo</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span>
                                    <span class="mf">0.5</span><span class="o">*</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
            <span class="n">C</span><span class="o">=</span><span class="n">topo_cpt</span><span class="p">,</span>
            <span class="n">B</span><span class="o">=</span><span class="s">&#39;1:%s:&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_draw_basefeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>
        <span class="n">cres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coastline_resolution</span>
        <span class="n">rivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rivers</span>
        <span class="n">minarea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minarea</span>

        <span class="n">color_wet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_wet</span>
        <span class="n">color_dry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_dry</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_rivers</span> <span class="ow">and</span> <span class="n">rivers</span><span class="p">:</span>
            <span class="n">rivers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-Ir/0.25p,%s&#39;</span> <span class="o">%</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_wet</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rivers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fill</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_land</span><span class="p">:</span>
            <span class="n">fill</span><span class="p">[</span><span class="s">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_dry</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_topo_ocean</span><span class="p">:</span>
            <span class="n">fill</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_wet</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span>
            <span class="n">D</span><span class="o">=</span><span class="n">cres</span><span class="p">,</span>
            <span class="n">W</span><span class="o">=</span><span class="s">&#39;thinnest,%s&#39;</span> <span class="o">%</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">darken</span><span class="p">(</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">color_tup</span><span class="p">(</span><span class="n">color_dry</span><span class="p">))),</span>
            <span class="n">A</span><span class="o">=</span><span class="n">minarea</span><span class="p">,</span>
            <span class="o">*</span><span class="p">(</span><span class="n">rivers</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span><span class="p">),</span> <span class="o">**</span><span class="n">fill</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_plates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_plates</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_draw_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_layout</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">axes_layout</span> <span class="o">=</span> <span class="s">&#39;WSen&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes_layout</span> <span class="o">=</span> <span class="s">&#39;WseN&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_layout</span>

        <span class="n">scale_km</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">nice_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_center_mark</span><span class="p">:</span>
            <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                <span class="n">in_rows</span><span class="o">=</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">]],</span>
                <span class="n">S</span><span class="o">=</span><span class="s">&#39;c20p&#39;</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="s">&#39;2p,black&#39;</span><span class="p">,</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_grid</span><span class="p">:</span>
            <span class="n">btmpl</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;%(xinc)gg%(xinc)g:%(xlabel)s:/&#39;</span>
                     <span class="s">&#39;%(yinc)gg%(yinc)g:%(ylabel)s:&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">btmpl</span> <span class="o">=</span> <span class="s">&#39;%(xinc)g:%(xlabel)s:/%(yinc)g:%(ylabel)s:&#39;</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">psbasemap</span><span class="p">(</span>
            <span class="n">B</span><span class="o">=</span><span class="p">(</span><span class="n">btmpl</span> <span class="o">%</span> <span class="n">scaler</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span><span class="o">+</span><span class="n">axes_layout</span><span class="p">,</span>
            <span class="n">L</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;x%gp/%gp/%g/%g/%gk&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="mf">6.</span><span class="o">/</span><span class="mi">7</span><span class="o">*</span><span class="n">widget</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">/</span><span class="mf">7.</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                <span class="n">scale_km</span><span class="p">)),</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
            <span class="n">font_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">label_font_size</span><span class="p">()</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span>
            <span class="k">if</span> <span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s">&#39;%gp,%s,%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;black&#39;</span><span class="p">),</span> <span class="s">&#39;BR&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">]</span>

                <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-F+f+j&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;BR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">]</span>
                <span class="n">farg</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">gmt</span><span class="o">.</span><span class="n">pstext</span><span class="p">(</span>
                <span class="n">in_rows</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">],</span>
                <span class="n">N</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
                <span class="n">R</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">D</span><span class="o">=</span><span class="s">&#39;%gp/%gp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">font_size</span><span class="o">*</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">font_size</span><span class="o">*</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="o">*</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">PXY</span><span class="p">()</span> <span class="o">+</span> <span class="n">farg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">draw_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_axes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_axes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_axes</span> <span class="o">=</span> <span class="k">True</span>

    <span class="k">def</span> <span class="nf">_have_coastlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gmt</span>
        <span class="n">cres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coastline_resolution</span>
        <span class="n">minarea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minarea</span>

        <span class="n">checkfile</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span>
            <span class="n">M</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">D</span><span class="o">=</span><span class="n">cres</span><span class="p">,</span>
            <span class="n">W</span><span class="o">=</span><span class="s">&#39;thinnest,black&#39;</span><span class="p">,</span>
            <span class="n">A</span><span class="o">=</span><span class="n">minarea</span><span class="p">,</span>
            <span class="n">out_filename</span><span class="o">=</span><span class="n">checkfile</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_jxyr</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkfile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ls</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ls</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ls</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">plon</span><span class="p">,</span> <span class="n">plat</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ls</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">))</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points_in_region</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">have_coastlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_coastlines</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">jr</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">onepoint</span> <span class="o">=</span> <span class="k">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">lats</span><span class="p">]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">lons</span><span class="p">]</span>
            <span class="n">onepoint</span> <span class="o">=</span> <span class="k">True</span>

        <span class="k">if</span> <span class="n">jr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">j</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">jr</span>
            <span class="n">gmt</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GMT</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gmtversion</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span>
            <span class="n">gmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">gmt</span><span class="o">.</span><span class="n">mapproject</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">),</span> <span class="n">out_stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="s">&#39;p&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">onepoint</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>

    <span class="k">def</span> <span class="nf">_map_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jr</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">ll_lon</span><span class="p">,</span> <span class="n">ll_lat</span><span class="p">,</span> <span class="n">ur_lon</span><span class="p">,</span> <span class="n">ur_lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corners</span>

        <span class="n">xs_corner</span><span class="p">,</span> <span class="n">ys_corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ll_lat</span><span class="p">,</span> <span class="n">ur_lat</span><span class="p">),</span> <span class="p">(</span><span class="n">ll_lon</span><span class="p">,</span> <span class="n">ur_lon</span><span class="p">),</span> <span class="n">jr</span><span class="o">=</span><span class="n">jr</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">xs_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xs_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">ys_corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ys_corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_map_aspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jr</span><span class="o">=</span><span class="k">None</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_box</span><span class="p">(</span><span class="n">jr</span><span class="o">=</span><span class="n">jr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">/</span><span class="n">w</span>

    <span class="k">def</span> <span class="nf">_draw_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">points_taken</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regions_taken</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">no_points_in_rect</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">la</span><span class="p">(</span><span class="n">la</span><span class="p">(</span><span class="n">xmin</span> <span class="o">&lt;</span> <span class="n">xs</span><span class="p">,</span> <span class="n">xs</span> <span class="o">&lt;</span> <span class="n">xmax</span><span class="p">),</span>
                                <span class="n">la</span><span class="p">(</span><span class="n">ymin</span> <span class="o">&lt;</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ys</span> <span class="o">&lt;</span> <span class="n">ymax</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">xx</span>

        <span class="k">def</span> <span class="nf">roverlaps</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_box</span><span class="p">()</span>

        <span class="n">label_font_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">label_font_size</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>

            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">)</span>

            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">fonts</span><span class="p">,</span> <span class="n">font_sizes</span><span class="p">,</span> <span class="n">styles</span> <span class="o">=</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">)</span>

            <span class="n">font_sizes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">font_size</span> <span class="ow">or</span> <span class="n">label_font_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">font_size</span> <span class="ow">in</span> <span class="n">font_sizes</span><span class="p">]</span>

            <span class="n">sx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

            <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>

            <span class="n">points_taken</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">))</span>

            <span class="n">dxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">dys</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">text_box</span><span class="p">(</span>
                    <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">font</span><span class="o">=</span><span class="n">fonts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">font_size</span><span class="o">=</span><span class="n">font_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">styles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="n">dxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
                <span class="n">dys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span>

            <span class="n">la</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span>
            <span class="n">anchors_ok</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">la</span><span class="p">(</span><span class="n">xs</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">dxs</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">,</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">dys</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">),</span>
                <span class="n">la</span><span class="p">(</span><span class="n">xs</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">dxs</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">sy</span> <span class="o">-</span> <span class="n">dys</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">),</span>
                <span class="n">la</span><span class="p">(</span><span class="n">xs</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">dxs</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">,</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">sy</span> <span class="o">-</span> <span class="n">dys</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">),</span>
                <span class="n">la</span><span class="p">(</span><span class="n">xs</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">dxs</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">dys</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">arects</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">dys</span><span class="p">),</span>
                <span class="p">(</span><span class="n">xs</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">sy</span> <span class="o">-</span> <span class="n">dys</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">),</span>
                <span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">sy</span> <span class="o">-</span> <span class="n">dys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">+</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">ys</span><span class="p">),</span>
                <span class="p">(</span><span class="n">xs</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">-</span> <span class="n">dxs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">sy</span> <span class="o">+</span> <span class="n">dys</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ianch</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                    <span class="n">anchors_ok</span><span class="p">[</span><span class="n">ianch</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">no_points_in_rect</span><span class="p">(</span>
                        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">xxx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">arects</span><span class="p">[</span><span class="n">ianch</span><span class="p">]])</span>

            <span class="n">anchor_choices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">anchor_take</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">ianch</span> <span class="k">for</span> <span class="n">ianch</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">anchors_ok</span><span class="p">[</span><span class="n">ianch</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">anchor_choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">choices</span><span class="p">:</span>
                    <span class="n">anchor_take</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anchor_take</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">anchor_take</span><span class="p">):</span>
                <span class="n">noverlaps</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                            <span class="n">i_take</span> <span class="o">=</span> <span class="n">anchor_take</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">j_take</span> <span class="o">=</span> <span class="n">anchor_take</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">i_take</span> <span class="ow">is</span> <span class="k">None</span> <span class="ow">or</span> <span class="n">j_take</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">r_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">xxx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">arects</span><span class="p">[</span><span class="n">i_take</span><span class="p">]]</span>
                            <span class="n">r_j</span> <span class="o">=</span> <span class="p">[</span><span class="n">xxx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">arects</span><span class="p">[</span><span class="n">j_take</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">roverlaps</span><span class="p">(</span><span class="n">r_i</span><span class="p">,</span> <span class="n">r_j</span><span class="p">):</span>
                                <span class="n">noverlaps</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">noverlaps</span>

            <span class="n">cur_cost</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">anchor_take</span><span class="p">)</span>
            <span class="n">imax</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="k">while</span> <span class="n">cur_cost</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">imax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">anchor_choices</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">anchor_take_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anchor_take</span><span class="p">)</span>
                        <span class="n">anchor_take_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">new_cost</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">anchor_take_new</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_cost</span> <span class="o">&lt;</span> <span class="n">cur_cost</span><span class="p">:</span>
                            <span class="n">anchor_take</span> <span class="o">=</span> <span class="n">anchor_take_new</span>
                            <span class="n">cur_cost</span> <span class="o">=</span> <span class="n">new_cost</span>

                <span class="n">imax</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="n">cur_cost</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">anchor_take_new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anchor_take</span><span class="p">)</span>
                    <span class="n">anchor_take_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">None</span>
                    <span class="n">new_cost</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">anchor_take_new</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_cost</span> <span class="o">&lt;</span> <span class="n">cur_cost</span><span class="p">:</span>
                        <span class="n">anchor_take</span> <span class="o">=</span> <span class="n">anchor_take_new</span>
                        <span class="n">cur_cost</span> <span class="o">=</span> <span class="n">new_cost</span>
                        <span class="k">break</span>

            <span class="n">anchor_strs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;BL&#39;</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">,</span> <span class="s">&#39;TL&#39;</span><span class="p">,</span> <span class="s">&#39;BR&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">ianchor</span> <span class="o">=</span> <span class="n">anchor_take</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>

                <span class="k">if</span> <span class="n">ianchor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">regions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xxx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">arects</span><span class="p">[</span><span class="n">ianchor</span><span class="p">]])</span>

                    <span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor_strs</span><span class="p">[</span><span class="n">ianchor</span><span class="p">]</span>

                    <span class="n">yoff</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sy</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">anchor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span><span class="p">]</span>
                    <span class="n">xoff</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;L&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="s">&#39;%i,%s,%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">font_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fonts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="p">),</span>
                            <span class="n">anchor</span><span class="p">,</span>
                            <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                        <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-F+f+j&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">font_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fonts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">anchor</span><span class="p">,</span>
                            <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-G%s&#39;</span> <span class="o">%</span> <span class="n">color</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">pstext</span><span class="p">(</span>
                        <span class="n">in_rows</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">],</span>
                        <span class="n">D</span><span class="o">=</span><span class="s">&#39;%gp/%gp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xoff</span><span class="p">,</span> <span class="n">yoff</span><span class="p">),</span>
                        <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span> <span class="o">+</span> <span class="n">farg</span><span class="p">),</span>
                        <span class="o">**</span><span class="n">styles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_area_labels</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">style</span> <span class="ow">in</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_area_labels</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">font_size</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">font_size</span> <span class="o">=</span> <span class="n">label_font_size</span>

                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                    <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-F+f+j&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-G%s&#39;</span> <span class="o">%</span> <span class="n">color</span><span class="p">]</span>

                <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">text_box</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">)</span>

                <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span><span class="n">xs</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">ys</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="n">xs</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">ys</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dy</span><span class="p">]</span>

                <span class="n">locs_ok</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">iloc</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">rcandi</span> <span class="o">=</span> <span class="p">[</span><span class="n">xxx</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">]</span>

                    <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="o">=</span> <span class="k">True</span>
                    <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">(</span>
                        <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rcandi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rcandi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">w</span>
                        <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rcandi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rcandi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">)</span>

                    <span class="n">overlap</span> <span class="o">=</span> <span class="k">False</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions_taken</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">roverlaps</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rcandi</span><span class="p">):</span>
                            <span class="n">overlap</span> <span class="o">=</span> <span class="k">True</span>
                            <span class="k">break</span>

                    <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="ow">not</span> <span class="n">overlap</span>

                    <span class="k">for</span> <span class="n">xs_taken</span><span class="p">,</span> <span class="n">ys_taken</span> <span class="ow">in</span> <span class="n">points_taken</span><span class="p">:</span>
                        <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">no_points_in_rect</span><span class="p">(</span>
                            <span class="n">xs_taken</span><span class="p">,</span> <span class="n">ys_taken</span><span class="p">,</span> <span class="o">*</span><span class="n">rcandi</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]:</span>
                            <span class="k">break</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">iloc</span><span class="p">,</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">locs_ok</span><span class="p">[</span><span class="n">iloc</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                            <span class="s">&#39;%i,%s,%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">color</span><span class="p">),</span>
                            <span class="s">&#39;MC&#39;</span><span class="p">,</span>
                            <span class="n">text</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                            <span class="n">font_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="s">&#39;MC&#39;</span><span class="p">,</span>
                            <span class="n">text</span><span class="p">)</span>

                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                    <span class="n">regions_taken</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xxx</span><span class="p">[</span><span class="n">iloc</span><span class="p">]</span> <span class="k">for</span> <span class="n">xxx</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">])</span>
                    <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">pstext</span><span class="p">(</span>
                    <span class="n">in_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                    <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span> <span class="o">+</span> <span class="n">farg</span><span class="p">),</span>
                    <span class="o">**</span><span class="n">style</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_draw_labels</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_have_drawn_labels</span> <span class="o">=</span> <span class="k">True</span>

    <span class="k">def</span> <span class="nf">add_label</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
            <span class="n">offset_x</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">offset_y</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{}):</span>

        <span class="k">if</span> <span class="s">&#39;G&#39;</span> <span class="ow">in</span> <span class="n">style</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;G&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span>
             <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_area_label</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="s">&#39;3&#39;</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{}):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_area_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cities_in_region</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">geonames</span>
        <span class="n">cities</span> <span class="o">=</span> <span class="n">geonames</span><span class="o">.</span><span class="n">get_cities_region</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wesn</span><span class="p">,</span> <span class="n">minpop</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_cities</span><span class="p">)</span>
        <span class="n">cities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cities</span>

    <span class="k">def</span> <span class="nf">draw_cities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">exact</span><span class="o">=</span><span class="k">None</span><span class="p">,</span>
                    <span class="n">include</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">nmax_soft</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">psxy_style</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="s">&#39;s5p&#39;</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)):</span>

        <span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities_in_region</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">exact</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
            <span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">exact</span><span class="p">]</span>
            <span class="n">minpop</span> <span class="o">=</span> <span class="k">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
            <span class="n">minpop</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
            <span class="k">for</span> <span class="n">minpop_new</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="n">e3</span><span class="p">,</span> <span class="mi">3</span><span class="n">e3</span><span class="p">,</span> <span class="mi">1</span><span class="n">e4</span><span class="p">,</span> <span class="mi">3</span><span class="n">e4</span><span class="p">,</span> <span class="mi">1</span><span class="n">e5</span><span class="p">,</span> <span class="mi">3</span><span class="n">e5</span><span class="p">,</span> <span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="mi">3</span><span class="n">e6</span><span class="p">,</span> <span class="mi">1</span><span class="n">e7</span><span class="p">]:</span>
                <span class="n">cities_new</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">population</span> <span class="o">&gt;</span> <span class="n">minpop_new</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">include</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities_new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">cities_new</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nmax_soft</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="n">cities</span> <span class="o">=</span> <span class="n">cities_new</span>
                <span class="n">minpop</span> <span class="o">=</span> <span class="n">minpop_new</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nmax_soft</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">cities</span><span class="p">:</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lat</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">]</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lon</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">),</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span><span class="p">,</span> <span class="o">**</span><span class="n">psxy_style</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;iso-8859-1&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">asciiname</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cities_minpop</span> <span class="o">=</span> <span class="n">minpop</span>

    <span class="k">def</span> <span class="nf">draw_plates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">tectonics</span>

        <span class="n">neast</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">nnorth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hreg</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_wreg</span> <span class="o">*</span> <span class="n">neast</span><span class="p">))))</span>
        <span class="n">norths</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_hreg</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hreg</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nnorth</span><span class="p">)</span>
        <span class="n">easts</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_wreg</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wreg</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">neast</span><span class="p">)</span>
        <span class="n">norths2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">norths</span><span class="p">,</span> <span class="n">neast</span><span class="p">)</span>
        <span class="n">easts2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">easts</span><span class="p">,</span> <span class="n">nnorth</span><span class="p">)</span>
        <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">norths2</span><span class="p">,</span> <span class="n">easts2</span><span class="p">)</span>

        <span class="n">bird</span> <span class="o">=</span> <span class="n">tectonics</span><span class="o">.</span><span class="n">PeterBird2003</span><span class="p">()</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">bird</span><span class="o">.</span><span class="n">get_plates</span><span class="p">()</span>

        <span class="n">color_plates</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="s">&#39;aluminium5&#39;</span><span class="p">)</span>
        <span class="n">color_velocities</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="s">&#39;skyblue1&#39;</span><span class="p">)</span>
        <span class="n">color_velocities_lab</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">darken</span><span class="p">(</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">color_tup</span><span class="p">(</span><span class="s">&#39;skyblue1&#39;</span><span class="p">)))</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">plate</span> <span class="ow">in</span> <span class="n">plates</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plate</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">used</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">candi_fixed</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">label_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">plate</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>

                <span class="n">mean_north</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">norths2</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">mean_east</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">easts2</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                <span class="n">iorder</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">norths2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean_north</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">easts2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean_east</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

                <span class="n">lat_candis</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">iorder</span><span class="p">]</span>
                <span class="n">lon_candis</span> <span class="o">=</span> <span class="n">lons</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="n">iorder</span><span class="p">]</span>

                <span class="n">candi_fixed</span><span class="p">[</span><span class="n">plate</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_candis</span><span class="o">.</span><span class="n">size</span>

                <span class="n">label_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">lat_candis</span><span class="p">,</span> <span class="n">lon_candis</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">color_plates</span><span class="p">))</span>

            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">bird</span><span class="o">.</span><span class="n">get_boundaries</span><span class="p">()</span>

            <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">psxy_kwargs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="n">boundaries</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points_in_region</span><span class="p">(</span><span class="n">boundary</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">boundary</span><span class="o">.</span><span class="n">split_types</span><span class="p">(</span>
                            <span class="p">[[</span><span class="s">&#39;SUB&#39;</span><span class="p">],</span>
                             <span class="p">[</span><span class="s">&#39;OSR&#39;</span><span class="p">,</span> <span class="s">&#39;OTF&#39;</span><span class="p">,</span> <span class="s">&#39;OCB&#39;</span><span class="p">,</span> <span class="s">&#39;CTF&#39;</span><span class="p">,</span> <span class="s">&#39;CCB&#39;</span><span class="p">,</span> <span class="s">&#39;CRB&#39;</span><span class="p">]]):</span>

                        <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">T</span>

                        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;SUB&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">boundary</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;f%g/%gp+t+r&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="mf">0.45</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="mf">3.</span><span class="o">*</span><span class="n">size</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">boundary</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;f%g/%gp+t+l&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="mf">0.45</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="mf">3.</span><span class="o">*</span><span class="n">size</span><span class="p">)</span>

                            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_plates</span>

                        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;in_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;W&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;%gp,%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">color_plates</span><span class="p">),</span>

                        <span class="n">psxy_kwargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">boundary</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">boundary</span><span class="o">.</span><span class="n">name2</span> <span class="ow">in</span> <span class="n">candi_fixed</span><span class="p">:</span>
                                <span class="n">candi_fixed</span><span class="p">[</span><span class="n">boundary</span><span class="o">.</span><span class="n">name2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">neast</span><span class="o">*</span><span class="n">nnorth</span>

                        <span class="k">elif</span> <span class="n">boundary</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">boundary</span><span class="o">.</span><span class="n">name1</span> <span class="ow">in</span> <span class="n">candi_fixed</span><span class="p">:</span>
                                <span class="n">candi_fixed</span><span class="p">[</span><span class="n">boundary</span><span class="o">.</span><span class="n">name1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">neast</span><span class="o">*</span><span class="n">nnorth</span>

            <span class="n">candi_fixed</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">candi_fixed</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="o">-</span><span class="n">candi_fixed</span><span class="p">[</span><span class="n">name</span><span class="p">])]</span>

            <span class="n">candi_fixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">None</span><span class="p">)</span>

            <span class="n">gsrm</span> <span class="o">=</span> <span class="n">tectonics</span><span class="o">.</span><span class="n">GSRM1</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">candi_fixed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gsrm</span><span class="o">.</span><span class="n">plate_names</span><span class="p">()</span> \
                        <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gsrm</span><span class="o">.</span><span class="n">plate_alt_names</span><span class="p">():</span>

                    <span class="k">continue</span>

                <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">vnorth</span><span class="p">,</span> <span class="n">veast</span><span class="p">,</span> <span class="n">vnorth_err</span><span class="p">,</span> <span class="n">veast_err</span><span class="p">,</span> <span class="n">corr</span> <span class="o">=</span> \
                    <span class="n">gsrm</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wesn</span><span class="p">)</span>

                <span class="n">fixed_plate_name</span> <span class="o">=</span> <span class="n">name</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psvelo</span><span class="p">(</span>
                    <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">veast</span><span class="p">,</span> <span class="n">vnorth</span><span class="p">,</span> <span class="n">veast_err</span><span class="p">,</span> <span class="n">vnorth_err</span><span class="p">,</span>
                        <span class="n">corr</span><span class="p">),</span>
                    <span class="n">W</span><span class="o">=</span><span class="s">&#39;0.25p,%s&#39;</span> <span class="o">%</span> <span class="n">color_velocities</span><span class="p">,</span>
                    <span class="n">A</span><span class="o">=</span><span class="s">&#39;9p+e+g%s&#39;</span> <span class="o">%</span> <span class="n">color_velocities</span><span class="p">,</span>
                    <span class="n">S</span><span class="o">=</span><span class="s">&#39;e0.2p/0.95/10&#39;</span><span class="p">,</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vnorth</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">veast</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span>
                        <span class="n">lats</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="s">&#39;%.0f&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="p">,</span>
                        <span class="n">font_size</span><span class="o">=</span><span class="mf">0.7</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">label_font_size</span><span class="p">(),</span>
                        <span class="n">style</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">G</span><span class="o">=</span><span class="n">color_velocities_lab</span><span class="p">))</span>

                <span class="k">break</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">lat_candis</span><span class="p">,</span> <span class="n">lon_candis</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="n">label_data</span><span class="p">:</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">bird</span><span class="o">.</span><span class="n">full_name</span><span class="p">(</span><span class="n">plate</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">fixed_plate_name</span><span class="p">:</span>
                    <span class="n">full_name</span> <span class="o">=</span> <span class="s">&#39;@_&#39;</span> <span class="o">+</span> <span class="n">full_name</span> <span class="o">+</span> <span class="s">&#39;@_&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_area_label</span><span class="p">(</span>
                    <span class="n">lat_candis</span><span class="p">,</span> <span class="n">lon_candis</span><span class="p">,</span>
                    <span class="n">full_name</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">font</span><span class="o">=</span><span class="s">&#39;3&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">psxy_kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">jxyr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">rand</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">):</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
    <span class="n">ma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">ma</span><span class="o">-</span><span class="n">mi</span><span class="p">)</span> <span class="o">+</span> <span class="n">mi</span>


<span class="k">def</span> <span class="nf">split_region</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
    <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">topo</span><span class="o">.</span><span class="n">positive_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">east</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">west</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">),</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="n">east</span><span class="o">-</span><span class="mf">360.</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">region</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">CPTLevel</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">()</span>
    <span class="n">color_min</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>
    <span class="n">color_max</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">CPT</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">color_below</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">color_above</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">color_nan</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">CPTLevel</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">):</span>
        <span class="n">vmin_old</span><span class="p">,</span> <span class="n">vmax_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vmax</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">-</span> <span class="n">vmin_old</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vmax_old</span> <span class="o">-</span> <span class="n">vmin_old</span><span class="p">)</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">vmin</span>
            <span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin_old</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vmax_old</span> <span class="o">-</span> <span class="n">vmin_old</span><span class="p">)</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">vmin</span>


<span class="k">class</span> <span class="nc">CPTParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">read_cpt</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">color_below</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">color_above</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">color_nan</span> <span class="o">=</span> <span class="k">None</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">):</span>
                    <span class="n">color_below</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">):</span>
                    <span class="n">color_above</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">):</span>
                    <span class="n">color_nan</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">color_min</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">color_max</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
                    <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CPTLevel</span><span class="p">(</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                        <span class="n">color_min</span><span class="o">=</span><span class="n">color_min</span><span class="p">,</span>
                        <span class="n">color_max</span><span class="o">=</span><span class="n">color_max</span><span class="p">))</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CPTParseError</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">CPT</span><span class="p">(</span>
        <span class="n">color_below</span><span class="o">=</span><span class="n">color_below</span><span class="p">,</span>
        <span class="n">color_above</span><span class="o">=</span><span class="n">color_above</span><span class="p">,</span>
        <span class="n">color_nan</span><span class="o">=</span><span class="n">color_nan</span><span class="p">,</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">color_to_int</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">color</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_cpt</span><span class="p">(</span><span class="n">cpt</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">cpt</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s">&#39;%e %i %i %i %e %i %i %i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">((</span><span class="n">level</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">color_to_int</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">color_min</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">vmax</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="n">color_to_int</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">color_max</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">cpt</span><span class="o">.</span><span class="n">color_below</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;B %i %i %i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">color_to_int</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">color_below</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cpt</span><span class="o">.</span><span class="n">color_above</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;F %i %i %i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">color_to_int</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">color_above</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cpt</span><span class="o">.</span><span class="n">color_nan</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;N %i %i %i</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">color_to_int</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">color_nan</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">cpt_merge_wet_dry</span><span class="p">(</span><span class="n">wet</span><span class="p">,</span> <span class="n">dry</span><span class="p">):</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">wet</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">dry</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">vmax</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">level</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">combi</span> <span class="o">=</span> <span class="n">CPT</span><span class="p">(</span>
        <span class="n">color_below</span><span class="o">=</span><span class="n">wet</span><span class="o">.</span><span class="n">color_below</span><span class="p">,</span>
        <span class="n">color_above</span><span class="o">=</span><span class="n">dry</span><span class="o">.</span><span class="n">color_above</span><span class="p">,</span>
        <span class="n">color_nan</span><span class="o">=</span><span class="n">dry</span><span class="o">.</span><span class="n">color_nan</span><span class="p">,</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">combi</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">util</span>
    <span class="n">util</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="s">&#39;pyrocko.automap&#39;</span><span class="p">,</span> <span class="s">&#39;info&#39;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">rand</span><span class="p">(</span><span class="o">-</span><span class="mf">60.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">),</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">rand</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">),</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">500</span><span class="o">*</span><span class="n">km</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3000</span><span class="o">*</span><span class="n">km</span><span class="p">))),</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span>
            <span class="n">show_grid</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">show_topo</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">color_dry</span><span class="o">=</span><span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">230</span><span class="p">),</span>
            <span class="n">topo_cpt_wet</span><span class="o">=</span><span class="s">&#39;light_sea_uniform&#39;</span><span class="p">,</span>
            <span class="n">topo_cpt_dry</span><span class="o">=</span><span class="s">&#39;light_land_uniform&#39;</span><span class="p">,</span>
            <span class="n">illuminate</span><span class="o">=</span><span class="k">True</span><span class="p">,</span>
            <span class="n">illuminate_factor_ocean</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
            <span class="n">show_rivers</span><span class="o">=</span><span class="k">False</span><span class="p">,</span>
            <span class="n">show_plates</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">draw_cities</span><span class="p">()</span>
        <span class="nb">print</span> <span class="n">m</span>
        <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;map_%02i.pdf&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Pyrocko Developers.
    </div>
  </body>
</html>